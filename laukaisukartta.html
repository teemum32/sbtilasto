<!DOCTYPE html>
<html lang="fi" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>Floorball Shotmap</title>

  <!-- TÄRKEÄ: sallitaan tailwindin CDN -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://www.gstatic.com https://www.googleapis.com;
                 connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com;
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data: blob:;
                 frame-src 'self' https:;">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background:#0f172a; }
    .player-number {
      cursor: grab;
      width: 50px; height: 50px; border-radius: 9999px;
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:1.1rem;
      border:2px solid white; background:#020617; color:white;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .away-player { font-size:1.5rem; }
    .dragging { position:absolute; pointer-events:none; opacity:.7; z-index:1000; }
    .shot-marker {
      position:absolute;
      width:36px; height:36px;
      border-radius:9999px;
      font-weight:700; font-size:.85rem;
      transform:translate(-50%, -50%);
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 1px 3px rgba(0,0,0,.4);
      color:#fff; cursor:pointer;
    }
    .shot-marker.goal { background:#10B981; border:2px solid rgba(15,118,110,.4); }
    .shot-marker.miss { background:#3B82F6; border:2px solid rgba(37,99,235,.45); }
    .shot-marker.block { background:#FACC15; border:2px solid rgba(202,138,4,.5); color:#000; }
    .shot-marker.save { background:#EF4444; border:2px solid rgba(220,38,38,.5); }

    .action-modal { position:absolute; transform:translate(-50%,-50%); z-index:50; display:flex; flex-direction:column; }
    .period-tab { padding:8px 16px; border-radius:6px; font-weight:600; }
    .period-tab.active { background:#4f46e5; }
    details>summary { cursor:pointer; list-style:none; }
    details>summary::-webkit-details-marker { display:none; }
    /* possession bar */
    #possession-bar { height:26px; border-radius:9999px; overflow:hidden; border:1px solid rgba(15,23,42,.25); }
    #possession-home, #possession-away { height:100%; display:flex; align-items:center; font-size:.7rem; font-weight:600; }
  </style>
</head>
<body class="h-full text-slate-200">

<!-- 1. KIRJAUTUMINEN FIREBASELLA -->
<div id="login-view" class="h-full w-full flex items-center justify-center p-4">
  <div class="bg-slate-900 w-full max-w-sm p-8 rounded-xl shadow-2xl">
    <h1 class="text-2xl font-bold mb-6 text-center">Floorball Shotmap</h1>
    <label class="block text-sm mb-1 text-slate-300">sähköposti</label>
    <input id="login-email" type="email" class="w-full mb-4 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" placeholder="data@topteamsalibandy.net" />
    <label class="block text-sm mb-1 text-slate-300">salasana</label>
    <input id="login-password" type="password" class="w-full mb-4 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700" placeholder="••••••••" />
    <p id="login-error" class="text-red-400 text-sm h-5 mb-3"></p>
    <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 py-2 rounded-lg font-semibold">Kirjaudu</button>
  </div>
</div>

<!-- 2. JOUKKUEEN VALINTA -->
<div id="team-view" class="hidden h-full w-full flex items-center justify-center p-4">
  <div class="bg-slate-900 w-full max-w-sm p-8 rounded-xl shadow-2xl">
    <h2 class="text-2xl font-bold mb-5 text-center">Valitse tai luo joukkue</h2>
    <div id="team-list" class="space-y-3 mb-5">
      <!-- tähän listataan Firebasesta löytyvät roster-dokumentit -->
    </div>
    <input id="new-team-name" type="text" class="w-full px-3 py-2 mb-3 rounded-lg bg-slate-800 border border-slate-700" placeholder="Uuden joukkueen nimi" />
    <button id="create-team" class="w-full bg-emerald-600 hover:bg-emerald-700 py-2 rounded-lg font-semibold mb-3">Luo uusi joukkue</button>
    <button id="team-logout" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg font-semibold">Kirjaudu ulos</button>
    <p id="team-error" class="text-red-400 text-sm h-5 mt-3"></p>
  </div>
</div>

<!-- 3. ETUSIVU JOKA NÄHDÄÄN KIRJAUDUTTUA -->
<div id="landing-view" class="hidden h-full w-full flex items-center justify-center p-4">
  <div class="bg-slate-900 w-full max-w-sm p-8 rounded-xl shadow-2xl text-center space-y-4">
    <h2 class="text-2xl font-bold">Floorball Shotmap</h2>
    <p id="current-team-label" class="text-slate-400 text-sm">–</p>
    <button id="start-new-game-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded-lg font-semibold">Aloita uusi ottelu</button>
    <button id="view-season-data-btn" class="w-full bg-slate-700 hover:bg-slate-600 py-3 rounded-lg font-semibold">Tarkastele kausidataa</button>
    <button id="change-team-btn" class="w-full bg-slate-800 hover:bg-slate-700 py-3 rounded-lg font-semibold">Vaihda joukkuetta</button>
    <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 py-3 rounded-lg font-semibold">Kirjaudu ulos</button>
  </div>
</div>

<!-- 4. VARSINAINEN SOVELLUS (tämä on käytännössä se pitkä koodi jonka olit rakentanut) -->
<div id="app-container" class="hidden h-full w-full flex flex-col">
  <!-- ylävalikko -->
  <div id="period-tabs" class="bg-slate-800 p-2 flex justify-center gap-1 md:gap-2 shrink-0 flex-wrap">
    <button data-period="1" class="period-tab active">Erä 1</button>
    <button data-period="2" class="period-tab">Erä 2</button>
    <button data-period="3" class="period-tab">Erä 3</button>
    <button data-period="summary" class="period-tab">Ottelu</button>
    <button data-period="plus-minus" class="period-tab">+/-</button>
    <button data-period="season" class="period-tab">Kausi</button>
  </div>

  <!-- pallonhallinta kaikissa näkymissä -->
  <div class="px-4 py-2 bg-slate-900">
    <div id="possession-bar" class="w-full bg-slate-200 relative">
      <div id="possession-home" class="bg-emerald-500 text-slate-50 px-3">Koti 0%</div>
      <div id="possession-away" class="bg-slate-200 text-slate-900 px-3 justify-end" style="position:absolute; right:0; top:0;">
        Vieras 0%
      </div>
    </div>
  </div>

  <div class="flex-1 min-h-0 relative">
    <!-- varsinainen kenttä + sivupaneeli -->
    <div id="main-app" class="absolute inset-0 flex flex-col md:flex-row">
      <!-- vasen paneeli -->
      <div class="w-full md:w-64 bg-slate-900 p-4 shrink-0 overflow-y-auto order-last md:order-first">
        <h2 class="text-xl font-bold mb-4 text-center" id="side-home-title">Koti</h2>
        <div id="home-player-list" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-3 gap-4 mb-6"></div>
        <h2 class="text-xl font-bold mb-4 text-center">Vieras</h2>
        <div id="away-player-list" class="flex justify-center mb-6"></div>

        <div id="stats-container" class="border-t border-slate-700 pt-4"></div>
        <div id="player-stats-container" class="hidden border-t border-slate-700 pt-4 mt-4"></div>

        <button id="save-game-button" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-lg">Tallenna</button>
      </div>

      <!-- kenttä -->
      <main class="flex-1 flex flex-col items-center justify-center gap-4 p-4 bg-slate-200 min-w-0 order-first md:order-last">
        <div class="flex-1 flex items-center justify-center w-full">
          <div class="text-slate-500 font-bold text-lg -rotate-90 mr-4 hidden md:block">Vieras</div>
          <div id="field-container" class="relative max-w-full max-h-full aspect-[2/1] bg-white rounded-lg shadow-2xl border-2 border-slate-800">
            <svg class="w-full h-full" viewBox="0 0 400 200">
              <line x1="200" y1="0" x2="200" y2="200" stroke="#94a3b8" stroke-width="2"></line>
              <rect x="30" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"></rect>
              <line x1="40" y1="90" x2="40" y2="110" stroke="#94a3b8" stroke-width="2"></line>
              <rect x="330" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"></rect>
              <line x1="360" y1="90" x2="360" y2="110" stroke="#94a3b8" stroke-width="2"></line>
            </svg>
            <div id="shots-layer" class="absolute inset-0"></div>
          </div>
          <div class="text-slate-500 font-bold text-lg rotate-90 ml-4 hidden md:block">Koti</div>
        </div>

        <!-- pallonhallintapainikkeet, vain erissä -->
        <div id="possession-controls" class="flex gap-4 mt-2">
          <button id="home-pos-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Koti hallussa</button>
          <button id="away-pos-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg">Vieras hallussa</button>
          <button id="stop-pos-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-lg">Pysäytä</button>
          <span id="possession-timer" class="text-slate-700 font-mono self-center">0:00</span>
        </div>
      </main>
    </div>

    <!-- +/- näkymä -->
    <div id="plus-minus-view" class="absolute inset-0 hidden bg-slate-200 overflow-y-auto p-4"></div>

    <!-- kausi -->
    <div id="season-view" class="absolute inset-0 hidden bg-slate-200 overflow-y-auto p-4"></div>
  </div>
</div>

<!-- MODAALIT -->
<div id="outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border">
  <button data-outcome="goal" class="outcome-btn w-28 text-white font-semibold py-2 rounded-md bg-emerald-500 hover:bg-emerald-600">Maali</button>
  <button data-outcome="miss" class="outcome-btn w-28 text-white font-semibold py-2 rounded-md bg-blue-500 hover:bg-blue-600">Ohi</button>
  <button data-outcome="block" class="outcome-btn w-28 text-slate-800 font-semibold py-2 rounded-md bg-yellow-400 hover:bg-yellow-500">Blokki</button>
  <button data-outcome="save" class="outcome-btn w-28 text-white font-semibold py-2 rounded-md bg-red-500 hover:bg-red-600">Torjunta</button>
</div>
<div id="edit-outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border">
  <button data-outcome="goal" class="edit-outcome-btn w-32 text-white font-semibold py-2 rounded-md bg-emerald-500 hover:bg-emerald-600">Maali</button>
  <button data-outcome="miss" class="edit-outcome-btn w-32 text-white font-semibold py-2 rounded-md bg-blue-500 hover:bg-blue-600">Ohi</button>
  <button data-outcome="block" class="edit-outcome-btn w-32 text-slate-800 font-semibold py-2 rounded-md bg-yellow-400 hover:bg-yellow-500">Blokki</button>
  <button data-outcome="save" class="edit-outcome-btn w-32 text-white font-semibold py-2 rounded-md bg-red-500 hover:bg-red-600">Torjunta</button>
  <div class="border-t my-1"></div>
  <button id="delete-shot-btn" class="w-32 text-white font-semibold py-2 rounded-md bg-slate-600 hover:bg-slate-700">Poista</button>
</div>

<!-- vahvistus -->
<div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm text-center">
    <h3 id="confirm-title" class="text-xl font-bold text-slate-800 mb-4"></h3>
    <p id="confirm-text" class="text-slate-600 mb-6"></p>
    <div class="flex justify-center gap-4">
      <button id="cancel-confirm-btn" class="px-6 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 font-semibold">Peruuta</button>
      <button id="confirm-btn" class="px-6 py-2 rounded-lg text-white font-semibold bg-red-600">OK</button>
    </div>
  </div>
</div>

<!-- PDF-virhemodaali -->
<div id="pdf-error-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
  <div class="bg-white text-slate-800 rounded-lg shadow-lg p-6 max-w-md">
    <h3 class="text-lg font-bold mb-2">PDF-raportti</h3>
    <p id="pdf-error-text" class="text-sm"></p>
    <div class="mt-4 text-right">
      <button id="pdf-error-close" class="px-4 py-2 rounded bg-indigo-600 text-white">Sulje</button>
    </div>
  </div>
</div>

<script type="module">
  /* ===================== FIREBASE ========================= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, deleteDoc, onSnapshot, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDdqRwtwIat2t_qKYE9H3jmbVM1_EIvKy0",
    authDomain: "sbtilastot.firebaseapp.com",
    projectId: "sbtilastot",
    storageBucket: "sbtilastot.appspot.com",
    messagingSenderId: "1056099775207",
    appId: "1:1056099775207:web:6dc886fb56b71f708fe842"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // view refs
  const loginView   = document.getElementById('login-view');
  const teamView    = document.getElementById('team-view');
  const landingView = document.getElementById('landing-view');
  const appContainer= document.getElementById('app-container');

  const loginEmail  = document.getElementById('login-email');
  const loginPass   = document.getElementById('login-password');
  const loginBtn    = document.getElementById('login-btn');
  const loginError  = document.getElementById('login-error');

  const teamList    = document.getElementById('team-list');
  const newTeamName = document.getElementById('new-team-name');
  const createTeam  = document.getElementById('create-team');
  const teamError   = document.getElementById('team-error');
  const teamLogout  = document.getElementById('team-logout');

  const startNewGameBtn = document.getElementById('start-new-game-btn');
  const viewSeasonDataBtn = document.getElementById('view-season-data-btn');
  const changeTeamBtn = document.getElementById('change-team-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const currentTeamLabel = document.getElementById('current-team-label');

  // app refs (lyhyesti, suurin osa alla)
  const homePlayerList = document.getElementById('home-player-list');
  const awayPlayerList = document.getElementById('away-player-list');
  const shotsLayer     = document.getElementById('shots-layer');
  const fieldContainer = document.getElementById('field-container');
  const outcomeModal   = document.getElementById('outcome-modal');
  const editOutcomeModal = document.getElementById('edit-outcome-modal');
  const periodTabs     = document.getElementById('period-tabs');
  const mainAppView    = document.getElementById('main-app');
  const plusMinusView  = document.getElementById('plus-minus-view');
  const seasonView     = document.getElementById('season-view');
  const statsContainer = document.getElementById('stats-container');
  const playerStatsContainer = document.getElementById('player-stats-container');
  const confirmModal   = document.getElementById('confirm-modal');
  const pdfErrorModal  = document.getElementById('pdf-error-modal');
  const pdfErrorText   = document.getElementById('pdf-error-text');
  const pdfErrorClose  = document.getElementById('pdf-error-close');

  const possessionBar  = document.getElementById('possession-bar');
  const possessionHomeEl = document.getElementById('possession-home');
  const possessionAwayEl = document.getElementById('possession-away');
  const homePosBtn     = document.getElementById('home-pos-btn');
  const awayPosBtn     = document.getElementById('away-pos-btn');
  const stopPosBtn     = document.getElementById('stop-pos-btn');
  const possessionTimerEl = document.getElementById('possession-timer');

  /* APP STATE */
  let currentUser = null;
  let currentTeamId = null;
  let rosterData = {};
  let currentGame = null;
  let draggedElement = null, ghostElement = null, tempShotData = {}, shotToEditId = null;
  let seasonData = { games: [] };
  let gamesUnsubscribe = () => {};
  let possTimer = null;
  let possStart = null;
  let possHome = 0, possAway = 0;
  let possCurrent = null; // 'home' | 'away' | null

  function show(view) {
    loginView.classList.add('hidden');
    teamView.classList.add('hidden');
    landingView.classList.add('hidden');
    appContainer.classList.add('hidden');
    view.classList.remove('hidden');
  }

  // login
  loginBtn.addEventListener('click', async () => {
    loginError.textContent = '';
    const mail = loginEmail.value.trim();
    const pass = loginPass.value.trim();
    if (!mail || !pass) {
      loginError.textContent = 'Syötä tunnus ja salasana.';
      return;
    }
    loginBtn.disabled = true; loginBtn.textContent = 'Kirjaudutaan...';
    try {
      await signInWithEmailAndPassword(auth, mail, pass);
    } catch (err) {
      console.error(err);
      loginError.textContent = 'Kirjautuminen epäonnistui: ' + (err?.code || '');
      loginBtn.disabled = false; loginBtn.textContent = 'Kirjaudu';
    }
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      currentUser = null; currentTeamId = null;
      show(loginView);
      return;
    }
    currentUser = user;
    // onko localstoragessa valittua joukkuetta?
    const savedTeam = localStorage.getItem('fs-current-team');
    if (savedTeam) {
      currentTeamId = savedTeam;
      currentTeamLabel.textContent = savedTeam;
      listenForGames();
      show(landingView);
    } else {
      await loadTeams();
      show(teamView);
    }
  });

  async function loadTeams() {
    teamList.innerHTML = '';
    if (!currentUser) return;
    try {
      const colRef = collection(db, 'artifacts', 'default-app-id', 'users', currentUser.uid, 'roster');
      const snap = await getDocs(colRef);
      if (snap.empty) {
        const p = document.createElement('p');
        p.textContent = 'Ei joukkueita vielä.';
        p.className = 'text-slate-400 text-sm';
        teamList.appendChild(p);
      } else {
        snap.forEach(d => {
          const btn = document.createElement('button');
          btn.textContent = d.id;
          btn.className = 'w-full bg-slate-700 hover:bg-slate-600 py-2 rounded-lg font-semibold';
          btn.addEventListener('click', async () => {
            currentTeamId = d.id;
            localStorage.setItem('fs-current-team', d.id);
            currentTeamLabel.textContent = d.id;
            await loadRosterFromFirestore(); // otetaan roster
            listenForGames();
            show(landingView);
          });
          teamList.appendChild(btn);
        });
      }
    } catch (err) {
      console.error(err);
      teamError.textContent = 'Joukkueiden haku epäonnistui';
    }
  }

  createTeam.addEventListener('click', async () => {
    if (!currentUser) return;
    const name = newTeamName.value.trim();
    if (!name) { teamError.textContent = 'Anna nimi.'; return; }
    try {
      const docRef = doc(db, 'artifacts', 'default-app-id', 'users', currentUser.uid, 'roster', name);
      await setDoc(docRef, { players: {}, createdAt: new Date().toISOString() });
      newTeamName.value = '';
      await loadTeams();
    } catch (err) {
      console.error(err);
      teamError.textContent = 'Joukkueen luonti epäonnistui';
    }
  });

  teamLogout.addEventListener('click', async () => { await signOut(auth); });

  logoutBtn.addEventListener('click', async () => { await signOut(auth); });
  changeTeamBtn.addEventListener('click', async () => {
    await loadTeams();
    show(teamView);
  });

  startNewGameBtn.addEventListener('click', () => {
    if (!currentTeamId) { loadTeams(); show(teamView); return; }
    startNewGame(rosterData, 'Vastustaja');
    show(appContainer);
  });
  viewSeasonDataBtn.addEventListener('click', () => {
    show(appContainer);
    showView('season');
  });

  /* ================== SOVELLUKSEN OSA, SAMOIN KUIN SULLA OLI =================== */

  function startNewGame(roster, opponentName) {
    shotsLayer.innerHTML = '';
    const players = Object.keys(roster).map(Number).sort((a,b)=>a-b);
    currentGame = {
      id: Date.now(),
      opponent: opponentName,
      players,
      roster,
      shots: [],
      plusMinus: {},
      currentPeriod: 1,
      possession: {
        1: { home:0, away:0 },
        2: { home:0, away:0 },
        3: { home:0, away:0 },
        summary: { home:0, away:0 }
      }
    };
    players.forEach(p => currentGame.plusMinus[p] = { plus:0, minus:0 });
    initializePlayers();
    initializePlusMinusView();
    addEventListeners();
    renderPossessionBar();
    showView(1);
  }

  async function loadRosterFromFirestore() {
    if (!currentUser || !currentTeamId) return;
    try {
      const docSnap = await getDoc(doc(db, 'artifacts', 'default-app-id', 'users', currentUser.uid, 'roster', currentTeamId));
      rosterData = docSnap.exists() ? (docSnap.data().players || {}) : {};
    } catch (err) {
      console.error('roster-lataus', err);
    }
  }

  function initializePlayers() {
    homePlayerList.innerHTML = '';
    currentGame.players.forEach(number => {
      const player = document.createElement('div');
      player.className = 'player-number';
      player.textContent = number;
      homePlayerList.appendChild(player);
    });
    awayPlayerList.innerHTML = '';
    const away = document.createElement('div');
    away.className = 'player-number away-player';
    away.textContent = 'V';
    awayPlayerList.appendChild(away);
  }

  function addEventListeners() {
    [homePlayerList, awayPlayerList].forEach(bar => {
      bar.addEventListener('mousedown', onDragStart);
      bar.addEventListener('touchstart', onDragStart, { passive:false });
    });
    document.body.addEventListener('mousemove', onDragMove);
    document.body.addEventListener('touchmove', onDragMove, { passive:false });
    document.body.addEventListener('mouseup', onDragEnd);
    document.body.addEventListener('touchend', onDragEnd);

    outcomeModal.addEventListener('click', onOutcomeSelect);
    editOutcomeModal.addEventListener('click', onEditOutcomeSelect);
    shotsLayer.addEventListener('click', onShotMarkerClick);
    periodTabs.addEventListener('click', onPeriodChange);
    fieldContainer.addEventListener('contextmenu', e => e.preventDefault());

    homePosBtn.addEventListener('click', () => startPossession('home'));
    awayPosBtn.addEventListener('click', () => startPossession('away'));
    stopPosBtn.addEventListener('click', stopPossession);

    pdfErrorClose.addEventListener('click', () => pdfErrorModal.classList.add('hidden'));
  }

  function onDragStart(e) {
    const t = e.target.closest('.player-number');
    if (!t || !currentGame) return;
    draggedElement = t;
    ghostElement = t.cloneNode(true);
    ghostElement.classList.add('dragging');
    document.body.appendChild(ghostElement);
    const touch = e.touches ? e.touches[0] : e;
    updateGhostPosition(touch.pageX, touch.pageY);
  }
  function onDragMove(e) {
    if (!ghostElement) return;
    e.preventDefault();
    const touch = e.touches ? e.touches[0] : e;
    updateGhostPosition(touch.pageX, touch.pageY);
  }
  function onDragEnd(e) {
    if (!draggedElement || !ghostElement) return;
    const touch = e.changedTouches ? e.changedTouches[0] : e;
    const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
    if (fieldContainer.contains(dropTarget)) {
      const rect = shotsLayer.getBoundingClientRect();
      const x = ((touch.clientX - rect.left) / rect.width) * 100;
      const y = ((touch.clientY - rect.top) / rect.height) * 100;
      tempShotData = {
        player: draggedElement.textContent,
        team: draggedElement.classList.contains('away-player') ? 'away':'home',
        x, y
      };
      showOutcomeModal(touch.clientX, touch.clientY);
    }
    document.body.removeChild(ghostElement);
    ghostElement = null; draggedElement = null;
  }
  function updateGhostPosition(x,y) {
    if (ghostElement) {
      ghostElement.style.left = (x-25)+'px';
      ghostElement.style.top  = (y-25)+'px';
    }
  }

  function showOutcomeModal(x,y) {
    editOutcomeModal.classList.add('hidden');
    outcomeModal.style.left = x+'px';
    outcomeModal.style.top  = y+'px';
    outcomeModal.classList.remove('hidden');
  }
  function hideOutcomeModal() {
    outcomeModal.classList.add('hidden');
    tempShotData = {};
  }
  function showEditOutcomeModal(x,y) {
    outcomeModal.classList.add('hidden');
    editOutcomeModal.style.left = x+'px';
    editOutcomeModal.style.top  = y+'px';
    editOutcomeModal.classList.remove('hidden');
  }
  function hideEditOutcomeModal() {
    editOutcomeModal.classList.add('hidden');
    shotToEditId = null;
  }

  function onOutcomeSelect(e) {
    const btn = e.target.closest('.outcome-btn');
    if (!btn) return;
    const outcome = btn.dataset.outcome;
    const newShot = {
      id: Date.now()+Math.random(),
      ...tempShotData,
      outcome,
      period: currentGame.currentPeriod,
      xG: calculateXg(tempShotData.x, tempShotData.y, tempShotData.team)
    };
    currentGame.shots.push(newShot);
    hideOutcomeModal();
    renderShots();
    updateStats();
  }

  function onShotMarkerClick(e) {
    const t = e.target.closest('.shot-marker');
    if (!t) { hideEditOutcomeModal(); return; }
    shotToEditId = Number(t.dataset.shotId);
    showEditOutcomeModal(e.clientX, e.clientY);
  }
  function onEditOutcomeSelect(e) {
    const t = e.target;
    if (!shotToEditId) return;
    const shotIndex = currentGame.shots.findIndex(s=>s.id===shotToEditId);
    if (shotIndex === -1) return;
    if (t.id === 'delete-shot-btn') {
      currentGame.shots.splice(shotIndex,1);
    } else if (t.closest('.edit-outcome-btn')) {
      currentGame.shots[shotIndex].outcome = t.dataset.outcome;
    }
    hideEditOutcomeModal();
    renderShots();
    updateStats();
  }

  function renderShots() {
    shotsLayer.innerHTML = '';
    currentGame.shots
      .filter(s => currentGame.currentPeriod==='summary' || s.period===currentGame.currentPeriod)
      .forEach(s => {
        const el = document.createElement('div');
        el.className = `shot-marker ${s.outcome}`;
        el.dataset.shotId = s.id;
        el.style.left = s.x + '%';
        el.style.top  = s.y + '%';
        el.textContent = s.player;
        shotsLayer.appendChild(el);
      });
  }

  // fysiikka/malli xG
  function calculateXg(xPercent, yPercent, team) {
    const fieldLen = 40;
    const yM = (yPercent/100)*20 - 10; // -10...+10
    let xM;
    if (team === 'home') {
      xM = fieldLen/2 - (xPercent/100)*fieldLen;
    } else {
      xM = (xPercent/100)*fieldLen - fieldLen/2;
    }
    const dist = Math.sqrt(xM*xM + yM*yM);
    const maxX = fieldLen/2;
    const distN = Math.min(dist, maxX) / maxX;
    const angle = Math.atan2(Math.abs(yM), Math.abs(xM)+0.0001);
    const angFactor = Math.cos(angle);
    const base = 0.65;
    const xg = base * (1 - distN*0.8) * (0.4 + 0.6*angFactor);
    return Number(Math.max(0.01, Math.min(xg,0.85)).toFixed(2));
  }

  function onPeriodChange(e) {
    const t = e.target.closest('.period-tab');
    if (!t) return;
    const id = t.dataset.period;
    showView(id);
  }

  function showView(viewId) {
    document.querySelectorAll('.period-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector(`.period-tab[data-period="${viewId}"]`)?.classList.add('active');
    mainAppView.classList.add('hidden');
    plusMinusView.classList.add('hidden');
    seasonView.classList.add('hidden');
    // hallintapainikkeet vain erissä
    if (['1','2','3'].includes(String(viewId))) {
      document.getElementById('possession-controls').classList.remove('hidden');
    } else {
      document.getElementById('possession-controls').classList.add('hidden');
    }

    if (viewId === 'plus-minus') {
      renderPlusMinusView();
      plusMinusView.classList.remove('hidden');
    } else if (viewId === 'season') {
      renderSeasonStats();
      seasonView.classList.remove('hidden');
    } else {
      mainAppView.classList.remove('hidden');
      currentGame.currentPeriod = isNaN(viewId) ? viewId : parseInt(viewId);
      renderShots();
      updateStats();
      renderPossessionBar();
    }
  }

  function updateStats() {
    if (!currentGame) return;
    let stats = {
      home: { goals:0, shots:0, xg:0, saves:0, blocks:0, qualityHigh:0, qualityLow:0 },
      away: { goals:0, shots:0, xg:0, saves:0, blocks:0, qualityHigh:0, qualityLow:0 }
    };
    currentGame.shots
      .filter(s => currentGame.currentPeriod==='summary' || s.period===currentGame.currentPeriod)
      .forEach(shot => {
        const shooter = stats[shot.team];
        const opp = stats[shot.team === 'home' ? 'away':'home'];
        shooter.shots++;
        shooter.xg += shot.xG;
        if (shot.outcome === 'goal') shooter.goals++;
        if (shot.outcome === 'save') opp.saves++;
        if (shot.outcome === 'block') opp.blocks++;
        if (shot.xG >= 0.35) shooter.qualityHigh++; else shooter.qualityLow++;
      });

    statsContainer.innerHTML = `
      <h3 class="text-lg font-bold text-center mb-3">
        ${currentGame.currentPeriod==='summary' ? 'Koko ottelu' : `Erä ${currentGame.currentPeriod}`}
      </h3>
      <div class="space-y-4 text-sm">
        <div>
          <div class="flex justify-between font-semibold"><span>Koti</span></div>
          <div class="flex justify-between mt-1">
            <span>Maalit: ${stats.home.goals}</span>
            <span>Laukaukset: ${stats.home.shots}</span>
          </div>
          <div class="flex justify-between mt-1">
            <span>xG: ${stats.home.xg.toFixed(2)}</span>
            <span>L+: ${stats.home.qualityHigh} / H-: ${stats.home.qualityLow}</span>
          </div>
          <div class="flex justify-between mt-1 border-t border-slate-700 pt-1">
            <span>Torjunnat: ${stats.home.saves}</span>
            <span>Blokit: ${stats.home.blocks}</span>
          </div>
        </div>
        <div>
          <div class="flex justify-between font-semibold"><span>Vieras</span></div>
          <div class="flex justify-between mt-1">
            <span>Maalit: ${stats.away.goals}</span>
            <span>Laukaukset: ${stats.away.shots}</span>
          </div>
          <div class="flex justify-between mt-1">
            <span>xG: ${stats.away.xg.toFixed(2)}</span>
            <span>L+: ${stats.away.qualityHigh} / H-: ${stats.away.qualityLow}</span>
          </div>
          <div class="flex justify-between mt-1 border-t border-slate-700 pt-1">
            <span>Torjunnat: ${stats.away.saves}</span>
            <span>Blokit: ${stats.away.blocks}</span>
          </div>
        </div>
      </div>
    `;
  }

  // possession
  function startPossession(side) {
    if (!currentGame) return;
    stopPossession();
    possCurrent = side;
    possStart = Date.now();
    possTimer = setInterval(updatePossessionTimer, 1000);
  }
  function stopPossession() {
    if (!currentGame) return;
    if (possTimer) clearInterval(possTimer);
    if (possCurrent && possStart) {
      const delta = Math.floor((Date.now() - possStart)/1000);
      const p = currentGame.currentPeriod;
      currentGame.possession[p][possCurrent] += delta;
      currentGame.possession.summary[possCurrent] += delta;
    }
    possTimer = null; possCurrent = null; possStart = null;
    possessionTimerEl.textContent = '0:00';
    renderPossessionBar();
  }
  function updatePossessionTimer() {
    if (!possCurrent || !possStart) return;
    const sec = Math.floor((Date.now() - possStart)/1000);
    const m = Math.floor(sec/60);
    const s = sec%60;
    possessionTimerEl.textContent = `${m}:${s.toString().padStart(2,'0')}`;
    renderPossessionBar(true, sec); // live
  }
  function renderPossessionBar(live=false, extra=0) {
    if (!currentGame) return;
    const p = currentGame.currentPeriod;
    const baseHome = currentGame.possession[p].home;
    const baseAway = currentGame.possession[p].away;
    let h = baseHome, a = baseAway;
    if (live && possCurrent) {
      if (possCurrent==='home') h += extra;
      else a += extra;
    }
    const total = Math.max(1, h+a);
    const homePct = Math.round((h/total)*100);
    const awayPct = 100 - homePct;
    possessionHomeEl.style.width = homePct + '%';
    possessionHomeEl.textContent = `Koti ${homePct}%`;
    possessionAwayEl.textContent = `Vieras ${awayPct}%`;
  }

  // kausi
  function listenForGames() {
    if (!currentUser || !currentTeamId) return;
    gamesUnsubscribe();
    const q = query(collection(db, 'artifacts', 'default-app-id', 'users', currentUser.uid, 'games'));
    gamesUnsubscribe = onSnapshot(q, (snap) => {
      seasonData.games = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      if (!seasonView.classList.contains('hidden')) renderSeasonStats();
    });
  }

  function renderSeasonStats() {
    const fullRoster = {};
    const seasonPlayerStats = {};
    seasonData.games.forEach(g => Object.assign(fullRoster, g.roster));
    [...new Set(seasonData.games.flatMap(g => g.players))].sort((a,b)=>a-b)
      .forEach(p => seasonPlayerStats[p] = { games:0, shots:0, goals:0, plus:0, minus:0 });

    seasonData.games.forEach(game => {
      game.players.forEach(pNum => { if (seasonPlayerStats[pNum]) seasonPlayerStats[pNum].games++; });
      game.shots.forEach(shot => {
        if (shot.team==='home' && seasonPlayerStats[shot.player]) {
          seasonPlayerStats[shot.player].shots++;
          if (shot.outcome==='goal') seasonPlayerStats[shot.player].goals++;
        }
      });
      Object.keys(game.plusMinus).forEach(pNum => {
        if (seasonPlayerStats[pNum]) {
          seasonPlayerStats[pNum].plus  += game.plusMinus[pNum].plus;
          seasonPlayerStats[pNum].minus += game.plusMinus[pNum].minus;
        }
      });
    });

    let playerTable = `
      <h3 class="text-xl font-bold mb-3 text-slate-100">Pelaajatilastot</h3>
      <div class="grid grid-cols-6 text-center text-xs font-semibold text-slate-400 mb-2 px-1">
        <span>Pelaaja</span><span>O</span><span>L</span><span>M</span><span>T%</span><span>+/-</span>
      </div>
    `;
    Object.keys(seasonPlayerStats).forEach(pNum => {
      const st = seasonPlayerStats[pNum];
      const eff = st.shots>0 ? Math.round((st.goals/st.shots)*100)+'%' : '—';
      const bal = st.plus - st.minus;
      playerTable += `
        <div class="grid grid-cols-6 text-center text-sm py-1.5 border-b border-slate-700">
          <span class="text-left font-bold">#${pNum} ${fullRoster[pNum]||''}</span>
          <span>${st.games}</span>
          <span>${st.shots}</span>
          <span>${st.goals}</span>
          <span>${eff}</span>
          <span class="font-semibold">${bal>0?'+':''}${bal}</span>
        </div>
      `;
    });

    let gamesTable = `<h3 class="text-xl font-bold mt-6 mb-4 text-slate-100">Tallennetut ottelut</h3>`;
    if (seasonData.games.length>0) {
      seasonData.games.sort((a,b)=> new Date(b.date) - new Date(a.date)).forEach(game => {
        const s = getGameStats(game);
        gamesTable += `
          <details class="bg-slate-900 rounded-lg shadow mb-2">
            <summary class="flex justify-between items-center p-3 font-semibold cursor-pointer">
              <div>
                <p class="font-bold">${new Date(game.date).toLocaleDateString('fi-FI')} vs ${game.opponent}</p>
                <p class="text-sm text-slate-300">Tulos: ${s.home.goals} - ${s.away.goals}</p>
              </div>
              <button data-game-id="${game.id}" class="delete-game-btn text-red-400 hover:text-red-200 text-sm p-2">Poista</button>
            </summary>
            <div class="p-4 border-t border-slate-700 text-sm">
              ${generateGameDetailsHTML(game)}
              <button data-game-id="${game.id}" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white py-1 px-3 rounded text-sm create-pdf-btn">Luo PDF-raportti</button>
            </div>
          </details>
        `;
      });
    } else {
      gamesTable += `<p class="text-slate-400 text-sm">Ei tallennettuja otteluita.</p>`;
    }

    seasonView.innerHTML = `
      <div class="w-full max-w-5xl mx-auto">
        <div class="bg-slate-800 p-6 rounded-lg">${playerTable}</div>
        <div class="mt-6 bg-slate-800 p-6 rounded-lg">${gamesTable}</div>
      </div>
    `;
    // napit
    seasonView.querySelectorAll('.delete-game-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.gameId;
        await deleteGameFromFirestore(id);
      });
    });
    seasonView.querySelectorAll('.create-pdf-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.dataset.gameId;
        const game = seasonData.games.find(g => g.id===id);
        if (game) generatePdfReport(game);
      });
    });
  }

  function getGameStats(game) {
    let s = { home:{goals:0, shots:0, xg:0, saves:0, blocks:0}, away:{goals:0, shots:0, xg:0, saves:0, blocks:0} };
    game.shots.forEach(shot => {
      const shooter = s[shot.team];
      const opp = s[shot.team==='home'?'away':'home'];
      shooter.shots++;
      shooter.xg += shot.xG;
      if (shot.outcome==='goal') shooter.goals++;
      if (shot.outcome==='save') opp.saves++;
      if (shot.outcome==='block') opp.blocks++;
    });
    return s;
  }

  function generateGameDetailsHTML(game) {
    const s = getGameStats(game);
    let html = `
      <div class="space-y-2">
        <p class="font-semibold text-sm">Joukkueet</p>
        <div class="text-xs text-slate-300">
          <p><b>Koti:</b> L ${s.home.shots}, xG ${s.home.xg.toFixed(2)}, T ${s.home.saves}, B ${s.home.blocks}</p>
          <p><b>Vieras:</b> L ${s.away.shots}, xG ${s.away.xg.toFixed(2)}, T ${s.away.saves}, B ${s.away.blocks}</p>
        </div>
        <p class="font-semibold text-sm mt-3">Pelaajat</p>
        <div class="grid grid-cols-5 text-center font-bold text-xs text-slate-400 mt-2 px-1">
          <span>Nimi</span><span>L</span><span>M</span><span>T%</span><span>+/-</span>
        </div>
    `;
    game.players.forEach(pNum => {
      const shots = game.shots.filter(s=>s.team==='home' && s.player==pNum);
      const goals = shots.filter(s=>s.outcome==='goal').length;
      const pm = game.plusMinus[pNum];
      if (shots.length>0 || pm?.plus>0 || pm?.minus>0) {
        const eff = shots.length>0 ? Math.round((goals/shots.length)*100)+'%' : '—';
        const bal = (pm?.plus||0) - (pm?.minus||0);
        html += `
          <div class="grid grid-cols-5 text-center text-xs py-1 border-b border-slate-700">
            <span class="text-left font-semibold">#${pNum} ${game.roster[pNum]||''}</span>
            <span>${shots.length}</span>
            <span>${goals}</span>
            <span>${eff}</span>
            <span class="font-semibold">${bal>0?'+':''}${bal}</span>
          </div>
        `;
      }
    });
    html += `</div>`;
    return html;
  }

  async function deleteGameFromFirestore(gameId) {
    if (!currentUser) return;
    await deleteDoc(doc(db, 'artifacts', 'default-app-id', 'users', currentUser.uid, 'games', gameId));
  }

  // PDF (yksinkertainen, ilman autoTablea → ei blob-sivua ylimääräisenä)
  async function generatePdfReport(game) {
    try {
      const { jsPDF } = await import("https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.es.min.js");
      const doc = new jsPDF('p', 'mm', 'a4');
      const pageW = doc.internal.pageSize.getWidth();
      const margin = 15;
      let yPos = 20;

      doc.setFontSize(20);
      doc.text(`Otteluraportti: ${game.opponent}`, margin, yPos);
      yPos += 8;
      doc.setFontSize(11);
      doc.text(new Date(game.date || Date.now()).toLocaleDateString('fi-FI'), margin, yPos);
      yPos += 10;

      const periods = [1,2,3,'summary'];
      for (const p of periods) {
        const title = p==='summary' ? 'Koko ottelu' : `Erä ${p}`;
        doc.setFontSize(14);
        doc.text(title, margin, yPos);
        yPos += 4;

        // piiretään kenttä
        const imgW = 180;
        const imgH = 90;
        const xCenter = (pageW - imgW)/2;
        // tehdään canvas missä laukaukset on
        const canvas = document.createElement('canvas');
        canvas.width = 800; canvas.height = 400;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,800,400);
        ctx.strokeStyle = '#1f2937';
        ctx.lineWidth = 4;
        ctx.strokeRect(20,20,760,360);
        ctx.beginPath(); ctx.moveTo(400,20); ctx.lineTo(400,380); ctx.stroke();
        ctx.strokeRect(60,140,60,120);
        ctx.strokeRect(680,140,60,120);

        // laukaukset
        game.shots.filter(s=> p==='summary' || s.period===p).forEach(s => {
          const px = 20 + (s.x/100)*760;
          const py = 20 + (s.y/100)*360;
          // tausta
          const colorMap = {
            goal: '#10B981',
            miss: '#3B82F6',
            block: '#FACC15',
            save: '#EF4444'
          };
          ctx.fillStyle = colorMap[s.outcome] || '#94a3b8';
          ctx.strokeStyle = 'rgba(15,23,42,0.45)';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.arc(px, py, 16, 0, Math.PI*2);
          ctx.fill();
          ctx.stroke();

          ctx.fillStyle = s.outcome==='block' ? '#000000' : '#ffffff';
          ctx.font = 'bold 16px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(String(s.player), px, py);
        });

        const imgData = canvas.toDataURL('image/png');
        doc.addImage(imgData, 'PNG', xCenter, yPos, imgW, imgH);
        yPos += imgH + 6;

        const stats = getGameStatsForPeriod(game, p);
        const rows = [
          ['Maalit', stats.home.goals, stats.away.goals],
          ['Laukaukset', stats.home.shots, stats.away.shots],
          ['xG', stats.home.xg.toFixed(2), stats.away.xg.toFixed(2)],
          ['Laadukkaat (L+)', stats.home.qualityHigh, stats.away.qualityHigh],
          ['Heikot (H-)', stats.home.qualityLow, stats.away.qualityLow],
          ['Torjunnat', stats.home.saves, stats.away.saves],
          ['Blokit', stats.home.blocks, stats.away.blocks],
          ['Pallonhallinta %', stats.home.possession, stats.away.possession]
        ];
        doc.setFontSize(10);
        rows.forEach(r => {
          doc.text(r[0], margin, yPos);
          doc.text(String(r[1]), margin+90, yPos, { align:'right' });
          doc.text(String(r[2]), margin+170, yPos, { align:'right' });
          yPos += 5;
        });
        yPos += 6;
        if (yPos > 260) { doc.addPage(); yPos = 20; }
      }

      // pelaajatilasto
      doc.addPage();
      doc.setFontSize(14);
      doc.text('Pelaajatilastot', margin, 20);
      let yy = 26;
      doc.setFontSize(10);
      doc.text('Pelaaja', margin, yy);
      doc.text('L', margin+60, yy);
      doc.text('M', margin+72, yy);
      doc.text('L+', margin+84, yy);
      doc.text('H-', margin+100, yy);
      doc.text('+/-', margin+118, yy);
      doc.text('T%', margin+138, yy);
      yy += 4;

      game.players.forEach(pNum => {
        const shots = game.shots.filter(s=>s.team==='home' && s.player==pNum);
        const goals = shots.filter(s=>s.outcome==='goal').length;
        const pm = game.plusMinus[pNum] || {plus:0,minus:0};
        const eff = shots.length>0 ? Math.round((goals/shots.length)*100)+'%' : '—';
        const bal = (pm.plus||0)-(pm.minus||0);
        doc.text(`#${pNum} ${game.roster[pNum]||''}`, margin, yy);
        doc.text(String(shots.length), margin+60, yy);
        doc.text(String(goals), margin+72, yy);
        doc.text(String(shots.filter(s=>s.xG>=0.35).length), margin+84, yy);
        doc.text(String(shots.filter(s=>s.xG<0.35).length), margin+100, yy);
        doc.text(`${bal>0?'+':''}${bal}`, margin+118, yy);
        doc.text(eff, margin+138, yy);
        yy += 5;
        if (yy > 280) { doc.addPage(); yy = 20; }
      });

      // avaa samaan välilehteen
      const blobUrl = doc.output('bloburl');
      window.location.href = blobUrl;

    } catch (err) {
      console.error(err);
      pdfErrorText.textContent = 'Raportin luonti epäonnistui: '+err.message;
      pdfErrorModal.classList.remove('hidden');
    }
  }

  function getGameStatsForPeriod(game, p) {
    const s = {
      home: { goals:0, shots:0, xg:0, saves:0, blocks:0, qualityHigh:0, qualityLow:0 },
      away: { goals:0, shots:0, xg:0, saves:0, blocks:0, qualityHigh:0, qualityLow:0 },
    };
    game.shots.filter(sh => p==='summary' || sh.period===p).forEach(shot => {
      const shs = s[shot.team]; const opp = s[shot.team==='home'?'away':'home'];
      shs.shots++; shs.xg += shot.xG;
      if (shot.outcome==='goal') shs.goals++;
      if (shot.outcome==='save') opp.saves++;
      if (shot.outcome==='block') opp.blocks++;
      if (shot.xG>=0.35) shs.qualityHigh++; else shs.qualityLow++;
    });
    // pallonhallinta
    const poss = game.possession && game.possession[p] ? game.possession[p] : {home:0,away:0};
    const tot = Math.max(1, (poss.home||0)+(poss.away||0));
    s.home.possession = Math.round((poss.home||0)/tot*100)+'%';
    s.away.possession = Math.round((poss.away||0)/tot*100)+'%';
    return s;
  }
</script>
</body>
</html>
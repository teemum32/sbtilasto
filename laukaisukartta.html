<!DOCTYPE html>
<html lang="fi" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https:;
                 connect-src 'self' https: wss:;
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data:;
                 worker-src 'self' blob: data:;
                 frame-src 'self' https:;
                 frame-ancestors 'self' https:;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Salibandyn Kausitilastot</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Exportit -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Arial, sans-serif;
           touch-action: pan-y; -webkit-user-select: none; user-select: none; overflow: hidden; }
    .player-number { cursor: grab; width: 40px; height: 40px; border-radius: 9999px;
      display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem;
      border: 2px solid white; background: #020617; color: white; box-shadow: 0 2px 4px rgba(0,0,0,.1); touch-action: none; }
    .away-player { font-size: 1.5rem; }
    .dragging { position: absolute; pointer-events: none; opacity: .7; z-index: 1000; }
    .shot-marker { position: absolute; width: 40px; height: 40px; border-radius: 9999px; font-weight: 700; font-size: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,.4); color: white; transform: translate(-50%, -50%);
      transition: opacity .2s; cursor: pointer; display:flex; align-items:center; justify-content:center; }
    .goal { background-color:#10B981 } .miss{ background-color:#3B82F6 }
    .block{ background-color:#FACC15; color:#111827 } .save{ background-color:#EF4444 }
    .quality-high { outline: 4px solid #b91c1c; } .quality-low { outline: 4px solid #2563eb; }
    .action-modal { position: absolute; transform: translate(-50%, -50%); z-index: 50; display:flex; flex-direction:column; }
    .period-tab { padding: 8px 16px; border-radius: 6px; font-weight: 600; transition: background-color .2s; }
    .period-tab.active { background-color: #4f46e5; }
  </style>
</head>
<body class="bg-slate-900 h-full text-slate-200">

  <!-- Landing -->
  <div id="landing-view" class="h-full w-full flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center">
      <h1 class="text-3xl font-bold">Tilastotyökalu</h1>
      <div class="space-y-4 mt-8">
        <button id="start-new-game-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 font-bold py-3 px-4 rounded-lg">Aloita uusi ottelu</button>
        <button id="view-season-data-btn" class="w-full bg-slate-600 hover:bg-slate-700 font-bold py-3 px-4 rounded-lg disabled:opacity-50">Tarkastele kausidataa</button>
      </div>
    </div>
  </div>

  <!-- Uusi ottelu -->
  <div id="setup-view" class="h-full w-full hidden items-center justify-center p-4">
    <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center">
      <h1 class="text-3xl font-bold mb-4">Uusi ottelu</h1>
      <input id="opponent-name-input" type="text" class="w-full p-3 border bg-slate-700 border-slate-600 rounded-lg text-lg text-center mb-4" placeholder="Vastustajan nimi">
      <textarea id="player-roster-input" class="w-full h-48 p-3 border bg-slate-700 border-slate-600 rounded-lg text-sm font-mono" placeholder="7 Matti Meikäläinen&#10;22 Maija Malli"></textarea>
      <p id="setup-error" class="text-red-500 text-sm mt-2 h-5"></p>
      <button id="start-button" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 font-bold py-3 px-4 rounded-lg">Aloita merkintä</button>
      <button id="back-to-landing-btn" class="mt-2 w-full text-slate-400 hover:text-slate-200 font-semibold py-2">Takaisin</button>
    </div>
  </div>

  <!-- Päänäkymä -->
  <div id="app-container" class="h-full w-full hidden flex-col">
    <div id="period-tabs" class="bg-slate-800 p-2 flex justify-center gap-1 md:gap-2 shrink-0 flex-wrap">
      <button data-period="1" class="period-tab active">Erä 1</button>
      <button data-period="2" class="period-tab">Erä 2</button>
      <button data-period="3" class="period-tab">Erä 3</button>
      <button data-period="summary" class="period-tab">Ottelu</button>
      <button data-period="season" class="period-tab">Kausi</button>
    </div>

    <div class="flex-1 min-h-0 relative">
      <div id="main-app" class="absolute inset-0 grid grid-cols-1 md:grid-cols-[256px,1fr]">
        <aside class="bg-slate-900 p-4 flex flex-col overflow-y-auto order-last md:order-first">
          <h2 class="text-xl font-bold mb-4 text-center">Koti</h2>
          <div id="home-player-list" class="grid grid-cols-3 gap-3 mb-6"></div>

          <h2 class="text-xl font-bold mb-4 text-center">Vieras</h2>
          <div id="away-player-list" class="flex justify-center mb-6">
            <div class="player-number away-player">V</div>
          </div>

          <div id="stats-container" class="border-t border-slate-700 pt-4"></div>
          <div id="player-stats-container" class="hidden border-t border-slate-700 pt-4 mt-4"></div>

          <button id="save-game-button" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-lg">Tallenna</button>
        </aside>

        <main class="flex items-center justify-center gap-4 p-4 bg-slate-200 min-w-0 order-first md:order-last">
          <div class="text-slate-500 font-bold text-lg -rotate-90">Vieras</div>
          <div id="field-container" class="relative w-full max-w-[1200px] aspect-[2/1] bg-white rounded-lg shadow-2xl border-2 border-slate-800">
            <svg class="w-full h-full" viewBox="0 0 400 200">
              <line x1="200" y1="0" x2="200" y2="200" stroke="#94a3b8" stroke-width="2"/>
              <rect x="30" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"/>
              <rect x="330" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"/>
            </svg>
            <div id="shots-layer" class="absolute inset-0"></div>
          </div>
          <div class="text-slate-500 font-bold text-lg rotate-90">Koti</div>
        </main>
      </div>

      <div id="season-view" class="absolute inset-0 hidden bg-slate-200 overflow-y-auto p-4"></div>
    </div>
  </div>

  <!-- Modaalit -->
  <div id="outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
  <div id="quality-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
  <div id="edit-outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
  <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"></div>

  <script type="module">
    // ------- Tallennus: localStorage -------
    const STORAGE_KEY = 'sbtilastot_local';
    const dbLocal = {
      async listGames() {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      },
      async addGame(game) {
        const all = await this.listGames();
        const id = String(Date.now());
        all.push({ id, ...game });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
      },
      async deleteGame(id) {
        const all = await this.listGames();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(all.filter(g => g.id !== id)));
      }
    };

    // ------- App state -------
    const allViews = {
      landing: document.getElementById('landing-view'),
      setup: document.getElementById('setup-view'),
      app: document.getElementById('app-container')
    };
    const shotsLayer = document.getElementById('shots-layer');
    const periodTabs = document.getElementById('period-tabs');
    const seasonView = document.getElementById('season-view');
    const setupError = document.getElementById('setup-error');
    const opponentNameInput = document.getElementById('opponent-name-input');
    const playerRosterInput = document.getElementById('player-roster-input');

    let seasonData = { games: [] }, rosterData = {}, currentGame = {};
    let draggedElement = null, ghostElement = null, tempShotData = {}, shotToEditId = null;

    // ------- Helpers -------
    function showMainView(view) {
      Object.values(allViews).forEach(v => (v.classList.add('hidden'), v.classList.remove('flex')));
      allViews[view].classList.remove('hidden');
      allViews[view].classList.add('flex');
    }
    showMainView('landing');

    document.getElementById('start-new-game-btn').addEventListener('click', () => { showMainView('setup'); prefillRosterInput(); });
    document.getElementById('view-season-data-btn').addEventListener('click', async () => {
      showMainView('app'); await refreshSeason(); showView('season');
    });
    document.getElementById('back-to-landing-btn').addEventListener('click', () => showMainView('landing'));

    function prefillRosterInput() {
      playerRosterInput.value = Object.keys(rosterData).map(Number).sort((a,b)=>a-b).map(n => `${n} ${rosterData[n]||''}`).join('\n');
    }

    // ------- Uusi peli -------
    document.getElementById('start-button').addEventListener('click', async () => {
      setupError.textContent = '';
      const opponent = opponentNameInput.value.trim();
      if (!opponent) { setupError.textContent = 'Syötä vastustajan nimi.'; return; }
      const lines = playerRosterInput.value.split('\n').map(l=>l.trim()).filter(Boolean);
      if (!lines.length) { setupError.textContent = 'Syötä vähintään yksi pelaaja.'; return; }

      const newRoster = {};
      for (const line of lines) {
        const m = line.match(/^(\d{1,3})\s*(.*)$/);
        if (!m) { setupError.textContent = 'Virheellinen rivi: ' + line; return; }
        newRoster[Number(m[1])] = (m[2]||'').trim();
      }
      rosterData = newRoster;

      startNewGame(newRoster, opponent);
      showMainView('app');
    });

    function startNewGame(roster, opponent) {
      shotsLayer.innerHTML = '';
      const players = Object.keys(roster).map(Number).sort((a,b)=>a-b);
      currentGame = { date: new Date().toISOString(), opponent, players, roster, shots: [], plusMinus: {} };
      players.forEach(p => currentGame.plusMinus[p] = { plus:0, minus:0 });
      initializePlayers();
      bindGameListeners();
      showView(1);
    }

    function initializePlayers() {
      const home = document.getElementById('home-player-list');
      const away = document.getElementById('away-player-list');
      home.innerHTML = '';
      away.innerHTML = '';
      const v = document.createElement('div'); v.className='player-number away-player'; v.textContent='V'; away.appendChild(v);
      (currentGame.players||[]).forEach(num => {
        const el = document.createElement('div');
        el.className='player-number'; el.textContent=num; el.title=currentGame.roster?.[num]||'';
        home.appendChild(el);
      });
    }

    // ------- Periodit & laukaukset -------
    function showView(viewId) {
      document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.period-tab[data-period="${viewId}"]`)?.classList.add('active');
      document.getElementById('main-app').classList.add('hidden');
      seasonView.classList.add('hidden');
      if (viewId === 'season') {
        renderSeasonStats();
        seasonView.classList.remove('hidden');
      } else {
        document.getElementById('main-app').classList.remove('hidden');
        currentGame.currentPeriod = isNaN(viewId) ? viewId : parseInt(viewId,10);
        renderShots(); updateStats();
      }
    }
    periodTabs.addEventListener('click', (e) => {
      const b = e.target.closest('.period-tab'); if (b) showView(b.dataset.period);
    });

    function bindGameListeners() {
      ['home-player-list','away-player-list'].forEach(id => {
        document.getElementById(id).addEventListener('pointerdown', onPointerDown, { passive:false });
      });
      document.addEventListener('pointermove', onPointerMove, { passive:false });
      document.addEventListener('pointerup', onPointerUp);
      document.getElementById('shots-layer').addEventListener('click', onShotMarkerClick);

      document.getElementById('save-game-button').addEventListener('click', () =>
        showConfirmation('Tallenna ottelu?', 'Tallennetaanko ottelu kausidataan?', 'Kyllä, tallenna', 'bg-blue-600', saveAndEndGame)
      );

      document.getElementById('outcome-modal').addEventListener('click', onOutcomeSelect);
      document.getElementById('quality-modal').addEventListener('click', onQualitySelect);
      document.getElementById('edit-outcome-modal').addEventListener('click', onEditOutcomeSelect);
    }

    function onPointerDown(e){ const t=e.target.closest('.player-number'); if(!t) return; draggedElement=t; ghostElement=t.cloneNode(true); ghostElement.classList.add('dragging'); document.body.appendChild(ghostElement); updateGhostPosition(e.pageX,e.pageY); }
    function onPointerMove(e){ if(!ghostElement) return; e.preventDefault(); updateGhostPosition(e.pageX,e.pageY); }
    function onPointerUp(e){
      if(!draggedElement||!ghostElement) return;
      ghostElement.style.display='none';
      const dropTarget = document.elementFromPoint(e.clientX,e.clientY);
      ghostElement.style.display='';
      const field = document.getElementById('field-container');
      if(field && field.contains(dropTarget)){
        const rect = shotsLayer.getBoundingClientRect();
        const x = ((e.clientX-rect.left)/rect.width)*100;
        const y = ((e.clientY-rect.top)/rect.height)*100;
        tempShotData = { player: draggedElement.textContent, team: draggedElement.classList.contains('away-player')?'away':'home', x, y, cx:e.clientX, cy:e.clientY };
        showOutcomeModal(e.clientX, e.clientY);
      }
      document.body.removeChild(ghostElement); ghostElement=null; draggedElement=null;
    }
    function updateGhostPosition(x,y){ if(ghostElement){ ghostElement.style.left=`${x-20}px`; ghostElement.style.top=`${y-20}px`; } }

    function showOutcomeModal(x,y){ const m=document.getElementById('outcome-modal'); hideEditOutcomeModal(); hideQualityModal(false); m.style.left=`${x}px`; m.style.top=`${y}px`; m.classList.remove('hidden'); m.innerHTML = `
      <button data-outcome="goal" class="w-28 text-white font-semibold py-2 rounded-md bg-emerald-500">Maali</button>
      <button data-outcome="miss" class="w-28 text-white font-semibold py-2 rounded-md bg-blue-500">Ohi</button>
      <button data-outcome="block" class="w-28 text-slate-800 font-semibold py-2 rounded-md bg-yellow-400">Blokki</button>
      <button data-outcome="save" class="w-28 text-white font-semibold py-2 rounded-md bg-red-500">Torjunta</button>`; }
    function hideOutcomeModal(){ document.getElementById('outcome-modal').classList.add('hidden'); }
    function onOutcomeSelect(e){ const b=e.target.closest('[data-outcome]'); if(!b) return; tempShotData.outcome=b.dataset.outcome; hideOutcomeModal(); showQualityModal(tempShotData.cx,tempShotData.cy); }
    function showQualityModal(x,y){ const m=document.getElementById('quality-modal'); m.style.left=`${x}px`; m.style.top=`${y}px`; m.classList.remove('hidden'); m.innerHTML=`
      <button data-quality="high" class="w-28 text-white font-semibold py-2 px-4 rounded-md bg-red-700">Laadukas</button>
      <button data-quality="low" class="w-28 text-white font-semibold py-2 px-4 rounded-md bg-blue-700">Heikko</button>`; }
    function hideQualityModal(clear=true){ const m=document.getElementById('quality-modal'); m.classList.add('hidden'); if(clear) tempShotData={}; }
    function onQualitySelect(e){ const b=e.target.closest('[data-quality]'); if(!b) return; const newShot={ id:Date.now()+Math.random(), ...tempShotData, quality:b.dataset.quality, period: currentGame.currentPeriod||1, xG: calculateXg(tempShotData.x,tempShotData.y,tempShotData.team) }; delete newShot.cx; delete newShot.cy; currentGame.shots.push(newShot); hideQualityModal(); renderShots(); updateStats(); }

    function onShotMarkerClick(e){
      const t = e.target.closest('.shot-marker'); if(!t) { hideEditOutcomeModal(); return; }
      shotToEditId = Number(t.dataset.shotId);
      const m = document.getElementById('edit-outcome-modal');
      m.style.left = `${e.clientX}px`; m.style.top = `${e.clientY}px`;
      m.classList.remove('hidden');
      m.innerHTML = `
        <button data-outcome="goal" class="w-32 text-white font-semibold py-2 rounded-md bg-emerald-500">Maali</button>
        <button data-outcome="miss" class="w-32 text-white font-semibold py-2 rounded-md bg-blue-500">Ohi</button>
        <button data-outcome="block" class="w-32 text-slate-800 font-semibold py-2 rounded-md bg-yellow-400">Blokki</button>
        <button data-outcome="save" class="w-32 text-white font-semibold py-2 rounded-md bg-red-500">Torjunta</button>
        <div class="border-t my-1"></div>
        <button id="delete-shot-btn" class="w-32 text-white font-semibold py-2 rounded-md bg-slate-600">Poista</button>`;
    }
    function hideEditOutcomeModal(){ document.getElementById('edit-outcome-modal').classList.add('hidden'); shotToEditId = null; }
    function onEditOutcomeSelect(e){
      if(!shotToEditId) return;
      const idx = currentGame.shots.findIndex(s=>s.id===shotToEditId); if(idx===-1) return;
      if(e.target.id==='delete-shot-btn'){ currentGame.shots.splice(idx,1); }
      else if(e.target.closest('[data-outcome]')) { currentGame.shots[idx].outcome = e.target.dataset.outcome; }
      hideEditOutcomeModal(); renderShots(); updateStats();
    }

    function createShotMarker(s){
      const d=document.createElement('div'); d.className=`shot-marker ${s.outcome}`; if(s.quality==='high') d.classList.add('quality-high'); if(s.quality==='low') d.classList.add('quality-low');
      d.dataset.shotId = s.id; d.style.left=`${s.x}%`; d.style.top=`${s.y}%`; d.innerHTML = `<span>${s.player}</span>`; return d;
    }
    function renderShots(){
      shotsLayer.innerHTML=''; const set=(currentGame.shots||[]).filter(s=> (currentGame.currentPeriod==='summary') ? true : s.period===currentGame.currentPeriod);
      set.forEach(s=>shotsLayer.appendChild(createShotMarker(s)));
    }

    function updateStats(){
      if(!currentGame?.shots) return;
      let stats = { home:{goals:0,shots:0,xg:0,saves:0,blocks:0,qualityHigh:0,qualityLow:0}, away:{goals:0,shots:0,xg:0,saves:0,blocks:0,qualityHigh:0,qualityLow:0} };
      const set=(currentGame.shots||[]).filter(s=> (currentGame.currentPeriod==='summary') ? true : s.period===currentGame.currentPeriod);
      set.forEach(shot=>{
        const t=shot.team==='away'?'away':'home', o=t==='home'?'away':'home';
        stats[t].shots++; stats[t].xg += Number(shot.xG)||0;
        if(shot.outcome==='goal') stats[t].goals++;
        if(shot.outcome==='save') stats[o].saves++;
        if(shot.outcome==='block') stats[o].blocks++;
        if(shot.quality==='high') stats[t].qualityHigh++;
        if(shot.quality==='low') stats[t].qualityLow++;
      });
      document.getElementById('stats-container').innerHTML = `
        <h3 class="text-lg font-bold text-center mb-3">${currentGame.currentPeriod==='summary'?'Koko ottelu':`Erä ${currentGame.currentPeriod}`}</h3>
        <div class="space-y-4">
          <div>
            <div class="flex justify-between font-semibold"><span>Koti</span></div>
            <div class="flex justify-between text-sm mt-1"><span>Maalit: ${stats.home.goals}</span><span>Laukaukset: ${stats.home.shots}</span></div>
            <div class="flex justify-between text-sm"><span>xG: ${stats.home.xg.toFixed(2)}</span><span>L+: ${stats.home.qualityHigh} / H-: ${stats.home.qualityLow}</span></div>
            <div class="flex justify-between text-sm mt-1 border-t pt-1"><span>Torjunnat: ${stats.home.saves}</span><span>Blokit: ${stats.home.blocks}</span></div>
          </div>
          <div>
            <div class="flex justify-between font-semibold"><span>Vieras</span></div>
            <div class="flex justify-between text-sm mt-1"><span>Maalit: ${stats.away.goals}</span><span>Laukaukset: ${stats.away.shots}</span></div>
            <div class="flex justify-between text-sm"><span>xG: ${stats.away.xg.toFixed(2)}</span><span>L+: ${stats.away.qualityHigh} / H-: ${stats.away.qualityLow}</span></div>
            <div class="flex justify-between text-sm mt-1 border-t pt-1"><span>Torjunnat: ${stats.away.saves}</span><span>Blokit: ${stats.away.blocks}</span></div>
          </div>
        </div>`;
      document.getElementById('player-stats-container').classList.toggle('hidden', currentGame.currentPeriod !== 'summary');
      if(currentGame.currentPeriod==='summary') updatePlayerStats();
    }
    function updatePlayerStats(){
      const box=document.getElementById('player-stats-container');
      let html = `<h3 class="text-lg font-bold text-center mb-3">Pelaajatilastot</h3>
      <div class="grid grid-cols-7 text-center font-semibold text-xs text-slate-400 mb-2 px-1">
        <span class="col-span-2">Pelaaja</span><span>L</span><span>M</span><span>L+</span><span>H-</span><span>+/-</span></div>`;
      (currentGame.players||[]).forEach(pNum=>{
        const shots = (currentGame.shots||[]).filter(s=>s.team==='home' && s.player==pNum);
        const goals = shots.filter(s=>s.outcome==='goal').length;
        const qH = shots.filter(s=>s.quality==='high').length;
        const qL = shots.filter(s=>s.quality==='low').length;
        const pm = currentGame.plusMinus[pNum]||{plus:0,minus:0};
        if(shots.length>0 || pm.plus>0 || pm.minus>0){
          const bal = pm.plus - pm.minus;
          const name = (currentGame.roster[pNum]||'').split(' ')[0]||'';
          html += `<div class="grid grid-cols-7 text-center text-sm py-1 border-b border-slate-700 items-center">
            <span class="font-bold text-left col-span-2 truncate">#${pNum} ${name}</span>
            <span>${shots.length}</span><span>${goals}</span>
            <span class="text-red-400 font-semibold">${qH}</span>
            <span class="text-blue-400 font-semibold">${qL}</span>
            <span class="font-semibold">${bal>0?'+':''}${bal}</span></div>`;
        }
      });
      box.innerHTML = html;
    }

    // ------- xG ruudukko + peilaus -------
    const XG_GRID = [
      [0.200, 0.164, 0.075, 0.164, 0.200],
      [0.084, 0.066, 0.050, 0.066, 0.084],
      [0.001, 0.014, 0.022, 0.014, 0.010]
    ];
    const GRID_ROWS = XG_GRID.length, GRID_COLS = XG_GRID[0].length;
    function bilerp(g,u,v){ const x=u*(GRID_COLS-1), y=v*(GRID_ROWS-1);
      const x0=Math.floor(x), x1=Math.min(x0+1,GRID_COLS-1);
      const y0=Math.floor(y), y1=Math.min(y0+1,GRID_ROWS-1);
      const q00=g[y0][x0], q01=g[y0][x1], q10=g[y1][x0], q11=g[y1][x1];
      const tx=x-x0, ty=y-y0; const a=q00*(1-tx)+q01*tx, b=q10*(1-tx)+q11*tx; return a*(1-ty)+b*ty; }
    function toAttackingHalfUV(xPct,yPct,team){
      const side = Math.min(Math.max(yPct/100,0),1);
      let v; if(team==='home') v=Math.min(Math.max((100-xPct)/50,0),1); else v=Math.min(Math.max(xPct/50,0),1);
      return { u: side, v };
    }
    function calculateXg(xPct,yPct,team){
      const {u,v}=toAttackingHalfUV(xPct,yPct,team);
      const base=bilerp(XG_GRID,u,v);
      const distFromCenter=Math.abs(yPct-50)/50;
      const angleFactor=Math.pow(1-distFromCenter,1.2);
      const distanceFactor=Math.pow(1-v,0.6);
      const SCALE=0.85;
      return Number(Math.min(0.95, Math.max(0.01, base*angleFactor*distanceFactor*SCALE)).toFixed(2));
    }

    // ------- Kausi (localStorage) -------
    async function refreshSeason(){ seasonData.games = await dbLocal.listGames(); document.getElementById('view-season-data-btn').disabled = seasonData.games.length === 0; }
    function safeDateValue(game){ if(game?.date){ const d=new Date(game.date); if(!isNaN(+d)) return +d; } return Date.now(); }
    function getGameStats(game){
      const s={home:{goals:0,shots:0,xg:0,saves:0,blocks:0,qualityHigh:0,qualityLow:0}, away:{goals:0,shots:0,xg:0,saves:0,blocks:0,qualityHigh:0,qualityLow:0}};
      (game.shots||[]).forEach(sh=>{
        const t=sh.team==='away'?'away':'home', o=t==='home'?'away':'home';
        s[t].shots++; s[t].xg += Number(sh.xG)||0;
        if(sh.outcome==='goal') s[t].goals++;
        if(sh.outcome==='save') s[o].saves++;
        if(sh.outcome==='block') s[o].blocks++;
        if(sh.quality==='high') s[t].qualityHigh++;
        if(sh.quality==='low') s[t].qualityLow++;
      }); return s;
    }

    function renderSeasonStats(){
      const safeGames = (seasonData.games||[]).slice().sort((a,b)=>safeDateValue(b)-safeDateValue(a));
      let gamesTable = `<h3 class="text-xl font-bold text-slate-800 mb-4">Tallennetut ottelut</h3>`;
      if (safeGames.length>0){
        safeGames.forEach(game=>{
          const s=getGameStats(game);
          const dateStr=new Date(safeDateValue(game)).toLocaleDateString('fi-FI');
          gamesTable += `
            <details class="bg-white rounded-lg shadow mb-3">
              <summary class="flex justify-between items-center p-3 font-semibold text-slate-800">
                <div>
                  <p class="font-bold">${dateStr} vs ${game.opponent||''}</p>
                  <p class="text-sm text-slate-600">Tulos: ${s.home.goals} - ${s.away.goals}</p>
                </div>
                <div class="flex gap-2">
                  <button data-game-id="${game.id}" class="generate-pdf-btn bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold py-2 px-3 rounded">Luo PDF-raportti</button>
                  <button data-game-id="${game.id}" class="delete-game-btn bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-2 px-3 rounded">Poista</button>
                </div>
              </summary>
              <div class="p-3 text-sm text-slate-700">
                <div><b>Koti:</b> L ${s.home.shots}, xG ${s.home.xg.toFixed(2)}, L+ ${s.home.qualityHigh}, H- ${s.home.qualityLow}, T ${s.home.saves}, B ${s.home.blocks}</div>
                <div><b>Vieras:</b> L ${s.away.shots}, xG ${s.away.xg.toFixed(2)}, L+ ${s.away.qualityHigh}, H- ${s.away.qualityLow}, T ${s.away.saves}, B ${s.away.blocks}</div>
              </div>
            </details>`;
        });
      } else {
        gamesTable += `<div class="text-slate-700">Ei tallennettuja otteluita.</div>`;
      }
      seasonView.innerHTML = `<div class="w-full max-w-4xl mx-auto">${gamesTable}</div>`;

      seasonView.onclick = (e)=>{
        const del = e.target.closest('.delete-game-btn');
        const pdf = e.target.closest('.generate-pdf-btn');
        if (del) { e.preventDefault(); dbLocal.deleteGame(del.dataset.gameId).then(refreshSeason).then(renderSeasonStats); }
        if (pdf) { e.preventDefault(); const id = pdf.dataset.gameId; const game = (seasonData.games||[]).find(g=>g.id===id); if (game) generatePdfReportDOM(game); }
      };
    }

    async function saveAndEndGame(){
      const gameToSave = { ...currentGame };
      await dbLocal.addGame(gameToSave);
      await refreshSeason();
      showView('season');
    }

    // ------- PDF-apurit -------
    function callAutoTable(doc, opts) {
      if (window.jspdfAutoTable) return window.jspdfAutoTable(doc, opts);
      if (doc.autoTable) return doc.autoTable(opts);
      throw new Error('AutoTable-plugin ei ole ladattu');
    }

    function getStatsForPeriod(game, period) {
      const shots = (game?.shots || []).filter(s => period === 'summary' ? true : s.period === period);
      const agg = {
        home: { goals:0, shots:0, xg:0, saves:0, blocks:0, qualityHigh:0, qualityLow:0 },
        away: { goals:0, shots:0, xg:0, saves:0, blocks:0, qualityHigh:0, qualityLow:0 }
      };
      shots.forEach(shot => {
        const team = shot.team === 'away' ? 'away' : 'home';
        const opp  = team === 'home' ? 'away' : 'home';
        agg[team].shots++;
        agg[team].xg += Number(shot.xG) || 0;
        if (shot.outcome === 'goal') agg[team].goals++;
        if (shot.outcome === 'save') agg[opp].saves++;
        if (shot.outcome === 'block') agg[opp].blocks++;
        if (shot.quality === 'high') agg[team].qualityHigh++;
        if (shot.quality === 'low')  agg[team].qualityLow++;
      });
      return agg;
    }

    const COLORS = { goal:'#10B981', miss:'#3B82F6', block:'#FACC15', save:'#EF4444' };

    // *** KOH DISTUS KORJATTU: ei sisä-offsetia, sama koordinaatisto kuin pelissä ***
    function createShotmapElement(game, period) {
      const shots = (game?.shots || []).filter(s =>
        period === 'summary' ? true : s.period === period
      );
      const W = 900, H = 450;

      const wrap = document.createElement('div');
      Object.assign(wrap.style, {
        position:'fixed', left:'-10000px', top:'0',
        width:`${W}px`, height:`${H}px`,
        background:'#fff', borderRadius:'12px',
        boxShadow:'0 10px 30px rgba(0,0,0,.2)', overflow:'hidden', zIndex:'-1'
      });

      const field = document.createElement('div');
      Object.assign(field.style, { position:'relative', width:'100%', height:'100%' });
      field.innerHTML = `
        <svg width="${W}" height="${H}" viewBox="0 0 400 200" style="position:absolute;inset:0">
          <rect x="0" y="0" width="400" height="200" fill="#ffffff" stroke="#1f2937" stroke-width="3"/>
          <line x1="200" y1="0" x2="200" y2="200" stroke="#94a3b8" stroke-width="2"/>
          <rect x="30"  y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"/>
          <rect x="330" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"/>
        </svg>`;
      wrap.appendChild(field);

      const layer = document.createElement('div');
      Object.assign(layer.style, { position:'absolute', inset:'0' });
      field.appendChild(layer);

      shots.forEach(s => {
        const leftPx = Math.max(0, Math.min(W,  (s.x / 100) * W));
        const topPx  = Math.max(0, Math.min(H,  (s.y / 100) * H));

        const dot = document.createElement('div');
        dot.textContent = s.player;
        Object.assign(dot.style, {
          position:'absolute', width:'34px', height:'34px', lineHeight:'34px', textAlign:'center',
          fontWeight:'700', color:'#fff', borderRadius:'9999px', boxShadow:'0 3px 8px rgba(0,0,0,.3)',
          transform:'translate(-50%,-50%)', left: `${leftPx}px`, top: `${topPx}px`,
          background: COLORS[s.outcome] || '#111827'
        });
        if (s.quality === 'high') dot.style.outline = '4px solid #b91c1c';
        if (s.quality === 'low')  dot.style.outline = '4px solid #2563eb';
        layer.appendChild(dot);
      });

      return wrap;
    }

    // *** Pelaajataulukko: nimi kapeampi + kaikki kotipelaajat mukana ***
    function generatePlayerStatsForPdf(doc, game, startY = 20) {
      // Kaikki kotijoukkueen pelaajat, myös nollilla
      const rows = [];
      const players = (game.players || []).slice().sort((a,b)=>a-b);
      players.forEach(pNum => {
        const shots = (game.shots || []).filter(s => s.team === 'home' && String(s.player) === String(pNum));
        const goals = shots.filter(s => s.outcome === 'goal').length;
        const qH    = shots.filter(s => s.quality === 'high').length;
        const qL    = shots.filter(s => s.quality === 'low').length;
        const pm    = (game.plusMinus && game.plusMinus[pNum]) ? game.plusMinus[pNum] : { plus:0, minus:0 };
        const plusMinus = (pm.plus - pm.minus) >= 0 ? `+${pm.plus - pm.minus}` : String(pm.plus - pm.minus);
        const name = (game.roster?.[pNum] || '').trim();
        const display = name ? `#${pNum} ${name}` : `#${pNum}`;
        rows.push([display, shots.length, goals, qH, qL, plusMinus]);
      });

      // Nimi-sarake kapeampi; lisätään T% (maalit/lauk.)
      callAutoTable(doc, {
        startY,
        margin: { left: 10, right: 10 },
        tableWidth: doc.internal.pageSize.getWidth() - 20, // koko leveys marginaaleihin asti
        theme: 'grid',
        head: [['Pelaaja', 'Lauk.', 'Maalit', 'L+', 'H-', '+/-', 'T%']],
        body: rows.length
          ? rows.map(r => {
              const shots = r[1] || 0, goals = r[2] || 0;
              const pct = shots ? Math.round((goals / shots) * 100) + '%' : '—';
              return [r[0], r[1], r[2], r[3], r[4], r[5], pct];
            })
          : [['—', 0, 0, 0, 0, '0', '—']],
        styles:     { font: 'helvetica', fontSize: 10 },
        headStyles: { fillColor: [41, 52, 72], textColor: 255 },
        // Nimi-sarake kapeammaksi, numerot tiiviisti oikealle
        columnStyles: {
          0: { cellWidth: 60 },                 // Pelaaja (kapeampi)
          1: { cellWidth: 20, halign: 'right' },// Lauk.
          2: { cellWidth: 20, halign: 'right' },// Maalit
          3: { cellWidth: 18, halign: 'right' },// L+
          4: { cellWidth: 18, halign: 'right' },// H-
          5: { cellWidth: 22, halign: 'right' },// +/-
          6: { cellWidth: 22, halign: 'right' } // T%
        }
      });
    }

    // ------- PDF generointi: isompi kuva + taulukko alla, avaus samaan ikkunaan -------
    async function generatePdfReportDOM(game) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

      const margin = 10;
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      let yPos = margin;

      // Otsikko
      const dateStr = game.date ? new Date(game.date).toLocaleDateString('fi-FI') : '';
      doc.setFont('helvetica', 'normal'); doc.setFontSize(18);
      doc.text(`Otteluraportti: ${game.opponent || ''}`, pageW/2, yPos, { align:'center' });
      yPos += 8; doc.setFontSize(12); doc.text(dateStr, pageW/2, yPos, { align:'center' }); yPos += 15;

      for (const period of [1,2,3,'summary']) {
        const stats = getStatsForPeriod(game, period);
        const map = createShotmapElement(game, period);
        document.body.appendChild(map);
        await new Promise(r => requestAnimationFrame(() => r()));
        const canvas = await html2canvas(map, { scale: 2, backgroundColor: '#ffffff', useCORS: true });
        document.body.removeChild(map);

        // --- Eräotsikko + iso kuva keskelle ---
        const title = period === 'summary' ? 'Koko ottelu' : `Erä ${period}`;

        const imgData = canvas.toDataURL('image/png');

        // Kuvan koko: iso kenttä (180 mm leveä), säilytetään 2:1 kuvasuhde
        const imgMaxW = pageW - margin * 2;
        const imgW = Math.min(180, imgMaxW);                // 180 mm leveä kuva
        const imgH = imgW * (canvas.height / canvas.width); // 2:1 => ~90 mm

        // Arvio taulukon korkeudesta (6–7 riviä)
        const approxTableH = 62;

        // Uusi sivu jos ei mahdu
        if (yPos + 6 + imgH + approxTableH > pageH - margin) {
          doc.addPage();
          yPos = margin;
        }

        // Otsikko
        doc.setFontSize(14);
        doc.text(title, margin, yPos);
        yPos += 6;

        // Iso kenttäkuva keskelle
        const imgX = (pageW - imgW) / 2;
        doc.addImage(imgData, 'PNG', imgX, yPos, imgW, imgH);
        yPos += imgH + 8;

        // Taulukko KUVAN ALLE, koko sivun levyiseksi marginaaleihin asti
        callAutoTable(doc, {
          startY: yPos,
          margin: { left: margin, right: margin },
          tableWidth: pageW - margin * 2,
          theme: 'grid',
          head: [['Tapahtuma', 'Koti', 'Vieras']],
          body: [
            ['Maalit',            stats.home.goals,         stats.away.goals],
            ['Laukaukset',        stats.home.shots,         stats.away.shots],
            ['xG',                stats.home.xg.toFixed(2), stats.away.xg.toFixed(2)],
            ['Laadukkaat (L+)',   stats.home.qualityHigh,   stats.away.qualityHigh],
            ['Heikot (H-)',       stats.home.qualityLow,    stats.away.qualityLow],
            ['Torjunnat',         stats.home.saves,         stats.away.saves],
            ['Blokit',            stats.home.blocks,        stats.away.blocks],
          ],
          styles:     { font: 'helvetica', fontSize: 10 },
          headStyles: { fillColor: [41, 52, 72], textColor: 255 },
          // Tapahtuma-sarake leveämpi, numerot napakasti oikealle
          columnStyles: {
            0: { cellWidth: 110 },                // Tapahtuma
            1: { cellWidth: 60, halign: 'right' },// Koti
            2: { cellWidth: 60, halign: 'right' } // Vieras
          }
        });

        // Aloituskorkeus seuraavaa blokkia varten
        yPos = (doc.lastAutoTable && doc.lastAutoTable.finalY ? doc.lastAutoTable.finalY : yPos) + 14;
      }

      // Pelaajat
      doc.addPage(); yPos = margin;
      doc.setFontSize(16); doc.text('Pelaajakohtaiset tilastot', pageW/2, yPos, { align:'center' }); yPos += 10;
      generatePlayerStatsForPdf(doc, game, yPos);

      // Avaa PDF suoraan samaan ikkunaan (iOS: Jaa-painike näkyy)
      const blobUrl = doc.output('bloburl');
      window.location.assign(blobUrl);
    }

    // ------- UI helper: confirm -------
    function showConfirmation(title, text, btnText, btnClass, callback) {
      const modal = document.getElementById('confirm-modal');
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm text-center">
          <h3 class="text-xl font-bold text-slate-800 mb-4">${title}</h3>
          <p class="text-slate-600 mb-6">${text}</p>
          <div class="flex justify-center gap-4">
            <button id="cancel-confirm-btn" class="px-6 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 font-semibold">Peruuta</button>
            <button id="confirm-btn" class="px-6 py-2 rounded-lg text-white font-semibold ${btnClass}">${btnText}</button>
          </div>
        </div>`;
      modal.classList.remove('hidden');
      document.getElementById('cancel-confirm-btn').onclick = () => modal.classList.add('hidden');
      document.getElementById('confirm-btn').onclick = () => { modal.classList.add('hidden'); callback(); };
    }
  </script>
</body>
</html>
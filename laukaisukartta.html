<!-- ... olemassa oleva koodi ... -->
        let db, auth, userId, currentTeamId;
        // KORJATTU: Haetaan appId ympäristömuuttujasta
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let seasonData = { games: [] }, rosterData = {}, currentGame = {};
<!-- ... olemassa oleva koodi ... -->
            }
        }

        // KORJATTU: Palautettu käyttäjän oma Firebase-konfiguraatio ja yksinkertaistettu alustus
        async function startFirebaseApp() {
            try {
                // PALAUTETTU: Käytetään käyttäjän omaa, kovakoodattua Firebase-konfiguraatiota
                const firebaseConfig = { apiKey: "AIzaSyDdqRwtwIat2t_qKYE9H3jmbVM1_EIvKy0", authDomain: "sbtilastot.firebaseapp.com", projectId: "sbtilastot", storageBucket: "sbtilastot.appspot.com", messagingSenderId: "1056099775207", appId: "1:1056099775207:web:6dc886fb56b71f708fe842" };
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); 
                auth = getAuth(app);

                // Käyttäjän alkuperäinen offline-tuki
                try { 
                    await enableIndexedDbPersistence(db); 
                    console.log("Firestore offline-tuki käytössä.");
                } catch (err) {
                    if (err.code == 'failed-precondition') {
                        console.warn("Offline-tuki epäonnistui (failed-precondition), todennäköisesti jo auki toisessa välilehdessä.");
                    } else if (err.code == 'unimplemented') {
                        console.log("Offline-tuki ei ole tuettu tässä selaimessa.");
                    }
                }

                // Kuuntele kirjautumisen tilaa (kuten käyttäjän alkuperäisessä koodissa)
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userEmailDisplay.textContent = user.email || 'Kirjautunut'; 
                        
                        const savedGameJSON = sessionStorage.getItem(`inProgressGame-${userId}`);
                        if (savedGameJSON) {
                            console.log("Ladataan kesken ollut peli selaimen muistista...");
                            currentGame = JSON.parse(savedGameJSON);
                            currentTeamId = currentGame.teamId;
                            teamNameHeader.textContent = currentGame.teamName;
                            await loadRosterFromFirestore(); 
                            listenForGames(); 
                            showMainView('app');
                            initializeGameUI();
                            addEventListeners();
                            showView(currentGame.currentPeriod || 1);
                        } else {
                            console.log("Ei kesken olevaa peliä, näytetään joukkueen valinta.");
                            listenForTeams(); 
                            showMainView('teams');
                        }
                    } else {
                        // Käyttäjä ei ole kirjautunut sisään
                        userId = null; 
                        currentTeamId = null; 
                        currentGame = {};
                        sessionStorage.clear(); 
                        if (gamesUnsubscribe) gamesUnsubscribe();
                        if (teamsUnsubscribe) teamsUnsubscribe();
                        showMainView('auth'); // Näytä kirjautumislomake
                    }
                });

            } catch (error) { 
                console.error("Firebase-alustus epäonnistui:", error);
                document.body.innerHTML = `<div class="p-8 text-center text-red-400">Yhteys epäonnistui: ${error.message}</div>`; 
            }
        }
        
        loginBtn.addEventListener('click', async () => {
<!-- ... olemassa oleva koodi ... -->
        createTeamBtn.addEventListener('click', async () => {
            const teamName = newTeamNameInput.value.trim();
            if (teamName && userId) {
                // KORJATTU: Palautettu alkuperäinen polku
                await addDoc(collection(db, 'users', userId, 'teams'), { name: teamName, createdAt: serverTimestamp() });
                newTeamNameInput.value = '';
            }
        });

        function listenForTeams() {
            if (!userId) return;
            if (teamsUnsubscribe) teamsUnsubscribe();
            // KORJATTU: Palautettu alkuperäinen polku
            teamsUnsubscribe = onSnapshot(query(collection(db, 'users', userId, 'teams')), (snap) => {
                renderTeamsList(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });
        }
        
        function renderTeamsList(teams) {
<!-- ... olemassa oleva koodi ... -->
        async function saveAndEndGameInFirestore() { 
            if (!userId || !currentTeamId || !currentGame.id || currentGame.isReadOnly) return; 
            try { 
                const gameToSave = { ...currentGame }; 
                delete gameToSave.id; 
                // KORJATTU: Palautettu alkuperäinen polku
                await addDoc(collection(db, 'users', userId, 'teams', currentTeamId, 'games'), gameToSave); 
                
                sessionStorage.removeItem(`inProgressGame-${userId}`); 
<!-- ... olemassa oleva koodi ... -->
        function listenForGames() { 
            if (!userId || !currentTeamId) return; 
            if(gamesUnsubscribe) gamesUnsubscribe(); 
            // KORJATTU: Palautettu alkuperäinen polku
            const q = query(collection(db, 'users', userId, 'teams', currentTeamId, 'games')); 
            gamesUnsubscribe = onSnapshot(q, (snap) => { 
                seasonData.games = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
<!-- ... olemassa oleva koodi ... -->
        async function saveRosterToFirestore(roster) { 
            if (userId && currentTeamId) {
                // KORJATTU: Palautettu alkuperäinen polku
                await setDoc(doc(db, 'users', userId, 'teams', currentTeamId, 'roster', 'main'), { players: roster }); 
            }
        }
        
        async function loadRosterFromFirestore() { 
            if (!userId || !currentTeamId) return; 
            try { 
                // KORJATTU: Palautettu alkuperäinen polku
                const docSnap = await getDoc(doc(db, 'users', userId, 'teams', currentTeamId, 'roster', 'main')); 
                rosterData = docSnap.exists() ? docSnap.data().players || {} : {}; 
            } catch (error) {
<!-- ... olemassa oleva koodi ... -->
        async function deleteGameFromFirestore(gameId) { 
            if (userId && currentTeamId) {
                // KORJATTU: Palautettu alkuperäinen polku
                await deleteDoc(doc(db, 'users', userId, 'teams', currentTeamId, 'games', gameId)); 
            }
        }

        function prefillRosterInput() { playerRosterInput.value = Object.keys(rosterData).map(Number).sort((a,b)=>a-b).map(num => `${num} ${rosterData[num]||''}`).join('\n'); }
<!-- ... olemassa oleva koodi ... -->
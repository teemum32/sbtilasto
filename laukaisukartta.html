<!DOCTYPE html>
<html lang="fi" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https:;
                 connect-src 'self' https: wss:;
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data:;
                 worker-src 'self' blob:;
                 frame-src 'self' https:;
                 frame-ancestors 'self' https:;">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Floorball Shotmap</title>

  <!-- Social -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Floorball Shotmap">
  <meta property="og:description" content="Ottelukohtaiset laukaisukartat ja xG-raportit — PDF yhdellä napilla.">
  <meta property="og:image" content="/icon-1200x630.png">
  <meta property="og:url" content="/">
  <meta name="twitter:card" content="summary_large_image">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Arial,sans-serif;overflow:hidden;touch-action:pan-y;-webkit-user-select:none;user-select:none;background:#0f172a;color:#e2e8f0}
    .player-number{
      cursor:grab;width:40px;height:40px;border-radius:9999px;position:relative;font-weight:700;font-size:1rem;line-height:40px;border:2px solid #fff;background:#020617;color:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);touch-action:none;-webkit-text-size-adjust:100%
    }
    .player-number>span,.shot-marker>span{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:block;line-height:1;pointer-events:none
    }
    .away-player{font-size:1.2rem}
    .dragging{position:absolute;pointer-events:none;opacity:.7;z-index:1000}
    .shot-marker{position:absolute;width:40px;height:40px;border-radius:9999px;font-weight:700;font-size:1rem;box-shadow:0 1px 3px rgba(0,0,0,.4);color:#fff;transform:translate(-50%,-50%);transition:opacity .2s;cursor:pointer}
    .goal{background:#10B981}.miss{background:#3B82F6}.block{background:#FACC15;color:#111827}.save{background:#EF4444}
    .quality-high{outline:4px solid #b91c1c}.quality-low{outline:4px solid #2563eb}
    .action-modal{position:absolute;transform:translate(-50%,-50%);z-index:50;display:flex;flex-direction:column}
    .period-tab{padding:8px 16px;border-radius:6px;font-weight:600;transition:background-color .2s}
    .period-tab.active{background:#4f46e5}
  </style>
</head>
<body class="h-full">

  <!-- LOGIN -->
  <div id="login-view" class="h-full w-full flex items-center justify-center p-4">
    <div class="w-full max-w-sm bg-slate-800 p-8 rounded-lg shadow-xl text-center">
      <h1 class="text-2xl font-bold">Kirjaudu</h1>
      <input id="email-input" type="email" autocomplete="username"
             class="w-full p-3 mt-6 border bg-slate-700 border-slate-600 rounded-lg text-lg text-center"
             placeholder="nimi@topteamsalibandy.net">
      <input id="password-input" type="password" autocomplete="current-password"
             class="w-full p-3 mt-3 border bg-slate-700 border-slate-600 rounded-lg text-lg text-center"
             placeholder="Salasana">
      <p id="login-error" class="text-red-500 text-sm mt-2 h-5"></p>
      <button id="login-btn"
              class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">
        Kirjaudu sisään
      </button>
    </div>
  </div>

  <!-- LANDING -->
  <div id="landing-view" class="h-full w-full hidden items-center justify-center p-4">
    <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center">
      <h1 class="text-3xl font-bold">Floorball Shotmap</h1>

      <div class="mt-6 text-left">
        <label class="block text-sm text-slate-300 mb-1" for="team-select">Valitse joukkue</label>
        <select id="team-select" class="w-full p-3 border bg-slate-700 border-slate-600 rounded-lg text-sm"></select>
        <div class="text-xs text-slate-400 mt-1">Muistaa valinnan (localStorage).</div>
      </div>

      <div class="space-y-4 mt-6">
        <button id="start-new-game-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 font-bold py-3 px-4 rounded-lg">Aloita uusi ottelu</button>
        <button id="view-season-data-btn" class="w-full bg-slate-600 hover:bg-slate-700 font-bold py-3 px-4 rounded-lg disabled:opacity-50">Tarkastele kausidataa</button>
        <button id="logout-btn" class="w-full bg-slate-700 hover:bg-slate-600 font-bold py-3 px-4 rounded-lg">Kirjaudu ulos</button>
      </div>
    </div>
  </div>

  <!-- SETUP -->
  <div id="setup-view" class="h-full w-full hidden items-center justify-center p-4">
    <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center">
      <h1 class="text-3xl font-bold mb-4">Uusi ottelu</h1>

      <div class="text-left">
        <label class="block text-sm text-slate-300 mb-1" for="team-name-input">Joukkueen nimi</label>
        <input id="team-name-input" type="text" class="w-full p-3 border bg-slate-700 border-slate-600 rounded-lg text-sm" placeholder="Esim. Varta P19">
        <div class="text-xs text-slate-400 mt-1">Voit valita Landingista joukkueen ja muokata sitä tässä, tai kirjoittaa uuden nimen luodaksesi uuden joukkueen.</div>
      </div>

      <input id="opponent-name-input" type="text" class="w-full p-3 border bg-slate-700 border-slate-600 rounded-lg text-lg text-center my-4" placeholder="Vastustajan nimi">

      <textarea id="player-roster-input" class="w-full h-48 p-3 border bg-slate-700 border-slate-600 rounded-lg text-sm font-mono" placeholder="7 Matti Meikäläinen&#10;22 Maija Malli"></textarea>

      <p id="setup-error" class="text-red-500 text-sm mt-2 h-5"></p>
      <button id="start-button" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 font-bold py-3 px-4 rounded-lg">Aloita merkintä</button>
      <button id="back-to-landing-btn" class="mt-2 w-full text-slate-400 hover:text-slate-200 font-semibold py-2">Takaisin</button>
    </div>
  </div>

  <!-- APP -->
  <div id="app-container" class="h-full w-full hidden flex-col">
    <div id="period-tabs" class="bg-slate-800 p-2 flex justify-center gap-1 md:gap-2 shrink-0 flex-wrap">
      <button data-period="1" class="period-tab active">Erä 1</button>
      <button data-period="2" class="period-tab">Erä 2</button>
      <button data-period="3" class="period-tab">Erä 3</button>
      <button data-period="summary" class="period-tab">Ottelu</button>
      <button data-period="season" class="period-tab">Kausi</button>
    </div>

    <div class="flex-1 min-h-0 relative">
      <div id="main-app" class="absolute inset-0 grid grid-cols-1 md:grid-cols-[256px,1fr]">
        <aside class="bg-slate-900 p-4 flex flex-col overflow-y-auto order-last md:order-first">
          <h2 class="text-xl font-bold mb-4 text-center">Koti</h2>
          <div id="home-player-list" class="grid grid-cols-3 gap-3 mb-6"></div>

          <h2 class="text-xl font-bold mb-4 text-center">Vieras</h2>
          <div id="away-player-list" class="flex justify-center mb-6">
            <div class="player-number away-player"><span>V</span></div>
          </div>

          <div id="stats-container" class="border-t border-slate-700 pt-4"></div>
          <div id="player-stats-container" class="hidden border-t border-slate-700 pt-4 mt-4"></div>

          <button id="save-game-button" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-lg">Tallenna</button>
        </aside>

        <main class="flex items-center justify-center gap-4 p-4 bg-slate-200 min-w-0 order-first md:order-last">
          <div class="text-slate-500 font-bold text-lg -rotate-90">Vieras</div>
          <div id="field-container" class="relative w-full max-w-[1200px] aspect-[2/1] bg-white rounded-lg shadow-2xl border-2 border-slate-800">
            <svg class="w-full h-full" viewBox="0 0 400 200">
              <line x1="200" y1="0" x2="200" y2="200" stroke="#94a3b8" stroke-width="2"/>
              <rect x="30"  y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"/>
              <rect x="330" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"/>
            </svg>
            <div id="shots-layer" class="absolute inset-0"></div>
          </div>
          <div class="text-slate-500 font-bold text-lg rotate-90">Koti</div>
        </main>
      </div>

      <div id="season-view" class="absolute inset-0 hidden bg-slate-200 overflow-y-auto p-4"></div>
    </div>
  </div>

  <!-- Modals -->
  <div id="outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
  <div id="quality-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
  <div id="edit-outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
  <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc,
      onSnapshot, collection, query, writeBatch, getDocs, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIG
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDdqRwtwIat2t_qKYE9H3jmbVM1_EIvKy0",
      authDomain: "sbtilastot.firebaseapp.com",
      projectId: "sbtilastot",
      storageBucket: "sbtilastot.appspot.com",
      messagingSenderId: "1056099775207",
      appId: "1:1056099775207:web:6dc886fb56b71f708fe842"
    };
    const ALLOWED_EMAIL_DOMAIN = "topteamsalibandy.net";

    // --- Views
    const V = {
      login:   document.getElementById('login-view'),
      landing: document.getElementById('landing-view'),
      setup:   document.getElementById('setup-view'),
      app:     document.getElementById('app-container'),
    };
    function showOnly(name){
      Object.values(V).forEach(v=>{v.classList.add('hidden'); v.classList.remove('flex');});
      V[name].classList.remove('hidden'); V[name].classList.add('flex');
    }

    // --- State
    let db, auth, userId;
    let seasonData = { games: [] };
    let rosterMap = {};
    let currentTeamName = null;
    let currentGame = {};
    let draggedElement = null, ghostElement = null, tempShotData = {}, shotToEditId = null;
    let gamesUnsubscribe = () => {};

    // --- Firebase
    async function startFirebase(){
      const app = initializeApp(FIREBASE_CONFIG);
      db = getFirestore(app);
      auth = getAuth(app);
      try { await enableIndexedDbPersistence(db); } catch(_) {}

      onAuthStateChanged(auth, async (user) => {
        if (user && isAllowedEmail(user.email)) {
          userId = user.uid;
          await loadRostersFromFirestore();
          listenForGames();
          populateTeamDropdown();
          const last = localStorage.getItem('lastTeamName');
          if (last && rosterMap[last]) { selectTeam(last); if (teamSelect.value !== last) teamSelect.value = last; }
          showOnly('landing');
        } else {
          userId = null;
          if (typeof gamesUnsubscribe === 'function') gamesUnsubscribe();
          showOnly('login');
        }
      });
    }

    // --- Auth
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');

    function isAllowedEmail(email){ return new RegExp(`@${ALLOWED_EMAIL_DOMAIN}$`, 'i').test(email || ''); }
    async function handleLogin(){
      loginError.textContent = '';
      const email = (emailInput.value || '').trim();
      const pass  = passwordInput.value;
      if (!email || !pass){ loginError.textContent = 'Syötä sähköposti ja salasana.'; return; }
      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        if (!isAllowedEmail(cred.user.email)) {
          await signOut(auth);
          throw new Error(`Vain @${ALLOWED_EMAIL_DOMAIN} -osoitteet sallittu.`);
        }
      } catch (e) { loginError.textContent = e.message || 'Kirjautuminen epäonnistui.'; }
    }
    loginBtn.addEventListener('click', handleLogin);
    passwordInput.addEventListener('keypress', e => e.key==='Enter' && handleLogin());
    emailInput.addEventListener('keypress', e => e.key==='Enter' && handleLogin());
    document.getElementById('logout-btn').addEventListener('click', ()=>signOut(auth));

    // --- Firestore helpers
    const userBase  = () => doc(db, 'artifacts', 'default-app-id', 'users', userId);
    const gamesCol  = () => collection(userBase(), 'games');
    const rostersCol= () => collection(userBase(), 'roster');

    async function saveRosterToFirestore(teamName, playersObj){
      if (!userId || !teamName) return;
      await setDoc(doc(rostersCol(), teamName), { players: playersObj }, { merge:true });
    }

    // LUE rosterit; jos tyhjää -> nosta viimeisimmästä pelistä
    async function loadRostersFromFirestore() {
      rosterMap = {};
      if (!userId) return;

      try {
        // 1) varsinaiset roster-dokumentit
        const subSnap = await getDocs(rostersCol());
        subSnap.forEach(d => {
          const data = d.data() || {};
          if (data.players) rosterMap[d.id] = { players: data.players };
        });

        // 2) vanha 'roster/main'
        const mainSnap = await getDoc(doc(userBase(), 'roster', 'main'));
        if (mainSnap.exists()) {
          const data = mainSnap.data() || {};
          if (data.players && !rosterMap['main']) {
            rosterMap['main'] = { players: data.players };
          }
        }

        // 3) jos edelleen tyhjää -> nosta uusin peli
        if (!Object.keys(rosterMap).length) {
          const gSnap = await getDocs(gamesCol());
          const games = [];
          gSnap.forEach(d => games.push({ id: d.id, ...d.data() }));
          if (games.length) {
            games.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            const latest = games[0];

            let playersObj = latest.roster || null;
            if (!playersObj && Array.isArray(latest.players)) {
              playersObj = {};
              latest.players.forEach(n => { playersObj[n] = ''; });
            }
            if (playersObj && Object.keys(playersObj).length) {
              rosterMap['main'] = { players: playersObj };
            }
          }
        }

        console.log('Rosterit ladattu:', Object.keys(rosterMap));
      } catch (err) {
        console.error('Rosterin lataus epäonnistui:', err);
      }
    }

    function listenForGames(){
      if (!userId) return;
      gamesUnsubscribe();
      const qy = query(gamesCol());
      gamesUnsubscribe = onSnapshot(qy, (snap)=>{
        seasonData.games = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        document.getElementById('view-season-data-btn').disabled = seasonData.games.length === 0;
        if (!document.getElementById('season-view').classList.contains('hidden')) renderSeasonStats();
      });
    }
    async function addGameToFirestore(game){ const toSave = { ...game }; delete toSave.id; await addDoc(gamesCol(), toSave); }
    async function deleteGameFromFirestore(id){ await deleteDoc(doc(gamesCol(), id)); }

    // --- Team dropdown
    const teamSelect = document.getElementById('team-select');

    function populateTeamDropdown() {
      teamSelect.innerHTML = '';

      const createOpt = document.createElement('option');
      createOpt.value = '__new__';
      createOpt.textContent = '➕ Luo uusi joukkue…';
      teamSelect.appendChild(createOpt);

      const names = Object.keys(rosterMap).sort((a,b)=>a.localeCompare(b,'fi'));
      names.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        teamSelect.appendChild(opt);
      });

      if (!names.length) return;
      const last = localStorage.getItem('lastTeamName');
      const sel = (last && rosterMap[last]) ? last : names[0];
      selectTeam(sel); teamSelect.value = sel;
    }

    function selectTeam(name){
      if (!name || name === '__new__') return;
      currentTeamName = name;
      localStorage.setItem('lastTeamName', name);
    }

    teamSelect.addEventListener('change', () => {
      if (teamSelect.value === '__new__') {
        showOnly('setup');
        document.getElementById('team-name-input').value = '';
        document.getElementById('player-roster-input').value = '';
        return;
      }
      selectTeam(teamSelect.value);
    });

    // --- Nav
    document.getElementById('start-new-game-btn').addEventListener('click', ()=>{
      const selected = teamSelect.value;
      showOnly('setup');
      if (selected && selected !== '__new__' && rosterMap[selected]) {
        document.getElementById('team-name-input').value = selected;
        const players = rosterMap[selected].players || {};
        document.getElementById('player-roster-input').value =
          Object.keys(players).map(Number).sort((a,b)=>a-b).map(n => `${n} ${players[n]||''}`).join('\n');
      } else {
        document.getElementById('team-name-input').value = '';
        document.getElementById('player-roster-input').value = '';
      }
    });

    document.getElementById('view-season-data-btn').addEventListener('click', ()=>{ showOnly('app'); showView('season'); });
    document.getElementById('back-to-landing-btn').addEventListener('click', ()=> showOnly('landing'));

    // --- Start game
    document.getElementById('start-button').addEventListener('click', async ()=>{
      const setupError = document.getElementById('setup-error');
      setupError.textContent = '';
      const teamName = document.getElementById('team-name-input').value.trim();
      const opponent = document.getElementById('opponent-name-input').value.trim();
      const lines = document.getElementById('player-roster-input').value.split('\n').map(l=>l.trim()).filter(Boolean);
      if (!teamName){ setupError.textContent = 'Syötä joukkueen nimi.'; return; }
      if (!opponent){ setupError.textContent = 'Syötä vastustajan nimi.'; return; }
      if (!lines.length){ setupError.textContent = 'Syötä vähintään yksi pelaaja (numero ja nimi).'; return; }

      const playersObj = {};
      for (const line of lines){
        const m = line.match(/^(\d{1,3})\s*(.*)$/);
        if (!m){ setupError.textContent = 'Virheellinen rivi: ' + line; return; }
        playersObj[Number(m[1])] = (m[2]||'').trim();
      }

      await saveRosterToFirestore(teamName, playersObj);
      rosterMap[teamName] = { players: playersObj };
      selectTeam(teamName);

      startNewGame(teamName, playersObj, opponent);
      showOnly('app');
    });

    function startNewGame(teamName, playersObj, opponent){
      document.getElementById('shots-layer').innerHTML = '';
      const players = Object.keys(playersObj).map(Number).sort((a,b)=>a-b);
      currentGame = {
        date: new Date().toISOString(),
        teamName,
        opponent,
        players,
        roster: playersObj,
        shots: [],
        plusMinus: {}
      };
      players.forEach(p => currentGame.plusMinus[p] = { plus:0, minus:0 });
      initializePlayers(playersObj);
      bindGameListeners();
      showView(1);
    }

    function initializePlayers(playersObj){
      const home = document.getElementById('home-player-list');
      const away = document.getElementById('away-player-list');
      home.innerHTML=''; away.innerHTML='';
      const v = document.createElement('div');
      v.className='player-number away-player';
      v.innerHTML = `<span>V</span>`;
      away.appendChild(v);
      (Object.keys(playersObj).map(Number).sort((a,b)=>a-b)).forEach(num=>{
        const el = document.createElement('div');
        el.className = 'player-number';
        el.innerHTML = `<span>${num}</span>`;
        el.title = playersObj[num] || '';
        home.appendChild(el);
      });
    }

    // --- Periods & shots
    function showView(viewId){
      document.querySelectorAll('.period-tab').forEach(t=>t.classList.remove('active'));
      document.querySelector(`.period-tab[data-period="${viewId}"]`)?.classList.add('active');
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('season-view').classList.add('hidden');
      if (viewId === 'season'){
        renderSeasonStats();
        document.getElementById('season-view').classList.remove('hidden');
      } else {
        document.getElementById('main-app').classList.remove('hidden');
        currentGame.currentPeriod = isNaN(viewId) ? viewId : parseInt(viewId,10);
        renderShots(); updateStats();
      }
    }
    document.getElementById('period-tabs').addEventListener('click', (e)=>{
      const b = e.target.closest('.period-tab'); if (b) showView(b.dataset.period);
    });

    function bindGameListeners(){
      ['home-player-list','away-player-list'].forEach(id=>document.getElementById(id).addEventListener('pointerdown', onPointerDown, { passive:false }));
      document.addEventListener('pointermove', onPointerMove, { passive:false });
      document.addEventListener('pointerup', onPointerUp);
      document.getElementById('shots-layer').addEventListener('click', onShotMarkerClick);
      document.getElementById('save-game-button').addEventListener('click', ()=> showConfirm('Tallenna ottelu?', 'Tallennetaanko ottelu kausidataan?', 'Kyllä, tallenna', 'bg-blue-600', saveAndEndGame));
      document.getElementById('outcome-modal').addEventListener('click', onOutcomeSelect);
      document.getElementById('quality-modal').addEventListener('click', onQualitySelect);
      document.getElementById('edit-outcome-modal').addEventListener('click', onEditOutcomeSelect);
    }

    function onPointerDown(e){ const t=e.target.closest('.player-number'); if(!t) return; draggedElement=t; ghostElement=t.cloneNode(true); ghostElement.classList.add('dragging'); document.body.appendChild(ghostElement); updateGhost(e.pageX,e.pageY); }
    function onPointerMove(e){ if(!ghostElement) return; e.preventDefault(); updateGhost(e.pageX,e.pageY); }
    function onPointerUp(e){
      if(!draggedElement||!ghostElement) return;
      ghostElement.style.display='none'; const drop=document.elementFromPoint(e.clientX,e.clientY); ghostElement.style.display='';
      const field=document.getElementById('field-container');
      if(field && field.contains(drop)){
        const rect=document.getElementById('shots-layer').getBoundingClientRect();
        const x=((e.clientX-rect.left)/rect.width)*100, y=((e.clientY-rect.top)/rect.height)*100;
        const isAway = draggedElement.classList.contains('away-player');
        const labelText = (draggedElement.textContent || draggedElement.innerText || 'V').trim();
        tempShotData={ player: labelText, team: isAway ? 'away' : 'home', x, y, cx:e.clientX, cy:e.clientY };
        showOutcomeModal(e.clientX,e.clientY);
      }
      document.body.removeChild(ghostElement); ghostElement=null; draggedElement=null;
    }
    function updateGhost(x,y){ if(ghostElement){ ghostElement.style.left=`${x-20}px`; ghostElement.style.top=`${y-20}px`; } }

    function showOutcomeModal(x,y){ const m=document.getElementById('outcome-modal'); hideEditOutcomeModal(); hideQualityModal(false); m.style.left=`${x}px`; m.style.top=`${y}px`; m.classList.remove('hidden'); m.innerHTML=`
      <button data-outcome="goal" class="w-28 text-white font-semibold py-2 rounded-md bg-emerald-500">Maali</button>
      <button data-outcome="miss" class="w-28 text-white font-semibold py-2 rounded-md bg-blue-500">Ohi</button>
      <button data-outcome="block" class="w-28 text-slate-800 font-semibold py-2 rounded-md bg-yellow-400">Blokki</button>
      <button data-outcome="save" class="w-28 text-white font-semibold py-2 rounded-md bg-red-500">Torjunta</button>`; }
    function hideOutcomeModal(){ document.getElementById('outcome-modal').classList.add('hidden'); }
    function onOutcomeSelect(e){ const b=e.target.closest('[data-outcome]'); if(!b) return; tempShotData.outcome=b.dataset.outcome; hideOutcomeModal(); showQualityModal(tempShotData.cx,tempShotData.cy); }
    function showQualityModal(x,y){ const m=document.getElementById('quality-modal'); m.style.left=`${x}px`; m.style.top=`${y}px`; m.classList.remove('hidden'); m.innerHTML=`
      <button data-quality="high" class="w-28 text-white font-semibold py-2 px-4 rounded-md bg-red-700">Laadukas</button>
      <button data-quality="low"  class="w-28 text-white font-semibold py-2 px-4 rounded-md bg-blue-700">Heikko</button>`; }
    function hideQualityModal(clear=true){ const m=document.getElementById('quality-modal'); m.classList.add('hidden'); if(clear) tempShotData={}; }
    function onQualitySelect(e){
      const b=e.target.closest('[data-quality]'); if(!b) return;
      const s={ id:Date.now()+Math.random(), ...tempShotData, quality:b.dataset.quality, period: currentGame.currentPeriod||1,
        xG: calculateXg(tempShotData.x,tempShotData.y,tempShotData.team,b.dataset.quality) };
      delete s.cx; delete s.cy; currentGame.shots.push(s); hideQualityModal(); renderShots(); updateStats();
    }

    function onShotMarkerClick(e){
      const t=e.target.closest('.shot-marker'); if(!t){ hideEditOutcomeModal(); return; }
      shotToEditId=Number(t.dataset.shotId);
      const m=document.getElementById('edit-outcome-modal'); m.style.left=`${e.clientX}px`; m.style.top=`${e.clientY}px`; m.classList.remove('hidden');
      m.innerHTML=`
        <button data-outcome="goal" class="w-32 text-white font-semibold py-2 rounded-md bg-emerald-500">Maali</button>
        <button data-outcome="miss" class="w-32 text-white font-semibold py-2 rounded-md bg-blue-500">Ohi</button>
        <button data-outcome="block" class="w-32 text-slate-800 font-semibold py-2 rounded-md bg-yellow-400">Blokki</button>
        <button data-outcome="save" class="w-32 text-white font-semibold py-2 rounded-md bg-red-500">Torjunta</button>
        <div class="border-t my-1"></div>
        <button id="delete-shot-btn" class="w-32 text-white font-semibold py-2 rounded-md bg-slate-600">Poista</button>`;
    }
    function hideEditOutcomeModal(){ document.getElementById('edit-outcome-modal').classList.add('hidden'); shotToEditId=null; }
    function onEditOutcomeSelect(e){
      if(!shotToEditId) return;
      const i=currentGame.shots.findIndex(s=>s.id===shotToEditId); if(i===-1) return;
      if(e.target.id==='delete-shot-btn'){ currentGame.shots.splice(i,1); }
      else if(e.target.closest('[data-outcome]')){ currentGame.shots[i].outcome=e.target.dataset.outcome; }
      hideEditOutcomeModal(); renderShots(); updateStats();
    }

    function createShotMarker(s){
      const d = document.createElement('div');
      d.className = `shot-marker ${s.outcome}`;
      if(s.quality==='high') d.classList.add('quality-high');
      if(s.quality==='low')  d.classList.add('quality-low');
      d.dataset.shotId = s.id;
      d.style.left = `${s.x}%`;
      d.style.top  = `${s.y}%`;
      d.innerHTML = `<span>${s.player}</span>`;
      return d;
    }
    function renderShots(){
      const layer=document.getElementById('shots-layer');
      layer.innerHTML='';
      (currentGame.shots||[]).filter(s=> currentGame.currentPeriod==='summary' ? true : s.period===currentGame.currentPeriod).forEach(s=>layer.appendChild(createShotMarker(s)));
    }

    // --- Joukkueen tulkinta (robusti)
    function normalizeSideFromShot(sh) {
      const t = String(sh.team || '').trim().toLowerCase();
      if (t === 'away' || t === 'vieras') return 'away';
      if (t === 'home' || t === 'koti')   return 'home';
      if (String(sh.player).toUpperCase() === 'V') return 'away';
      return 'home';
    }

    function updateStats(){
      if(!currentGame?.shots) return;
      let stats={ home:{goals:0,shots:0,xg:0,saves:0,blocks:0,qualityHigh:0,qualityLow:0 },
                  away:{goals:0,shots:0,xg:0,saves:0,blocks:0,qualityHigh:0,qualityLow:0 }};
      const set=(currentGame.shots||[]).filter(s=> currentGame.currentPeriod==='summary' ? true : s.period===currentGame.currentPeriod);
      set.forEach(shot=>{
        const side = normalizeSideFromShot(shot);
        const opponent = side === 'home' ? 'away' : 'home';
        stats[side].shots++; stats[side].xg += Number(shot.xG)||0;
        if(shot.outcome==='goal') stats[side].goals++;
        if(shot.outcome==='save') stats[opponent].saves++;
        if(shot.outcome==='block') stats[opponent].blocks++;
        if(shot.quality==='high') stats[side].qualityHigh++;
        if(shot.quality==='low')  stats[side].qualityLow++;
      });
      document.getElementById('stats-container').innerHTML=`
        <h3 class="text-lg font-bold text-center mb-3">${currentGame.currentPeriod==='summary'?'Koko ottelu':`Erä ${currentGame.currentPeriod}`}</h3>
        <div class="space-y-4">
          <div>
            <div class="flex justify-between font-semibold"><span>Koti</span></div>
            <div class="flex justify-between text-sm mt-1"><span>Maalit: ${stats.home.goals}</span><span>Laukaukset: ${stats.home.shots}</span></div>
            <div class="flex justify-between text-sm"><span>xG: ${stats.home.xg.toFixed(2)}</span><span>L+: ${stats.home.qualityHigh} / H-: ${stats.home.qualityLow}</span></div>
            <div class="flex justify-between text-sm mt-1 border-t pt-1"><span>Torjunnat: ${stats.home.saves}</span><span>Blokit: ${stats.home.blocks}</span></div>
          </div>
          <div>
            <div class="flex justify-between font-semibold"><span>Vieras</span></div>
            <div class="flex justify-between text-sm mt-1"><span>Maalit: ${stats.away.goals}</span><span>Laukaukset: ${stats.away.shots}</span></div>
            <div class="flex justify-between text-sm"><span>xG: ${stats.away.xg.toFixed(2)}</span><span>L+: ${stats.away.qualityHigh} / H-: ${stats.away.qualityLow}</span></div>
            <div class="flex justify-between text-sm mt-1 border-t pt-1"><span>Torjunnat: ${stats.away.saves}</span><span>Blokit: ${stats.away.blocks}</span></div>
          </div>
        </div>`;
      const box=document.getElementById('player-stats-container');
      box.classList.toggle('hidden', currentGame.currentPeriod!=='summary');
      if(currentGame.currentPeriod==='summary') updatePlayerStats();
    }
    function updatePlayerStats(){
      const box=document.getElementById('player-stats-container');
      let html=`<h3 class="text-lg font-bold text-center mb-3">Pelaajatilastot</h3>
      <div class="grid grid-cols-7 text-center font-semibold text-xs text-slate-400 mb-2 px-1"><span class="col-span-2">Pelaaja</span><span>L</span><span>M</span><span>L+</span><span>H-</span><span>+/-</span></div>`;
      (currentGame.players||[]).forEach(pNum=>{
        const shots=(currentGame.shots||[]).filter(s=>normalizeSideFromShot(s)==='home'&&s.player==pNum);
        const goals=shots.filter(s=>s.outcome==='goal').length;
        const qH=shots.filter(s=>s.quality==='high').length;
        const qL=shots.filter(s=>s.quality==='low').length;
        const pm=currentGame.plusMinus[pNum]||{plus:0,minus:0};
        if(shots.length>0||pm.plus>0||pm.minus>0){
          const bal=pm.plus-pm.minus; const name=(currentGame.roster[pNum]||'').split(' ')[0]||'';
          html+=`<div class="grid grid-cols-7 text-center text-sm py-1 border-b border-slate-700 items-center">
            <span class="font-bold text-left col-span-2 truncate">#${pNum} ${name}</span>
            <span>${shots.length}</span><span>${goals}</span>
            <span class="text-red-400 font-semibold">${qH}</span>
            <span class="text-blue-400 font-semibold">${qL}</span>
            <span class="font-semibold">${bal>0?'+':''}${bal}</span></div>`;
        }
      }); box.innerHTML=html;
    }

    // --- xG (fysiikka/matematiikka)
    function clamp01(v){ return Math.max(0, Math.min(1, v)); }
    function calculateXg(xPct, yPct, team, quality){
      const x = clamp01(xPct/100), y = clamp01(yPct/100);
      const goalYTop = 0.40, goalYBot = 0.60;
      const goalX = (String(team).toLowerCase()==='home') ? 1.0 : 0.0;
      const thetaTop = Math.atan2(goalYTop - y, goalX - x);
      const thetaBot = Math.atan2(goalYBot - y, goalX - x);
      const angle = Math.abs(thetaTop - thetaBot);
      const dx = goalX - x, dy = 0.5 - y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      const proximity = 1 - clamp01(dist / 1.2);
      const angleNorm = clamp01(angle / Math.PI);
      const z =  -1.6 + 3.8*proximity + 2.2*angleNorm;
      let xg = 1/(1+Math.exp(-z));
      if (quality === 'high') xg *= 1.15;
      if (quality === 'low')  xg *= 0.90;
      xg = Math.max(0.02, Math.min(0.85, xg));
      return Number(xg.toFixed(2));
    }

    // --- Season view
    function safeDateValue(game){ if(game?.date){ const d=new Date(game.date); if(!isNaN(+d)) return +d; } return Date.now(); }
    function getGameStats(game){
      const s={home:{goals:0,shots:0,xg:0,saves:0,blocks:0,qualityHigh:0,qualityLow:0},
               away:{goals:0,shots:0,xg:0,saves:0,blocks:0,qualityHigh:0,qualityLow:0}};
      (game.shots||[]).forEach(sh=>{
        const side = normalizeSideFromShot(sh);
        const opp  = side === 'home' ? 'away' : 'home';
        s[side].shots++; s[side].xg += Number(sh.xG)||0;
        if(sh.outcome==='goal') s[side].goals++;
        if(sh.outcome==='save') s[opp].saves++;
        if(sh.outcome==='block') s[opp].blocks++;
        if(sh.quality==='high') s[side].qualityHigh++;
        if(sh.quality==='low')  s[side].qualityLow++;
      });
      return s;
    }

    function renderSeasonStats(){
      const sv=document.getElementById('season-view');
      const games=(seasonData.games||[]).slice().sort((a,b)=>safeDateValue(b)-safeDateValue(a));
      let html=`<div class="w-full max-w-4xl mx-auto">
        <h3 class="text-xl font-bold text-slate-800 mb-4">Tallennetut ottelut</h3>`;
      if(games.length){
        games.forEach(g=>{
          const s=getGameStats(g); const d=new Date(safeDateValue(g)).toLocaleDateString('fi-FI');
          const rosterList = g.roster ? Object.keys(g.roster).map(n=>`#${n} ${g.roster[n]}`).join(', ') : '';
          html+=`<details class="bg-white rounded-lg shadow mb-3">
            <summary class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between p-3 font-semibold text-slate-800">
              <div>
                <p class="font-bold">${d} • ${g.teamName ? g.teamName+' ' : ''}vs ${g.opponent||''}</p>
                <p class="text-sm text-slate-600">Tulos: ${s.home.goals} - ${s.away.goals}</p>
                ${rosterList ? `<p class="text-xs text-slate-500">Roster: ${rosterList}</p>` : ``}
              </div>
              <div class="flex gap-2">
                <button data-game-id="${g.id}" class="generate-pdf-btn bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold py-2 px-3 rounded">Luo PDF-raportti</button>
                <button data-game-id="${g.id}" class="delete-game-btn bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-2 px-3 rounded">Poista</button>
              </div>
            </summary>
            <div class="p-3 text-sm text-slate-700">
              <div><b>Koti:</b> L ${s.home.shots}, xG ${s.home.xg.toFixed(2)}, L+ ${s.home.qualityHigh}, H- ${s.home.qualityLow}, T ${s.home.saves}, B ${s.home.blocks}</div>
              <div><b>Vieras:</b> L ${s.away.shots}, xG ${s.away.xg.toFixed(2)}, L+ ${s.away.qualityHigh}, H- ${s.away.qualityLow}, T ${s.away.saves}, B ${s.away.blocks}</div>
            </div>
          </details>`;
        });
      } else {
        html+=`<div class="text-slate-700">Ei tallennettuja otteluita.</div>`;
      }
      html+='</div>';
      sv.innerHTML=html;

      sv.onclick=(e)=>{
        const del=e.target.closest('.delete-game-btn'); const pdf=e.target.closest('.generate-pdf-btn');
        if(del){ e.preventDefault(); deleteGameFromFirestore(del.dataset.gameId); }
        if(pdf){
          e.preventDefault();
          const id=pdf.dataset.gameId; const game=(seasonData.games||[]).find(g=>g.id===id);
          if(game) generatePdfReportDOM(game);
        }
      };
    }

    async function saveAndEndGame(){ const g={...currentGame}; await addGameToFirestore(g); showView('season'); }

    // --- PDF helpers
    function callAutoTable(doc, opts){ if(window.jspdfAutoTable) return window.jspdfAutoTable(doc,opts); if(doc.autoTable) return doc.autoTable(opts); throw new Error('AutoTable-plugin ei ole ladattu'); }

    function getStatsForPeriod(game, period) {
      const rows = (game?.shots || []).filter(s => period === 'summary' ? true : s.period === period);
      const S = () => ({ goals:0, shots:0, xg:0, saves:0, blocks:0, qualityHigh:0, qualityLow:0 });
      const out = { home: S(), away: S() };

      rows.forEach(sh => {
        const side = normalizeSideFromShot(sh);
        const opp  = side === 'home' ? 'away' : 'home';

        out[side].shots += 1;
        out[side].xg    += Number(sh.xG) || 0;

        if (sh.outcome === 'goal')  out[side].goals  += 1;
        if (sh.outcome === 'save')  out[opp].saves   += 1;
        if (sh.outcome === 'block') out[opp].blocks  += 1;

        if (sh.quality === 'high') out[side].qualityHigh += 1;
        if (sh.quality === 'low')  out[side].qualityLow  += 1;
      });

      ['home','away'].forEach(side => {
        Object.keys(out[side]).forEach(k => { out[side][k] = Number(out[side][k]) || 0; });
      });

      return out;
    }

    function createShotmapElement(game, period){
      const shots=(game?.shots||[]).filter(s=> period==='summary'?true:s.period===period);
      const W=900,H=450;
      const wrap=document.createElement('div'); Object.assign(wrap.style,{position:'fixed',left:'-10000px',top:'0',width:`${W}px`,height:`${H}px`,background:'#fff',borderRadius:'12px',boxShadow:'0 10px 30px rgba(0,0,0,.2)',overflow:'hidden',zIndex:'-1'});
      const field=document.createElement('div'); Object.assign(field.style,{position:'relative',width:'100%',height:'100%'}); field.innerHTML=`
        <svg width="${W}" height="${H}" viewBox="0 0 400 200" style="position:absolute;inset:0">
          <rect x="0" y="0" width="400" height="200" fill="#ffffff" stroke="#1f2937" stroke-width="3"/>
          <line x1="200" y1="0" x2="200" y2="200" stroke="#94a3b8" stroke-width="2"/>
          <rect x="30"  y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"/>
          <rect x="330" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"/>
        </svg>`; wrap.appendChild(field);
      const layer=document.createElement('div'); Object.assign(layer.style,{position:'absolute',inset:'0'}); field.appendChild(layer);
      const COLORS={goal:'#10B981',miss:'#3B82F6',block:'#FACC15',save:'#EF4444'};
      shots.forEach(s=>{
        const leftPx=Math.max(0,Math.min(W,(s.x/100)*W));
        const topPx =Math.max(0,Math.min(H,(s.y/100)*H));
        const dot=document.createElement('div');
        dot.innerHTML = `<span>${s.player}</span>`;
        Object.assign(dot.style,{
          position:'absolute', width:'34px', height:'34px',
          textAlign:'center', fontWeight:'700', color:'#fff', borderRadius:'9999px', boxShadow:'0 3px 8px rgba(0,0,0,.3)',
          transform:'translate(-50%, -50%)', left:`${leftPx}px`, top:`${topPx}px`,
          background:COLORS[s.outcome]||'#111827'
        });
        if(s.quality==='high') dot.style.outline='4px solid #b91c1c';
        if(s.quality==='low')  dot.style.outline='4px solid #2563eb';
        const span = dot.querySelector('span');
        Object.assign(span.style, { position:'absolute', left:'50%', top:'50%', transform:'translate(-50%,-50%)', lineHeight:'1', pointerEvents:'none' });
        layer.appendChild(dot);
      });
      return wrap;
    }

    function generatePlayerStatsForPdf(doc, game, startY=20){
      const rows=[]; const players=(game.players||[]).slice().sort((a,b)=>a-b);
      players.forEach(pNum=>{
        const shots=(game.shots||[]).filter(s=>normalizeSideFromShot(s)==='home'&&String(s.player)===String(pNum));
        const goals=shots.filter(s=>s.outcome==='goal').length;
        const qH=shots.filter(s=>s.quality==='high').length;
        const qL=shots.filter(s=>s.quality==='low').length;
        const pm=(game.plusMinus&&game.plusMinus[pNum])?game.plusMinus[pNum]:{plus:0,minus:0};
        const plusMinus=(pm.plus-pm.minus)>=0?`+${pm.plus-pm.minus}`:String(pm.plus-pm.minus);
        const name=(game.roster?.[pNum]||'').trim();
        const display=name?`#${pNum} ${name}`:`#${pNum}`;
        rows.push([display,shots.length,goals,qH,qL,plusMinus]);
      });
      callAutoTable(doc,{ startY, margin:{left:10,right:10}, tableWidth:doc.internal.pageSize.getWidth()-20, theme:'grid',
        head:[['Pelaaja','Lauk.','Maalit','L+','H-','+/-','T%']],
        body: rows.length ? rows.map(r=>{ const shots=r[1]||0, goals=r[2]||0; const pct=shots?Math.round((goals/shots)*100)+'%':'—'; return [r[0],r[1],r[2],r[3],r[4],r[5],pct]; }) : [['—',0,0,0,0,'0','—']],
        styles:{font:'helvetica',fontSize:10}, headStyles:{fillColor:[41,52,72],textColor:255},
        columnStyles:{0:{cellWidth:60},1:{cellWidth:20,halign:'right'},2:{cellWidth:20,halign:'right'},3:{cellWidth:18,halign:'right'},4:{cellWidth:18,halign:'right'},5:{cellWidth:22,halign:'right'},6:{cellWidth:22,halign:'right'}}
      });
    }

    async function generatePdfReportDOM(game){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });
      const margin=10, pageW=doc.internal.pageSize.getWidth(), pageH=doc.internal.pageSize.getHeight(); let yPos=margin;

      const dateStr=game.date?new Date(game.date).toLocaleDateString('fi-FI'):'';
      doc.setFont('helvetica','normal'); doc.setFontSize(18); doc.text(`Otteluraportti: ${game.teamName ? game.teamName+' ' : ''}vs ${game.opponent||''}`, pageW/2, yPos, {align:'center'}); yPos+=8; doc.setFontSize(12); doc.text(dateStr, pageW/2, yPos, {align:'center'}); yPos+=15;

      for (const period of [1,2,3,'summary']){
        const stats=getStatsForPeriod(game,period);
        const map=createShotmapElement(game,period); document.body.appendChild(map); await new Promise(r=>requestAnimationFrame(()=>r())); const canvas=await html2canvas(map,{scale:2,backgroundColor:'#ffffff',useCORS:true}); document.body.removeChild(map);

        const title=period==='summary'?'Koko ottelu':`Erä ${period}`;
        const imgData=canvas.toDataURL('image/png'); const imgMaxW=pageW-margin*2; const imgW=Math.min(180,imgMaxW); const imgH=imgW*(canvas.height/canvas.width); const approxTableH=62;
        if (yPos + 6 + imgH + approxTableH > pageH - margin){ doc.addPage(); yPos=margin; }

        doc.setFontSize(14); doc.text(title, margin, yPos); yPos+=6;
        const imgX=(pageW-imgW)/2; doc.addImage(imgData,'PNG',imgX,yPos,imgW,imgH); yPos+=imgH+8;

        callAutoTable(doc,{ startY:yPos, margin:{left:margin,right:margin}, tableWidth:pageW-margin*2, theme:'grid',
          head:[['Tapahtuma','Koti','Vieras']],
          body:[
            ['Maalit',stats.home.goals,stats.away.goals],
            ['Laukaukset',stats.home.shots,stats.away.shots],
            ['xG',stats.home.xg.toFixed(2),stats.away.xg.toFixed(2)],
            ['Laadukkaat (L+)',stats.home.qualityHigh,stats.away.qualityHigh],
            ['Heikot (H-)',stats.home.qualityLow,stats.away.qualityLow],
            ['Torjunnat',stats.home.saves,stats.away.saves],
            ['Blokit',stats.home.blocks,stats.away.blocks],
          ],
          styles:{font:'helvetica',fontSize:10}, headStyles:{fillColor:[41,52,72],textColor:255},
          columnStyles:{0:{cellWidth:110},1:{cellWidth:60,halign:'right'},2:{cellWidth:60,halign:'right'}}
        });
        yPos = (doc.lastAutoTable && doc.lastAutoTable.finalY ? doc.lastAutoTable.finalY : yPos) + 14;
      }

      doc.addPage(); yPos=margin; doc.setFontSize(16); doc.text('Pelaajakohtaiset tilastot (Koti)', pageW/2, yPos, {align:'center'}); yPos+=10;
      generatePlayerStatsForPdf(doc, game, yPos);

      const blobUrl = doc.output('bloburl'); window.location.assign(blobUrl);
    }

    // --- Confirm
    function showConfirm(title,text,btnText,btnClass,cb){
      const m=document.getElementById('confirm-modal');
      m.innerHTML=`<div class="bg-white rounded-lg shadow-xl p-6 max-w-sm text-center">
        <h3 class="text-xl font-bold text-slate-800 mb-4">${title}</h3>
        <p class="text-slate-600 mb-6">${text}</p>
        <div class="flex justify-center gap-4">
          <button id="cancel-confirm-btn" class="px-6 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 font-semibold">Peruuta</button>
          <button id="confirm-btn" class="px-6 py-2 rounded-lg text-white font-semibold ${btnClass}">${btnText}</button>
        </div></div>`;
      m.classList.remove('hidden');
      document.getElementById('cancel-confirm-btn').onclick=()=>m.classList.add('hidden');
      document.getElementById('confirm-btn').onclick=()=>{ m.classList.add('hidden'); cb(); };
    }

    // --- Go!
    startFirebase();
  </script>
</body>
</html>
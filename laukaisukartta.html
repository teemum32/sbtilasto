<!DOCTYPE html>
<html lang="fi" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Salibandyn Kausitilastot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: pan-y; -webkit-user-select: none; user-select: none; }
        .player-number { cursor: grab; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; border: 2px solid white; background-color: #020617; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); touch-action: none; }
        .away-player { font-size: 1.25rem; }
        .dragging { position: absolute; pointer-events: none; opacity: 0.7; z-index: 1000; }
        
        /* KORJATTU: Kiinteä line-height on varmin tapa pystysuuntaiseen keskitykseen */
        .shot-marker { 
            position: absolute; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            font-weight: 900; 
            font-size: 0.875rem; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.5); 
            transform: translate(-50%, -50%); 
            transition: opacity 0.2s; 
            cursor: pointer; 
            text-align: center;
            line-height: 36px; 
            display: block;
            padding: 0;
            overflow: hidden;
        }
        
        .goal { background-color: #10B981; color: #ffffff; } 
        .miss { background-color: #3B82F6; color: #ffffff; }
        .block { background-color: #FACC15; color: #000000; } 
        .save { background-color: #EF4444; color: #ffffff; }
        
        .quality-high { border: 3px solid #b91c1c; } 
        .quality-low { border: 2px solid rgba(255,255,255,0.9); }
        
        .action-modal { position: absolute; transform: translate(-50%, -50%); z-index: 50; display: flex; flex-direction: column; }
        .period-tab { padding: 8px 16px; border-radius: 6px; font-weight: 600; transition: background-color 0.2s; }
        .period-tab.active { background-color: #4f46e5; }

        details summary::-webkit-details-marker { display: none; }
        details summary { list-style: none; cursor: pointer; outline: none; }

        .sortable-header { cursor: pointer; transition: color 0.2s; }
        .sortable-header:hover { color: #818cf8; }
        .sort-icon { font-size: 0.7rem; margin-left: 2px; vertical-align: middle; }
    </style>
</head>
<body class="bg-slate-900 h-full text-slate-200">

    <!-- Auth View -->
    <div id="auth-view" class="h-full flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-slate-800 p-8 rounded-lg shadow-xl text-center border border-slate-700">
            <h1 class="text-2xl font-bold text-white">Kirjaudu sisään</h1>
            <div class="mt-6 space-y-4">
                <input id="email-input" type="email" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-center focus:outline-none focus:border-indigo-500" placeholder="Sähköposti">
                <input id="password-input" type="password" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-center focus:outline-none focus:border-indigo-500" placeholder="Salasana">
                <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded-lg font-bold transition-colors">Kirjaudu</button>
            </div>
            <p id="auth-error" class="text-red-500 text-sm mt-4 h-5"></p>
        </div>
    </div>
    
    <!-- Teams Selection -->
    <div id="teams-view" class="h-full hidden flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center border border-slate-700">
            <h1 class="text-2xl font-bold mb-6 text-white uppercase tracking-wider">Valitse joukkue</h1>
            <div id="teams-list" class="space-y-2 max-h-60 overflow-y-auto mb-6 px-2"></div>
            <div class="border-t border-slate-700 pt-6 px-2">
                <input id="new-team-name" type="text" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-center mb-2" placeholder="Uuden joukkueen nimi">
                <button id="create-team-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-bold">Luo joukkue</button>
            </div>
            <button id="logout-btn-teams" class="w-full mt-6 text-slate-400 font-semibold hover:text-white">Kirjaudu ulos</button>
        </div>
    </div>

    <!-- Landing View -->
    <div id="landing-view" class="h-full hidden flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center border border-slate-700">
            <h1 id="team-name-header" class="text-3xl font-bold text-white uppercase tracking-wide">Joukkue</h1>
            <div class="mt-8 space-y-4">
                <button id="start-new-game-btn" class="w-full bg-indigo-600 py-3 rounded-lg font-bold text-lg transition-transform active:scale-95">Uusi ottelu</button>
                <button id="view-season-data-btn" class="w-full bg-slate-600 py-3 rounded-lg font-bold text-lg transition-transform active:scale-95">Kausitilastot</button>
                <button id="change-team-btn" class="w-full border border-slate-600 hover:bg-slate-700 py-2 rounded-lg text-slate-400 mt-4">Vaihda joukkuetta</button>
                <button id="logout-btn" class="w-full text-red-400 py-2 mt-2 hover:underline">Kirjaudu ulos</button>
            </div>
        </div>
    </div>

    <!-- Setup View -->
    <div id="setup-view" class="h-full hidden flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center border border-slate-700">
            <h1 class="text-2xl font-bold mb-4 text-white">Uusi ottelu</h1>
            <input id="opponent-name-input" type="text" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-center mb-4 focus:border-indigo-500 outline-none" placeholder="Vastustaja">
            <textarea id="player-roster-input" class="w-full h-48 p-3 bg-slate-700 border border-slate-600 rounded-lg text-sm font-mono mb-4 focus:border-indigo-500 outline-none" placeholder="7 Matti, 10 Pekka..."></textarea>
            <p id="setup-error" class="text-red-500 text-sm mb-4 h-5"></p>
            <button id="start-button" class="w-full bg-indigo-600 py-3 rounded-lg font-bold">Aloita merkintä</button>
            <button id="back-to-landing-btn" class="mt-4 text-slate-400">Takaisin</button>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="h-full hidden flex-col">
        <div id="period-tabs" class="bg-slate-800 p-2 flex justify-center gap-1 shrink-0 flex-wrap border-b border-slate-700"></div>
        <div class="flex-1 min-h-0 relative">
            <div id="main-app" class="absolute inset-0 grid grid-cols-1 md:grid-cols-[256px,1fr]">
                <aside class="bg-slate-900 p-4 flex flex-col overflow-y-auto border-r border-slate-800">
                    <div id="sidebar-content"></div>
                    <button id="save-game-button" class="mt-auto w-full bg-blue-600 py-3 rounded-lg font-bold">Tallenna ottelu</button>
                </aside>
                <main class="flex items-center justify-center p-4 bg-slate-200 overflow-hidden">
                    <div id="field-area" class="w-full h-full flex items-center justify-center gap-4"></div>
                </main>
            </div>
            <div id="plus-minus-view" class="absolute inset-0 hidden bg-slate-900 overflow-y-auto p-4"></div>
            <div id="season-view" class="absolute inset-0 hidden bg-slate-900 overflow-y-auto p-4"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
    <div id="quality-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
    <div id="edit-outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000] p-4"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State
        let db, auth, userId, currentTeamId;
        let seasonData = { games: [] }, rosterData = {}, currentGame = {};
        let gamesUnsubscribe = () => {}, teamsUnsubscribe = () => {};
        let draggedElement = null, ghostElement = null, tempShotData = {}, shotToEditId = null;

        // Sorting State
        let seasonSort = { key: 'number', dir: 0 }; 
        let matchSort = { key: 'number', dir: 0 };

        const COLORS = { goal: '#10B981', miss: '#3B82F6', block: '#FACC15', save: '#EF4444' };
        const firebaseConfig = { apiKey: "AIzaSyDdqRwtwIat2t_qKYE9H3jmbVM1_EIvKy0", authDomain: "sbtilastot.firebaseapp.com", projectId: "sbtilastot", storageBucket: "sbtilastot.appspot.com", messagingSenderId: "1056099775207", appId: "1:1056099775207:web:6dc886fb56b71f708fe842" };

        function showMainView(viewKey) {
            const ids = ['auth-view', 'teams-view', 'landing-view', 'setup-view', 'app-container'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const targetId = { auth:'auth-view', teams:'teams-view', landing:'landing-view', setup:'setup-view', app:'app-container' }[viewKey];
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
                targetEl.classList.remove('hidden');
                if (viewKey === 'app') targetEl.classList.add('flex');
            }
            if (viewKey === 'landing') {
                document.getElementById('start-new-game-btn').textContent = (currentGame && currentGame.id) ? 'Jatka ottelua' : 'Uusi ottelu';
            }
        }

        async function initApp() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const saved = sessionStorage.getItem(`inProgressGame-${userId}`);
                    if (saved) {
                        currentGame = JSON.parse(saved);
                        currentTeamId = currentGame.teamId;
                        document.getElementById('team-name-header').textContent = currentGame.teamName;
                        initializeGameUI(); addEventListeners(); showMainView('app'); showView(1);
                    } else {
                        listenForTeams(); showMainView('teams');
                    }
                } else { showMainView('auth'); }
            });
        }

        function listenForTeams() {
            if (!userId) return;
            if (teamsUnsubscribe) teamsUnsubscribe();
            teamsUnsubscribe = onSnapshot(query(collection(db, 'users', userId, 'teams')), (snap) => {
                const list = document.getElementById('teams-list');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const team = { id: doc.id, ...doc.data() };
                    const btn = document.createElement('button');
                    btn.className = "w-full bg-slate-700 hover:bg-indigo-600 p-4 rounded-lg font-bold transition-colors";
                    btn.textContent = team.name;
                    btn.onclick = () => selectTeam(team);
                    list.appendChild(btn);
                });
            });
        }

        async function selectTeam(team) {
            currentTeamId = team.id;
            document.getElementById('team-name-header').textContent = team.name;
            const docSnap = await getDoc(doc(db, 'users', userId, 'teams', currentTeamId, 'roster', 'main'));
            rosterData = docSnap.exists() ? docSnap.data().players || {} : {};
            listenForGames(); showMainView('landing');
        }

        function listenForGames() {
            if (!userId || !currentTeamId) return;
            if (gamesUnsubscribe) gamesUnsubscribe();
            gamesUnsubscribe = onSnapshot(query(collection(db, 'users', userId, 'teams', currentTeamId, 'games')), (snap) => {
                seasonData.games = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (!document.getElementById('season-view').classList.contains('hidden')) renderSeasonStats();
            });
        }

        function initializeGameUI() {
            const tabs = document.getElementById('period-tabs');
            tabs.innerHTML = `<button data-period="home" class="period-tab">Koti</button><button data-period="1" class="period-tab active">Erä 1</button><button data-period="2" class="period-tab">Erä 2</button><button data-period="3" class="period-tab">Erä 3</button><button data-period="summary" class="period-tab">Ottelu</button><button data-period="plus-minus" class="period-tab">+/-</button><button data-period="season" class="period-tab">Kausi</button>`;
            document.getElementById('sidebar-content').innerHTML = `<div class="mb-6"><h2 class="text-center font-bold text-slate-400 mb-2 uppercase">Koti</h2><div id="home-player-list" class="grid grid-cols-3 gap-2"></div></div><div class="mb-6"><h2 class="text-center font-bold text-slate-400 mb-2 uppercase">Vieras</h2><div id="away-player-list" class="flex justify-center"></div></div><div id="stats-container" class="border-t border-slate-700 pt-4"></div><div id="player-stats-container" class="hidden border-t border-slate-700 pt-4 mt-4"></div>`;
            document.getElementById('field-area').innerHTML = `<div id="field-container" class="relative w-full max-w-[1000px] aspect-[2/1] bg-white rounded shadow-xl border-2 border-slate-400"><svg class="w-full h-full" viewBox="0 0 400 200"><line x1="200" y1="0" x2="200" y2="200" stroke="#cbd5e1" stroke-width="2"/><rect x="30" y="75" width="40" height="50" fill="none" stroke="#cbd5e1" stroke-width="2"/><rect x="330" y="75" width="40" height="50" fill="none" stroke="#cbd5e1" stroke-width="2"/></svg><div id="shots-layer" class="absolute inset-0"></div></div>`;
            initializePlayers();
        }

        function initializePlayers() {
            const homeList = document.getElementById('home-player-list'), awayList = document.getElementById('away-player-list');
            if (!homeList || !awayList) return;
            homeList.innerHTML = '';
            awayList.innerHTML = `<div class="player-number away-player bg-slate-600">V</div>`;
            (currentGame.players || []).forEach(num => {
                const div = document.createElement('div');
                div.className = 'player-number'; div.textContent = num;
                homeList.appendChild(div);
            });
        }

        function showView(viewId) {
            document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-period="${viewId}"]`)?.classList.add('active');
            const mainApp = document.getElementById('main-app'), pmView = document.getElementById('plus-minus-view'), seasonView = document.getElementById('season-view');
            [mainApp, pmView, seasonView].forEach(s => s.classList.add('hidden'));

            if (viewId === 'home') { showMainView('landing'); return; }
            if (viewId === 'plus-minus') { renderPlusMinusView(); pmView.classList.remove('hidden'); }
            else if (viewId === 'season') { renderSeasonStats(); seasonView.classList.remove('hidden'); }
            else { 
                currentGame.currentPeriod = isNaN(viewId) ? viewId : parseInt(viewId);
                mainApp.classList.remove('hidden');
                renderShots(); updateStats();
            }
        }

        function addEventListeners() {
            document.getElementById('period-tabs').onclick = (e) => { const btn = e.target.closest('.period-tab'); if (btn) showView(btn.dataset.period); };
            document.getElementById('save-game-button').onclick = () => { showConfirmation('Tallenna ottelu?', 'Peliä ei voi enää muokata.', 'Tallenna', 'bg-blue-600', saveGame); };
            ['home-player-list', 'away-player-list'].forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('pointerdown', onPointerDown); });
            document.body.addEventListener('pointermove', onPointerMove);
            document.body.addEventListener('pointerup', onPointerUp);
            document.getElementById('shots-layer').addEventListener('click', onShotClick);
            document.getElementById('outcome-modal').onclick = onOutcomeSelect;
            document.getElementById('quality-modal').onclick = onQualitySelect;
            document.getElementById('edit-outcome-modal').onclick = onEditSelect;
        }

        function onPointerDown(e) {
            const target = e.target.closest('.player-number');
            if (!target || currentGame.isReadOnly) return;
            draggedElement = target;
            ghostElement = target.cloneNode(true);
            ghostElement.classList.add('dragging');
            document.body.appendChild(ghostElement);
            updateGhost(e.pageX, e.pageY);
        }
        function onPointerMove(e) { if (ghostElement) updateGhost(e.pageX, e.pageY); }
        function onPointerUp(e) {
            if (!ghostElement) return;
            ghostElement.style.display = 'none';
            const drop = document.elementFromPoint(e.clientX, e.clientY);
            ghostElement.style.display = '';
            const field = document.getElementById('field-container');
            if (field && field.contains(drop)) {
                const rect = document.getElementById('shots-layer').getBoundingClientRect();
                tempShotData = {
                    player: draggedElement.textContent,
                    team: draggedElement.classList.contains('away-player') ? 'away' : 'home',
                    x: ((e.clientX - rect.left) / rect.width) * 100,
                    y: ((e.clientY - rect.top) / rect.height) * 100,
                    clientX: e.clientX, clientY: e.clientY
                };
                showModal('outcome-modal', e.clientX, e.clientY);
            }
            document.body.removeChild(ghostElement); ghostElement = null; draggedElement = null;
        }
        function updateGhost(x, y) { ghostElement.style.left = `${x-20}px`; ghostElement.style.top = `${y-20}px`; }

        function showModal(id, x, y) {
            const m = document.getElementById(id);
            m.classList.remove('hidden');
            m.style.left = `${Math.min(window.innerWidth - 150, x)}px`;
            m.style.top = `${Math.min(window.innerHeight - 200, y)}px`;
            if (id === 'outcome-modal') {
                m.innerHTML = `<button data-val="goal" class="w-24 bg-emerald-500 text-white p-2 rounded font-bold">Maali</button><button data-val="miss" class="w-24 bg-blue-500 text-white p-2 rounded font-bold">Ohi</button><button data-val="save" class="w-24 bg-red-500 text-white p-2 rounded font-bold">Torjunta</button><button data-val="block" class="w-24 bg-yellow-400 text-slate-900 p-2 rounded font-bold">Blokki</button>`;
            } else if (id === 'quality-modal') {
                m.innerHTML = `<button data-val="high" class="w-24 bg-red-700 text-white p-2 rounded font-bold">Laatu</button><button data-val="low" class="w-24 bg-blue-700 text-white p-2 rounded font-bold">Heikko</button>`;
            } else if (id === 'edit-outcome-modal') {
                m.innerHTML = `<button data-val="goal" class="w-24 bg-emerald-500 text-white p-2 rounded font-bold">Maali</button><button data-val="delete" class="w-24 bg-slate-600 text-white p-2 rounded font-bold">Poista</button>`;
            }
        }

        function onOutcomeSelect(e) {
            const val = e.target.dataset.val; if (!val) return;
            tempShotData.outcome = val;
            document.getElementById('outcome-modal').classList.add('hidden');
            showModal('quality-modal', tempShotData.clientX, tempShotData.clientY);
        }
        function onQualitySelect(e) {
            const val = e.target.dataset.val; if (!val) return;
            const shot = { id: Date.now(), ...tempShotData, quality: val, period: currentGame.currentPeriod, xG: calcXG(tempShotData.x, tempShotData.y, tempShotData.team) };
            delete shot.clientX; delete shot.clientY;
            currentGame.shots.push(shot); saveLocal();
            document.getElementById('quality-modal').classList.add('hidden');
            renderShots(); updateStats();
        }
        function onShotClick(e) {
            const marker = e.target.closest('.shot-marker'); if (!marker || currentGame.isReadOnly) return;
            shotToEditId = Number(marker.dataset.id);
            showModal('edit-outcome-modal', e.clientX, e.clientY);
        }
        function onEditSelect(e) {
            const val = e.target.dataset.val; if (!val) return;
            const idx = currentGame.shots.findIndex(s => s.id === shotToEditId);
            if (val === 'delete') currentGame.shots.splice(idx, 1);
            else currentGame.shots[idx].outcome = val;
            saveLocal(); document.getElementById('edit-outcome-modal').classList.add('hidden');
            renderShots(); updateStats();
        }

        function calcXG(x, y, team) {
            const MAX_XG = 0.65, X_POWER = 3, Y_POWER = 1.5;
            const xNorm = x / 100, yNorm = Math.abs(y - 50) / 50;
            const xFactor = (team === 'home') ? Math.pow(1 - xNorm, X_POWER) : Math.pow(xNorm, X_POWER);
            const yFactor = Math.pow(1 - yNorm, Y_POWER);
            return parseFloat((MAX_XG * xFactor * yFactor).toFixed(2));
        }

        function renderShots() {
            const layer = document.getElementById('shots-layer'); layer.innerHTML = '';
            const filtered = (currentGame.shots || []).filter(s => currentGame.currentPeriod === 'summary' || s.period === currentGame.currentPeriod);
            filtered.forEach(s => {
                const m = document.createElement('div');
                m.className = `shot-marker ${s.outcome} ${s.quality === 'high' ? 'quality-high' : 'quality-low'}`;
                m.style.left = `${s.x}%`; m.style.top = `${s.y}%`;
                m.dataset.id = s.id; m.textContent = s.player;
                layer.appendChild(m);
            });
        }

        function updateStats() {
            const stats = getStatsForPeriod(currentGame, currentGame.currentPeriod);
            const container = document.getElementById('stats-container');
            const title = currentGame.currentPeriod === 'summary' ? 'Ottelu' : `Erä ${currentGame.currentPeriod}`;
            container.innerHTML = `<h3 class="font-bold text-center mb-3 text-slate-400 uppercase">${title}</h3><div class="grid grid-cols-2 gap-4 text-sm"><div><p class="font-bold text-emerald-400 uppercase">Koti</p><p>Maalit: ${stats.home.goals}</p><p>xG: ${stats.home.xg.toFixed(2)}</p></div><div><p class="font-bold text-slate-400 uppercase">Vieras</p><p>Maalit: ${stats.away.goals}</p><p>Lauk: ${stats.away.shots}</p></div></div>`;
            if (currentGame.currentPeriod === 'summary') {
                document.getElementById('player-stats-container').classList.remove('hidden');
                updatePlayerStatsUI();
            } else document.getElementById('player-stats-container').classList.add('hidden');
        }

        function updatePlayerStatsUI() {
            const container = document.getElementById('player-stats-container');
            let html = `<h3 class="font-bold text-center mb-2 uppercase text-white">Pelaajat</h3>`;
            (currentGame.players || []).forEach(p => {
                const pShots = (currentGame.shots || []).filter(s => s.player == p && s.team === 'home');
                if (pShots.length > 0) html += `<div class="flex justify-between text-xs py-1 border-b border-slate-700 text-slate-300"><span>#${p}</span><span>${pShots.length} L / ${pShots.filter(s=>s.outcome==='goal').length} M</span></div>`;
            });
            container.innerHTML = html;
        }

        function calculateSeasonStats() {
            const fullRoster = {}, playerStats = {};
            (seasonData.games || []).forEach(g => Object.assign(fullRoster, g.roster || {}));
            const allPlayers = [...new Set((seasonData.games || []).flatMap(g => g.players || []))].map(Number).sort((a,b)=>a-b);
            allPlayers.forEach(p => { playerStats[p] = { number: p, games: 0, shots: 0, goals: 0, plus: 0, minus: 0, qH: 0, qL: 0 }; });
            (seasonData.games || []).forEach(game => {
                (game.players || []).forEach(p => { if(playerStats[p]) playerStats[p].games++; });
                (game.shots || []).forEach(s => {
                    if (s.team === 'home') {
                        const p = Number(s.player);
                        if (playerStats[p]) {
                            playerStats[p].shots++;
                            if (s.outcome === 'goal') playerStats[p].goals++;
                            if (s.quality === 'high') playerStats[p].qH++;
                            if (s.quality === 'low') playerStats[p].qL++;
                        }
                    }
                });
                Object.keys(game.plusMinus || {}).forEach(pNum => {
                    const p = Number(pNum);
                    if (playerStats[p]) {
                        playerStats[p].plus += (game.plusMinus[pNum].plus || 0);
                        playerStats[p].minus += (game.plusMinus[pNum].minus || 0);
                    }
                });
            });
            Object.values(playerStats).forEach(s => s.bal = s.plus - s.minus);
            return { playerStats: Object.values(playerStats), fullRoster, allPlayers };
        }

        function handleHeaderClick(type, key) {
            const state = type === 'season' ? seasonSort : matchSort;
            if (state.key === key) { state.dir = (state.dir + 1) % 3; } else { state.key = key; state.dir = 1; }
            renderSeasonStats();
        }

        function sortPlayers(players, state) {
            if (state.dir === 0) return players.sort((a,b) => a.number - b.number);
            return players.sort((a,b) => {
                const valA = a[state.key] || 0;
                const valB = b[state.key] || 0;
                return state.dir === 1 ? valB - valA : valA - valB;
            });
        }

        function getSortIcon(state, key) {
            if (state.key !== key || state.dir === 0) return '';
            return state.dir === 1 ? '<span class="sort-icon">▼</span>' : '<span class="sort-icon">▲</span>';
        }

        function generateGameDetailsHTML(game) {
            const stats = getStatsForPeriod(game, 'summary');
            const gamePlayers = (game.players || []).map(pNum => {
                const shots = (game.shots || []).filter(s => s.team === 'home' && Number(s.player) === Number(pNum));
                const goals = shots.filter(s => s.outcome === 'goal').length;
                const pm = (game.plusMinus && (game.plusMinus[pNum] || game.plusMinus[String(pNum)])) || {plus:0, minus:0};
                return {
                    number: Number(pNum),
                    name: (game.roster[pNum] || game.roster[String(pNum)] || '').split(' ')[0],
                    shots: shots.length, goals: goals,
                    qH: shots.filter(s => s.quality === 'high').length,
                    qL: shots.filter(s => s.quality === 'low').length,
                    bal: pm.plus - pm.minus
                };
            }).filter(p => p.shots > 0 || p.bal !== 0);

            const sorted = sortPlayers(gamePlayers, matchSort);

            let html = `
                <div class="mt-4 p-4 bg-slate-900/50 rounded-lg border border-slate-700">
                    <div class="grid grid-cols-2 gap-4 mb-4 pb-4 border-b border-slate-700">
                        <div class="bg-slate-800/40 p-3 rounded border border-slate-700/50">
                            <p class="text-xs uppercase text-emerald-500 font-black mb-2">KOTI</p>
                            <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-xs text-slate-300">
                                <span>Laukaukset:</span><span class="text-white font-bold">${stats.home.shots}</span>
                                <span>xG:</span><span class="text-white font-bold">${stats.home.xg.toFixed(2)}</span>
                                <span class="text-red-400">L+:</span><span class="text-white font-bold">${stats.home.qH}</span>
                                <span class="text-blue-400">H-:</span><span class="text-white font-bold">${stats.home.qL}</span>
                                <span>Torjunnat:</span><span class="text-white font-bold">${stats.home.saves}</span>
                                <span>Blokit:</span><span class="text-white font-bold">${stats.home.blocks}</span>
                            </div>
                        </div>
                        <div class="bg-slate-800/40 p-3 rounded border border-slate-700/50">
                            <p class="text-xs uppercase text-slate-400 font-black mb-2">VIERAS</p>
                            <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-xs text-slate-300">
                                <span>Laukaukset:</span><span class="text-white font-bold">${stats.away.shots}</span>
                                <span>xG:</span><span class="text-white font-bold">${stats.away.xg.toFixed(2)}</span>
                                <span class="text-red-400">L+:</span><span class="text-white font-bold">${stats.away.qH}</span>
                                <span class="text-blue-400">H-:</span><span class="text-white font-bold">${stats.away.qL}</span>
                                <span>Torjunnat:</span><span class="text-white font-bold">${stats.away.saves}</span>
                                <span>Blokit:</span><span class="text-white font-bold">${stats.away.blocks}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="text-slate-500 uppercase font-bold">
                                <tr>
                                    <th class="py-2">Pelaaja</th>
                                    <th onclick="window.sortMatch('shots')" class="py-2 text-center sortable-header">L${getSortIcon(matchSort, 'shots')}</th>
                                    <th onclick="window.sortMatch('goals')" class="py-2 text-center sortable-header">M${getSortIcon(matchSort, 'goals')}</th>
                                    <th onclick="window.sortMatch('qH')" class="py-2 text-center sortable-header">L+${getSortIcon(matchSort, 'qH')}</th>
                                    <th onclick="window.sortMatch('qL')" class="py-2 text-center sortable-header">H-${getSortIcon(matchSort, 'qL')}</th>
                                    <th onclick="window.sortMatch('bal')" class="py-2 text-center sortable-header">+/-${getSortIcon(matchSort, 'bal')}</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            sorted.forEach(p => {
                html += `
                    <tr class="border-t border-slate-800">
                        <td class="py-2 font-bold text-slate-300">#${p.number} ${p.name}</td>
                        <td class="py-2 text-center">${p.shots}</td>
                        <td class="py-2 text-center text-emerald-400 font-bold">${p.goals}</td>
                        <td class="py-2 text-center text-red-300">${p.qH}</td>
                        <td class="py-2 text-center text-blue-300">${p.qL}</td>
                        <td class="py-2 text-center font-bold ${p.bal > 0 ? 'text-emerald-500' : p.bal < 0 ? 'text-red-500' : 'text-slate-600'}">${p.bal > 0 ? '+' : ''}${p.bal}</td>
                    </tr>`;
            });
            html += `</tbody></table></div></div>`;
            return html;
        }

        window.sortSeason = (key) => handleHeaderClick('season', key);
        window.sortMatch = (key) => handleHeaderClick('match', key);

        function renderSeasonStats() {
            const view = document.getElementById('season-view');
            const { playerStats, fullRoster } = calculateSeasonStats();
            const sortedPlayers = sortPlayers([...playerStats], seasonSort);
            
            let playerHtml = `
                <div class="max-w-4xl mx-auto px-2 mb-10 overflow-hidden rounded-xl border border-slate-700 bg-slate-800 shadow-2xl">
                    <div class="bg-slate-700/50 p-4 border-b border-slate-700 text-center"><h3 class="font-bold text-white uppercase tracking-wider">Kauden pelaajakohtainen yhteenveto</h3></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-900/50 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th class="p-3">Pelaaja</th>
                                    <th onclick="window.sortSeason('games')" class="p-3 text-center sortable-header">O${getSortIcon(seasonSort, 'games')}</th>
                                    <th onclick="window.sortSeason('shots')" class="p-3 text-center sortable-header">L${getSortIcon(seasonSort, 'shots')}</th>
                                    <th onclick="window.sortSeason('goals')" class="p-3 text-center sortable-header">M${getSortIcon(seasonSort, 'goals')}</th>
                                    <th onclick="window.sortSeason('qH')" class="p-3 text-center text-red-400 sortable-header">L+${getSortIcon(seasonSort, 'qH')}</th>
                                    <th onclick="window.sortSeason('qL')" class="p-3 text-center text-blue-400 sortable-header">H-${getSortIcon(seasonSort, 'qL')}</th>
                                    <th onclick="window.sortSeason('bal')" class="p-3 text-center sortable-header">+/-${getSortIcon(seasonSort, 'bal')}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-700">`;
            
            sortedPlayers.forEach(s => {
                playerHtml += `<tr class="hover:bg-slate-700/30 transition-colors"><td class="p-3 font-bold text-slate-200">#${s.number} ${fullRoster[s.number] || ''}</td><td class="p-3 text-center">${s.games}</td><td class="p-3 text-center">${s.shots}</td><td class="p-3 text-center font-bold text-emerald-400">${s.goals}</td><td class="p-3 text-center text-red-300">${s.qH}</td><td class="p-3 text-center text-blue-300">${s.qL}</td><td class="p-3 text-center font-bold ${s.bal>0?'text-emerald-500':s.bal<0?'text-red-500':'text-slate-500'}">${s.bal>0?'+':''}${s.bal}</td></tr>`;
            });
            playerHtml += `</tbody></table></div></div>`;

            let gamesHtml = `<div class="max-w-4xl mx-auto px-2 pb-10"><h2 class="text-2xl font-bold mb-6 text-white text-center uppercase tracking-wider">Tallennetut ottelut</h2>`;
            const sortedGames = [...seasonData.games].sort((a,b) => new Date(b.date) - new Date(a.date));
            if (sortedGames.length === 0) gamesHtml += `<p class="text-center text-slate-500">Ei tallennettuja otteluita.</p>`;
            
            sortedGames.forEach(game => {
                const s = getGameStats(game);
                gamesHtml += `
                    <details class="bg-slate-800 text-white rounded-lg shadow-xl border border-slate-700 mb-4 overflow-hidden group">
                        <summary class="p-4 flex justify-between items-center transition-all hover:bg-slate-700/50">
                            <div class="flex-1">
                                <p class="font-bold text-indigo-400 text-lg">${new Date(game.date).toLocaleDateString('fi-FI')}</p>
                                <p class="text-xs opacity-60 uppercase font-semibold">vs ${game.opponent}</p>
                            </div>
                            <div class="text-2xl font-black tracking-widest px-4">${s.home.goals} - ${s.away.goals}</div>
                            <div class="flex gap-2">
                                <button data-id="${game.id}" class="pdf-btn bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg">PDF</button>
                                <button data-id="${game.id}" class="del-btn bg-red-600/10 hover:bg-red-600 text-red-500 hover:text-white p-2 rounded-lg"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"></path></svg></button>
                            </div>
                        </summary>
                        <div class="px-4 pb-4">
                            ${generateGameDetailsHTML(game)}
                        </div>
                    </details>`;
            });
            view.innerHTML = playerHtml + gamesHtml + `</div>`;
        }

        async function generatePdfReport(gameId, btn) {
            const origText = btn.textContent; btn.textContent = 'Luodaan...'; btn.disabled = true;
            try {
                const game = seasonData.games.find(g => g.id === gameId); if (!game) return;
                const { jsPDF } = window.jspdf;
                // Lisätty compress: true tiedostokoon pienentämiseksi
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', compress: true });
                const margin = 10, pageW = doc.internal.pageSize.getWidth(), pageH = doc.internal.pageSize.getHeight();
                let yPos = margin;

                doc.setFont('helvetica', 'bold'); doc.setFontSize(20); doc.text(`Otteluraportti: ${game.opponent}`, pageW/2, yPos, {align:'center'});
                yPos += 10;
                doc.setFont('helvetica', 'normal'); doc.setFontSize(12); doc.text(new Date(game.date).toLocaleDateString('fi-FI'), pageW/2, yPos, {align:'center'});
                yPos += 15;

                for (const period of [1, 2, 3, 'summary']) {
                    const stats = getStatsForPeriod(game, period), title = period === 'summary' ? 'Koko ottelu' : `Erä ${period}`;
                    const mapEl = createShotmapElement(game, period);
                    document.body.appendChild(mapEl);
                    await new Promise(r => requestAnimationFrame(r));
                    const canvas = await html2canvas(mapEl, { scale: 1.5 }); // Pudotettu scale hieman koon säästämiseksi
                    document.body.removeChild(mapEl);

                    // Käytetään JPEG-muotoa ja pakkausta (0.75) koon pienentämiseksi
                    const imgData = canvas.toDataURL('image/jpeg', 0.75);
                    const imgW = 180, imgH = 90, approxTableH = 62;
                    if (yPos + 6 + imgH + approxTableH > pageH - margin) { doc.addPage(); yPos = margin; }
                    doc.setFontSize(14); doc.text(title, margin, yPos); yPos += 6;
                    doc.addImage(imgData, 'JPEG', (pageW-imgW)/2, yPos, imgW, imgH);
                    yPos += imgH + 8;

                    callAutoTable(doc, {
                        startY: yPos, margin: { left: margin, right: margin }, tableWidth: pageW - margin*2, theme: 'grid',
                        head: [['Tapahtuma', 'Koti', 'Vieras']],
                        body: [
                            ['Maalit', stats.home.goals, stats.away.goals], 
                            ['Laukaukset', stats.home.shots, stats.away.shots], 
                            ['xG (Maaliodottama)', stats.home.xg.toFixed(2), stats.away.xg.toFixed(2)], 
                            ['Laadukkaat (L+)', stats.home.qH, stats.away.qH], 
                            ['Heikot (H-)', stats.home.qL, stats.away.qL], 
                            ['Torjunnat', stats.home.saves, stats.away.saves], 
                            ['Blokit', stats.home.blocks, stats.away.blocks]
                        ],
                        styles: { fontSize: 10 }, headStyles: { fillColor: [41, 52, 72] },
                        columnStyles: { 0: { cellWidth: 110 }, 1: { cellWidth: 35, halign: 'right' }, 2: { cellWidth: 35, halign: 'right' } }
                    });
                    yPos = doc.lastAutoTable.finalY + 14;
                }

                doc.addPage(); yPos = margin;
                doc.setFontSize(16); doc.text('Pelaajakohtaiset tilastot', pageW/2, yPos, {align:'center'}); yPos += 10;
                const rows = [];
                (game.players || []).sort((a,b)=>a-b).forEach(pNum => {
                    const shots = (game.shots || []).filter(s => s.team === 'home' && String(s.player) === String(pNum)), goals = shots.filter(s => s.outcome === 'goal').length;
                    const pm = (game.plusMinus && (game.plusMinus[pNum] || game.plusMinus[String(pNum)])) || { plus:0, minus:0 }, bal = pm.plus - pm.minus;
                    if (shots.length > 0 || pm.plus > 0 || pm.minus > 0) {
                        const name = (game.roster[pNum] || game.roster[String(pNum)] || '').trim();
                        rows.push([`#${pNum} ${name}`, shots.length, goals, shots.filter(s=>s.quality==='high').length, shots.filter(s=>s.quality==='low').length, `${bal > 0 ? '+' : ''}${bal}`]);
                    }
                });

                callAutoTable(doc, {
                    startY: yPos, theme: 'grid', head: [['Pelaaja', 'Lauk.', 'Maalit', 'L+', 'H-', '+/-', 'T%']],
                    body: rows.map(r => { const pct = r[1] ? Math.round((r[2]/r[1])*100) + '%' : '—'; return [...r, pct]; }),
                    columnStyles: { 0: { cellWidth: 60 }, 1: { cellWidth: 20, halign: 'right' }, 2: { cellWidth: 20, halign: 'right' }, 3: { cellWidth: 18, halign: 'right' }, 4: { cellWidth: 18, halign: 'right' }, 5: { cellWidth: 22, halign: 'right' }, 6: { cellWidth: 22, halign: 'right' } }
                });
                doc.save(`Raportti_${game.opponent}.pdf`);
            } catch (err) { console.error(err); } finally { btn.textContent = origText; btn.disabled = false; }
        }

        function createShotmapElement(game, p) {
            const w = 900, h = 450, wrap = document.createElement('div');
            Object.assign(wrap.style, { position:'fixed', left:'-9999px', width:w+'px', height:h+'px', background:'#fff' });
            wrap.innerHTML = `<svg width="${w}" height="${h}" viewBox="0 0 400 200" style="position:absolute;inset:0"><rect x="10" y="10" width="380" height="180" fill="none" stroke="#1e293b" stroke-width="2"/><line x1="200" y1="10" x2="200" y2="190" stroke="#94a3b8" stroke-width="1"/><rect x="30" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="1"/><rect x="330" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="1"/></svg><div id="shot-layer-pdf" style="position:absolute;inset:0;width:100%;height:100%;"></div>`;
            const layer = wrap.querySelector('#shot-layer-pdf');
            (game.shots || []).filter(s => p === 'summary' || s.period === p).forEach(s => {
                const dot = document.createElement('div'), leftPct = 2.5 + (s.x * 0.95), topPct = 5.0 + (s.y * 0.90);
                const textColor = s.outcome === 'block' ? '#000000' : '#ffffff';
                // KORJATTU PDF: Käytetään grid-keskitystä ja nollattua line-heightia
                Object.assign(dot.style, { 
                    position:'absolute', width:'28px', height:'28px', background: COLORS[s.outcome], borderRadius:'50%', 
                    left: leftPct + '%', top: topPct + '%', transform:'translate(-50%,-50%)', 
                    border: s.quality === 'high' ? '3px solid #b91c1c' : '2px solid white', 
                    color: textColor, fontSize:'12px', fontWeight:'900', 
                    display:'grid', placeItems:'center', lineHeight: '0' 
                });
                dot.textContent = s.player; layer.appendChild(dot);
            });
            return wrap;
        }

        function getGameStats(game) { return getStatsForPeriod(game, 'summary'); }

        function getStatsForPeriod(game, p) {
            const agg = { home: {goals:0, shots:0, xg:0, saves:0, blocks:0, qH:0, qL:0}, away: {goals:0, shots:0, xg:0, saves:0, blocks:0, qH:0, qL:0} };
            (game.shots || []).filter(s => p === 'summary' || s.period === p).forEach(s => {
                const t = s.team, o = t === 'home' ? 'away' : 'home';
                agg[t].shots++; agg[t].xg += Number(s.xG) || 0;
                if (s.outcome === 'goal') agg[t].goals++;
                if (s.outcome === 'save') agg[o].saves++;
                if (s.outcome === 'block') agg[o].blocks++;
                if (s.quality === 'high') agg[t].qH++;
                if (s.quality === 'low') agg[t].qL++;
            });
            return agg;
        }

        function callAutoTable(doc, opts) { if (window.jspdfAutoTable) return window.jspdfAutoTable(doc, opts); if (doc.autoTable) return doc.autoTable(opts); throw new Error('AutoTable not found'); }

        document.getElementById('login-btn').onclick = async () => {
            const e = document.getElementById('email-input').value, p = document.getElementById('password-input').value;
            try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { document.getElementById('auth-error').textContent = 'Virhe kirjautumisessa.'; }
        };
        document.getElementById('logout-btn').onclick = () => { sessionStorage.clear(); signOut(auth); };
        document.getElementById('logout-btn-teams').onclick = () => signOut(auth);
        document.getElementById('start-new-game-btn').onclick = () => { if (currentGame?.id) showMainView('app'); else showMainView('setup'); };
        document.getElementById('view-season-data-btn').onclick = () => { showMainView('app'); showView('season'); };
        document.getElementById('change-team-btn').onclick = () => showMainView('teams');
        document.getElementById('back-to-landing-btn').onclick = () => showMainView('landing');
        document.getElementById('start-button').onclick = async () => {
            const opp = document.getElementById('opponent-name-input').value.trim(), rosterStr = document.getElementById('player-roster-input').value;
            if (!opp) return;
            const roster = {}; const matches = rosterStr.matchAll(/(\d{1,3})\s*([^,\n\r]*)/g);
            for (const m of matches) roster[Number(m[1])] = m[2].trim();
            if (Object.keys(roster).length === 0) return;
            currentGame = { id: Date.now(), date: new Date().toISOString(), opponent: opp, roster, teamId: currentTeamId, teamName: document.getElementById('team-name-header').textContent, players: Object.keys(roster).map(Number), shots: [], plusMinus: {}, currentPeriod: 1 };
            currentGame.players.forEach(p => currentGame.plusMinus[p] = {plus:0, minus:0});
            await setDoc(doc(db, 'users', userId, 'teams', currentTeamId, 'roster', 'main'), { players: roster });
            saveLocal(); initializeGameUI(); addEventListeners(); showMainView('app'); showView(1);
        };
        async function saveGame() {
            const saveObj = {...currentGame}; delete saveObj.id;
            await addDoc(collection(db, 'users', userId, 'teams', currentTeamId, 'games'), saveObj);
            sessionStorage.removeItem(`inProgressGame-${userId}`); currentGame = {}; showMainView('landing');
        }
        function saveLocal() { if (userId) sessionStorage.setItem(`inProgressGame-${userId}`, JSON.stringify(currentGame)); }
        function showConfirmation(title, text, btnTxt, btnClass, cb) {
            const m = document.getElementById('confirm-modal'); m.classList.remove('hidden');
            m.innerHTML = `<div class="bg-white p-6 rounded-lg max-w-sm w-full text-slate-900 text-center"><h3 class="text-xl font-bold mb-2">${title}</h3><p class="text-sm mb-6 font-medium text-slate-600">${text}</p><div class="flex gap-2"><button id="conf-cancel" class="flex-1 py-2 bg-slate-200 text-slate-800 rounded font-bold transition-colors">Peruuta</button><button id="conf-ok" class="flex-1 py-2 ${btnClass} text-white rounded font-bold transition-colors">${btnTxt}</button></div></div>`;
            document.getElementById('conf-cancel').onclick = () => m.classList.add('hidden');
            document.getElementById('conf-ok').onclick = () => { cb(); m.classList.add('hidden'); };
        }
        function renderPlusMinusView() {
            const v = document.getElementById('plus-minus-view');
            v.innerHTML = `<div class="max-w-4xl mx-auto bg-slate-800 p-6 rounded-xl text-white border border-slate-700 shadow-2xl"><h2 class="text-2xl font-bold text-center mb-6 uppercase tracking-wider">+/- Merkintä</h2><div class="grid grid-cols-2 gap-8"><div class="bg-emerald-900/20 p-4 rounded-lg border border-emerald-500/30"><h3 class="font-bold text-emerald-400 text-center mb-4 uppercase text-xs">Oma maali (+)</h3><div id="pm-plus-grid" class="grid grid-cols-4 gap-2"></div></div><div class="bg-red-900/20 p-4 rounded-lg border border-red-500/30"><h3 class="font-bold text-red-400 text-center mb-4 uppercase text-xs">Vastustajan maali (-)</h3><div id="pm-minus-grid" class="grid grid-cols-4 gap-2"></div></div></div><div id="pm-summary" class="mt-8 border-t border-slate-700 pt-4"></div></div>`;
            const plusG = v.querySelector('#pm-plus-grid'), minusG = v.querySelector('#pm-minus-grid');
            (currentGame.players || []).forEach(p => {
                const bP = document.createElement('button'); bP.className = "p-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded transition-colors"; bP.textContent = p;
                bP.onclick = () => { currentGame.plusMinus[p].plus++; saveLocal(); renderPMTable(); };
                plusG.appendChild(bP);
                const bM = document.createElement('button'); bM.className = "p-2 bg-red-600 hover:bg-red-500 text-white font-bold rounded transition-colors"; bM.textContent = p;
                bM.onclick = () => { currentGame.plusMinus[p].minus++; saveLocal(); renderPMTable(); };
                minusG.appendChild(bM);
            });
            renderPMTable();
        }
        function renderPMTable() {
            const summ = document.getElementById('pm-summary');
            let html = `<table class="w-full text-left text-sm mt-4 text-slate-300"><thead><tr class="text-slate-500 uppercase text-xs"><th class="p-2">Pelaaja</th><th class="p-2 text-center">+</th><th class="p-2 text-center">-</th><th class="p-2 text-center">Yht.</th></tr></thead><tbody>`;
            (currentGame.players || []).forEach(p => {
                const s = currentGame.plusMinus[p], bal = s.plus - s.minus;
                html += `<tr class="border-t border-slate-700"><td class="p-2 font-bold text-slate-200">#${p} ${currentGame.roster[p]||''}</td><td class="p-2 text-center text-emerald-400">${s.plus}</td><td class="p-2 text-center text-red-400">${s.minus}</td><td class="p-2 text-center font-black ${bal>0?'text-emerald-500':bal<0?'text-red-500':'text-slate-400'}"> ${bal>0?'+':''}${bal}</td></tr>`;
            });
            summ.innerHTML = html + `</tbody></table>`;
        }

        document.getElementById('season-view').addEventListener('click', (e) => {
            const pdfBtn = e.target.closest('.pdf-btn'), delBtn = e.target.closest('.del-btn');
            if (pdfBtn) { e.preventDefault(); e.stopPropagation(); generatePdfReport(pdfBtn.dataset.id, pdfBtn); }
            else if (delBtn) { e.preventDefault(); e.stopPropagation(); showConfirmation('Poista?', 'Poistetaanko ottelu lopullisesti?', 'Poista', 'bg-red-600', () => deleteDoc(doc(db, 'users', userId, 'teams', currentTeamId, 'games', delBtn.dataset.id))); }
        });

        window.onload = initApp;
    </script>
</body>
</html>
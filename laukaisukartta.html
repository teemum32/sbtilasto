<!DOCTYPE html>
<html lang="fi" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' blob: https:; connect-src 'self' https: wss:; style-src 'self' 'unsafe-inline'; worker-src 'self' blob: data:; img-src 'self' data:; frame-src 'self' blob: https:; frame-ancestors 'self' https:;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Salibandyn Kausitilastot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: pan-y; -webkit-user-select: none; user-select: none; overflow: auto; }
        .player-number { cursor: grab; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; border: 2px solid white; background-color: #020617; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); touch-action: none; }
        .away-player { font-size: 1.5rem; }
        .dragging { position: absolute; pointer-events: none; opacity: 0.7; z-index: 1000; }
        .shot-marker {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
            color: white;
            transform: translate(-50%, -50%);
            transition: opacity 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .shot-marker span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
            pointer-events: none;
        }
        .goal { background-color: #10B981; } .miss { background-color: #3B82F6; }
        .block { background-color: #FACC15; color: black; } .save { background-color: #EF4444; }
        .quality-high { border: 4px solid #b91c1c; } .quality-low { border: 4px solid #2563eb; }
        .action-modal { position: absolute; transform: translate(-50%, -50%); z-index: 50; display: flex; flex-direction: column; }
        .period-tab { padding: 8px 16px; border-radius: 6px; font-weight: 600; transition: background-color 0.2s; }
        .period-tab.active { background-color: #4f46e5; }
        #main-app > .bg-slate-900 {
            overflow-y: auto;
            overflow-x: hidden;
        }
        #pdf-overlay { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.9); display: none; z-index: 1000; }
        #pdf-overlay.visible { display: grid; place-items: center; }
        #pdf-overlay .panel { width: 96vw; height: 92vh; background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); overflow: hidden; position: relative; }
        #pdf-overlay header { position: absolute; inset: 0 0 auto 0; height: 48px; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; background: #0f172a; color: #e2e8f0; }
        #pdf-overlay header h3 { font-size: 14px; font-weight: 600; }
        #pdf-overlay header button { background: #ef4444; color: white; border-radius: 8px; padding: 6px 10px; font-weight: 700; }
        #pdf-iframe { position: absolute; top: 48px; left: 0; width: 100%; height: calc(100% - 48px); border: 0; }

        /* Pallonhallintapalkki */
        .possession-wrap { width:100%; max-width:980px; margin:0 auto 12px auto; }
        .possession-bar { position:relative; height:18px; background:#e2e8f0; border-radius:10px; overflow:hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,.15); }
        .possession-home, .possession-away { height:100%; }
        .possession-home { background:#10b981; }  /* Koti */
        .possession-away { background:#3b82f6; }  /* Vieras */
        .possession-labels { position:absolute; inset:0; display:flex; justify-content:space-between; align-items:center; font-size:.80rem; font-weight:700; color:#0f172a; padding:0 8px; mix-blend-mode:multiply; }

        /* Nappirivi kent√§n alle */
        .possession-controls {
            position: fixed;
            left: 50%;
            bottom: calc(12px + env(safe-area-inset-bottom));
            transform: translateX(-50%);
            display: flex; gap: .5rem; justify-content: center;
            padding: .4rem .6rem; border-radius: .75rem;
            background: rgba(15,23,42,.75); backdrop-filter: blur(6px);
            box-shadow: 0 6px 20px rgba(0,0,0,.25); z-index: 40;
        }
        .possession-controls button { padding:.65rem .9rem; border-radius:.6rem; font-weight:700; }
        .pos-btn-home { background:#10b981; color:white; }
        .pos-btn-away { background:#3b82f6; color:white; }
        .pos-btn-stop { background:#ef4444; color:white; }
        .pos-clock { min-width:4.5rem; text-align:center; font-variant-numeric:tabular-nums; color:white; font-weight:700; }
        
        /* Lajittelu */
        .sortable { cursor: pointer; }
        .sortable:hover { color: #fff; }
        .sort-asc::after { content: ' ‚ñ≤'; font-size: 0.7em; }
        .sort-desc::after { content: ' ‚ñº'; font-size: 0.7em; }
        
        /* +/‚àí valinnan korostukset */
        .pm-select-plus  { outline: 3px solid #10b981; outline-offset: 2px; }
        .pm-select-minus { outline: 3px solid #ef4444; outline-offset: 2px; }

        /* tilakytkimen ulkoasu */
        .pm-mode-btn { padding: .5rem .75rem; border-radius: .5rem; font-weight: 700; }
        .pm-mode-plus  { background:#10b981; color:#fff; }
        .pm-mode-minus { background:#ef4444; color:#fff; }
        .pm-mode-off   { background:#475569; color:#e5e7eb; }

        .pm-footer {
          display:flex; gap:.5rem; justify-content:center; align-items:center;
          margin-top: .75rem;
        }
        /* Valittujen laskuri nyt saman kokoinen kuin Vahvista-painike */
        .pm-badge {
          font-weight: 700;
          font-size: 1rem;
          padding: 0.5rem 0.9rem;
          border-radius: 0.5rem;
          background: #1f2937;
          color: #e5e7eb;
        }
        .pm-confirm { background:#2563eb; color:#fff; padding:.5rem .9rem; border-radius:.5rem; font-weight:700; }
        .pm-clear   { background:#64748b; color:#fff; padding:.5rem .9rem; border-radius:.5rem; font-weight:700; }
    </style>
</head>
<body class="bg-slate-900 h-full text-slate-200">

    <div id="auth-view" class="h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-slate-800 p-8 rounded-lg shadow-xl text-center">
            <h1 class="text-2xl font-bold">Tervetuloa</h1>
            <p class="text-slate-400 mt-2 mb-6">Kirjaudu sis√§√§n tunnuksillasi.</p>
            <div class="space-y-4">
                <input id="email-input" name="email" type="email" class="w-full p-3 border bg-slate-700 border-slate-600 rounded-lg text-lg text-center" placeholder="s√§hk√∂posti">
                <input id="password-input" name="password" type="password" class="w-full p-3 border bg-slate-700 border-slate-600 rounded-lg text-lg text-center" placeholder="salasana">
            </div>
            <p id="auth-error" class="text-red-500 text-sm mt-4 h-5"></p>
            <div class="mt-4">
                <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Kirjaudu sis√§√§n</button>
            </div>
        </div>
    </div>
    
    <div id="teams-view" class="h-full w-full hidden items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center">
            <h1 class="text-3xl font-bold">Valitse tai luo joukkue</h1>
            <div id="teams-list" class="mt-6 space-y-2 max-h-60 overflow-y-auto"></div>
            <div class="mt-6 border-t border-slate-700 pt-6">
                <input id="new-team-name" type="text" class="w-full p-3 border bg-slate-700 border-slate-600 rounded-lg text-center" placeholder="Uuden joukkueen nimi">
                <button id="create-team-btn" class="w-full mt-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg">Luo uusi joukkue</button>
            </div>
             <button id="logout-btn-teams" class="w-full bg-red-600 hover:bg-red-700 font-bold py-3 px-4 rounded-lg mt-6">Kirjaudu ulos</button>
        </div>
    </div>

    <div id="landing-view" class="h-full w-full hidden items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center">
            <h1 id="team-name-header" class="text-3xl font-bold"></h1>
             <p id="user-email" class="text-slate-400 mt-2 mb-8"></p>
            <div class="space-y-4">
                <button id="start-new-game-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 font-bold py-3 px-4 rounded-lg">Aloita uusi ottelu</button>
                <button id="view-season-data-btn" class="w-full bg-slate-600 hover:bg-slate-700 font-bold py-3 px-4 rounded-lg disabled:opacity-50">Tarkastele kausidataa</button>
                <button id="change-team-btn" class="w-full border border-slate-600 hover:bg-slate-700 font-bold py-3 px-4 rounded-lg mt-4">Vaihda joukkuetta</button>
                <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 font-bold py-3 px-4 rounded-lg mt-4">Kirjaudu ulos</button>
            </div>
        </div>
    </div>

    <div id="setup-view" class="h-full w-full hidden items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center">
            <h1 class="text-3xl font-bold mb-4">Uusi ottelu</h1>
            <input id="opponent-name-input" name="opponent-name" type="text" class="w-full p-3 border bg-slate-700 border-slate-600 rounded-lg text-lg text-center mb-4" placeholder="Vastustajan nimi">
            <textarea id="player-roster-input" name="player-roster" class="w-full h-48 p-3 border bg-slate-700 border-slate-600 rounded-lg text-sm font-mono" placeholder="Sy√∂t√§ pelaajanumerot, esim: 7 Matti, 10, 12, 21..."></textarea>
            <p id="setup-error" class="text-red-500 text-sm mt-2 h-5"></p>
            <button id="start-button" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 font-bold py-3 px-4 rounded-lg">Aloita merkint√§</button>
            <button id="back-to-landing-btn" class="mt-2 w-full text-slate-400 hover:text-slate-200 font-semibold py-2">Takaisin</button>
        </div>
    </div>

    <div id="app-container" class="h-full w-full hidden flex-col">
        <div id="period-tabs" class="bg-slate-800 p-2 flex justify-center gap-1 md:gap-2 shrink-0 flex-wrap"></div>
        <div class="flex-1 min-h-0 relative">
            <div id="main-app" class="absolute inset-0 grid grid-cols-1 md:grid-cols-[256px,1fr]">
                <div class="bg-slate-900 p-4 flex flex-col overflow-y-auto order-last md:order-first min-h-0">
                    <div id="sidebar-content" class="flex-grow"></div>
                    <button id="save-game-button" class="mt-6 w-full bg-blue-600 font-bold py-2 px-4 rounded-lg">Tallenna</button>
                </div>
                <div class="relative flex flex-col pt-8 bg-slate-200">
                    <div class="possession-wrap px-4 absolute left-0 right-0 top-0 z-30">
                        <div class="possession-bar">
                            <div id="pos-home" class="possession-home" style="width:50%"></div>
                            <div id="pos-away" class="possession-away" style="width:50%"></div>
                            <div class="possession-labels">
                                <span id="pos-home-label">Koti 50%</span>
                                <span id="pos-away-label">Vieras 50%</span>
                            </div>
                        </div>
                    </div>
                    <main class="flex-1 flex items-center justify-center gap-4 p-4 min-w-0">
                        <div id="field-area" class="w-full h-full flex items-center justify-center gap-4"></div>
                    </main>
                </div>
            </div>
            <div id="plus-minus-view" class="absolute inset-0 hidden bg-slate-200 overflow-y-auto p-4"></div>
            <div id="season-view" class="absolute inset-0 hidden bg-slate-200 overflow-y-auto p-4"></div>
            <div class="possession-controls">
                <button id="pos-home-btn" class="pos-btn-home">Koti hallussa</button>
                <button id="pos-away-btn" class="pos-btn-away">Vieras hallussa</button>
                <button id="pos-stop-btn" class="pos-btn-stop">Pys√§yt√§</button>
                <div id="pos-clock" class="pos-clock">0:00</div>
            </div>
        </div>
    </div>
    
    <div id="outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
    <div id="quality-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
    <div id="edit-outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"></div>
    <div id="pdf-overlay" role="dialog" aria-modal="true" aria-label="PDF-raportti">
        <div class="panel">
            <header>
                <h3>PDF-raportti</h3>
                <button id="close-pdf-overlay" type="button">Sulje</button>
            </header>
            <iframe id="pdf-iframe"></iframe>
        </div>
    </div>
    
    <script type="module">
        // ===== BLOB GUARD ‚Äì est√§ "blob:"-v√§lilehti k√§ynnistyksess√§ =====
        (function () {
            // 1) Jos ollaan jo blob: -osoitteessa (esim. session restore), palataan appiin.
            const APP_ENTRY = location.origin + location.pathname.split('?')[0].split('#')[0];
            if (location.protocol === 'blob:') {
                location.replace(APP_ENTRY);
                return;
            }

            // 2) Allow-list: blob-navigointi sallitaan vain tuoreesta k√§ytt√§j√§n eleest√§
            let lastUserGestureAt = 0;
            const markGesture = () => (lastUserGestureAt = Date.now());
            ['click','pointerdown','touchstart','keydown'].forEach(ev =>
                window.addEventListener(ev, markGesture, { capture: true, passive: true })
            );
            const gestureFresh = () => Date.now() - lastUserGestureAt < 1500; // 1.5 s ikkuna

            // 3) Est√§ window.open(blob:...) ilman k√§ytt√§j√§n elett√§
            const _open = window.open;
            window.open = function (url, name, specs) {
                try {
                    if (url && String(url).startsWith('blob:') && !gestureFresh()) {
                        console.warn('[BlobGuard] Blocked window.open to blob without user gesture:', url);
                        return null;
                    }
                } catch (e) {}
                return _open.apply(this, arguments);
            };

            // 4) (Diagnoosi) Loggaa kaikki createObjectURL-kutsut ‚Äì jotta n√§et mik√§ luo blobin
            const _create = URL.createObjectURL;
            URL.createObjectURL = function (obj) {
                const u = _create.call(URL, obj);
                // Jos blob luodaan ilman tuoretta elett√§ heti k√§ynnistyksess√§, t√§m√§ on ep√§ilty
                if (!gestureFresh()) {
                    console.warn('[BlobGuard] createObjectURL (no gesture yet):', u, obj);
                }
                return u;
            };

            // 5) (Varmistus) Jos joku yritt√§√§ ohjata locationiin blob: ilman elett√§, j√§tet√§√§n tekem√§tt√§
            const navToBlob = (nextUrl) => {
                if (String(nextUrl).startsWith('blob:') && !gestureFresh()) {
                    console.warn('[BlobGuard] Blocked location change to blob without user gesture:', nextUrl);
                    return true; // handled
                }
                return false;
            };
            const _assign = History.prototype.pushState;
            History.prototype.pushState = function (s, t, u) {
                if (u && navToBlob(u)) return;
                return _assign.apply(this, arguments);
            };
            const _replace = History.prototype.replaceState;
            History.prototype.replaceState = function (s, t, u) {
                if (u && navToBlob(u)) return;
                return _replace.apply(this, arguments);
            };

            // 6) Turvallinen apu PDF-nappiin: kutsu ennen generatePdfReport()
            window.__allowBlobNavFor = function (ms = 2000) {
                lastUserGestureAt = Date.now();
                setTimeout(() => (lastUserGestureAt = 0), ms);
            };
        })();

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, writeBatch, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const allViews = { auth: document.getElementById('auth-view'), teams: document.getElementById('teams-view'), landing: document.getElementById('landing-view'), setup: document.getElementById('setup-view'), app: document.getElementById('app-container') };
        const emailInput = document.getElementById('email-input'), passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn'), logoutBtn = document.getElementById('logout-btn'), logoutBtnTeams = document.getElementById('logout-btn-teams');
        const authError = document.getElementById('auth-error'), userEmailDisplay = document.getElementById('user-email');
        const opponentNameInput = document.getElementById('opponent-name-input'), playerRosterInput = document.getElementById('player-roster-input'), startButton = document.getElementById('start-button'), setupError = document.getElementById('setup-error');
        const periodTabs = document.getElementById('period-tabs'), mainAppView = document.getElementById('main-app'), plusMinusView = document.getElementById('plus-minus-view'), seasonView = document.getElementById('season-view');
        const outcomeModal = document.getElementById('outcome-modal'), editOutcomeModal = document.getElementById('edit-outcome-modal'), confirmModal = document.getElementById('confirm-modal'), qualityModal = document.getElementById('quality-modal');
        const teamsList = document.getElementById('teams-list'), newTeamNameInput = document.getElementById('new-team-name'), createTeamBtn = document.getElementById('create-team-btn');
        const teamNameHeader = document.getElementById('team-name-header'), changeTeamBtn = document.getElementById('change-team-btn');

        let db, auth, userId, currentTeamId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let seasonData = { games: [] }, rosterData = {}, currentGame = {};
        let gamesUnsubscribe = () => {}, teamsUnsubscribe = () => {};
        let draggedElement = null, ghostElement = null, tempShotData = {}, shotToEditId = null;
        let sortState = {};
        
        // +/- -valintatila
        let pmMode = null; // 'plus' | 'minus' | null
        const pmSelectedPlus  = new Set(); // Set<number>
        const pmSelectedMinus = new Set(); // Set<number>
        
        // Pallonhallinta (possession) ‚Äì tilamuuttujat
        let posActiveTeam = null;         // 'home' | 'away' | null
        let posLastSwitch = null;         // ms (performance.now)
        let posTick = null;               // setInterval id
        let posClockMs = 0;               // n√§ytett√§v√§ kellonaika (juokseva segmentti)

        const elPosHomeBar   = () => document.getElementById('pos-home');
        const elPosAwayBar   = () => document.getElementById('pos-away');
        const elPosHomeLabel = () => document.getElementById('pos-home-label');
        const elPosAwayLabel = () => document.getElementById('pos-away-label');
        const elPosClock     = () => document.getElementById('pos-clock');

        function showMainView(viewName) {
            Object.values(allViews).forEach(v => v.classList.add('hidden'));
            allViews[viewName].classList.remove('hidden');
            allViews[viewName].classList.add('flex');
            if (viewName === 'landing') {
                document.getElementById('start-new-game-btn').textContent = (currentGame && currentGame.id) ? 'Jatka ottelua' : 'Aloita uusi ottelu';
            }
        }

        async function startFirebaseApp() {
            try {
                const firebaseConfig = { apiKey: "AIzaSyDdqRwtwIat2t_qKYE9H3jmbVM1_EIvKy0", authDomain: "sbtilastot.firebaseapp.com", projectId: "sbtilastot", storageBucket: "sbtilastot.appspot.com", messagingSenderId: "1056099775207", appId: "1:1056099775207:web:6dc886fb56b71f708fe842" };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); auth = getAuth(app);
                try { await enableIndexedDbPersistence(db); } catch (err) {}
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userEmailDisplay.textContent = user.email;
                        const savedGameJSON = sessionStorage.getItem(`inProgressGame-${userId}`);
                        if (savedGameJSON) {
                            currentGame = JSON.parse(savedGameJSON);
                            currentTeamId = currentGame.teamId;
                            teamNameHeader.textContent = currentGame.teamName;
                            await loadRosterFromFirestore();
                            listenForGames();
                            showMainView('app');
                            initializeGameUI();
                            addEventListeners();
                            showView(currentGame.currentPeriod || 1);
                        } else {
                            listenForTeams();
                            showMainView('teams');
                        }
                    } else {
                        userId = null; currentTeamId = null; currentGame = {};
                        sessionStorage.clear();
                        if (gamesUnsubscribe) gamesUnsubscribe();
                        if (teamsUnsubscribe) teamsUnsubscribe();
                        showMainView('auth');
                    }
                });
            } catch (error) { document.body.innerHTML = `<div class="p-8 text-center">Yhteys ep√§onnistui: ${error.message}</div>`; }
        }
        
        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value; const password = passwordInput.value; authError.textContent = '';
            if (!email || !password) { authError.textContent = 'S√§hk√∂posti ja salasana vaaditaan.'; return; }
            try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { authError.textContent = 'Kirjautuminen ep√§onnistui.'; }
        });

        [logoutBtn, logoutBtnTeams].forEach(btn => btn.addEventListener('click', () => { sessionStorage.removeItem(`inProgressGame-${userId}`); signOut(auth); }));
        
        document.getElementById('start-new-game-btn').addEventListener('click', () => {
            if (currentGame && currentGame.id) { showMainView('app'); } 
            else { showMainView('setup'); prefillRosterInput(); }
        });

        document.getElementById('view-season-data-btn').addEventListener('click', () => { showMainView('app'); showView('season'); });
        document.getElementById('back-to-landing-btn').addEventListener('click', () => showMainView('landing'));
        changeTeamBtn.addEventListener('click', () => { currentGame = {}; sessionStorage.removeItem(`inProgressGame-${userId}`); showMainView('teams'); });

        createTeamBtn.addEventListener('click', async () => {
            const teamName = newTeamNameInput.value.trim();
            if (teamName && userId) {
                await addDoc(collection(db, 'users', userId, 'teams'), { name: teamName, createdAt: serverTimestamp() });
                newTeamNameInput.value = '';
            }
        });

        function listenForTeams() {
            if (!userId) return;
            if (teamsUnsubscribe) teamsUnsubscribe();
            teamsUnsubscribe = onSnapshot(query(collection(db, 'users', userId, 'teams')), (snap) => {
                renderTeamsList(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });
        }
        
        function renderTeamsList(teams) {
            teamsList.innerHTML = teams.length === 0 ? `<p class="text-slate-400">Ei joukkueita.</p>` : '';
            teams.forEach(team => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-slate-600 hover:bg-slate-700 font-bold py-3 px-4 rounded-lg";
                btn.textContent = team.name;
                btn.onclick = () => selectTeam(team);
                teamsList.appendChild(btn);
            });
        }

        async function selectTeam(team) {
            currentTeamId = team.id;
            teamNameHeader.textContent = team.name;
            await loadRosterFromFirestore();
            listenForGames();
            showMainView('landing');
        }
        
        function parseRosterTextarea(value) {
            const roster = {};
            const lines = value.split('\n').map(l => l.trim()).filter(Boolean);
            for (const line of lines) {
                const m = line.match(/^(\d{1,3})\s*(.*)$/);
                if (!m) { throw new Error('Virheellinen sy√∂te rivill√§: ' + line); }
                roster[Number(m[1])] = (m[2] || '').trim();
            }
            return roster;
        }

        startButton.addEventListener('click', async () => {
            setupError.textContent = ''; const opponentName = opponentNameInput.value.trim();
            if (!opponentName) { setupError.textContent = 'Sy√∂t√§ vastustajan nimi.'; return; }
            let newRoster = {};
            try { newRoster = parseRosterTextarea(playerRosterInput.value); } 
            catch (err) { setupError.textContent = err.message; return; }
            if (Object.keys(newRoster).length === 0) { setupError.textContent = 'Sy√∂t√§ v√§hint√§√§n yksi pelaaja.'; return; }
            await saveRosterToFirestore(newRoster);
            rosterData = newRoster; playerRosterInput.value = '';
            showMainView('app'); startNewGame(newRoster, opponentName);
        });

        function startNewGame(roster, opponentName) {
            const players = Object.keys(roster).map(n => +n).sort((a,b)=>a-b);
            if (players.length === 0) { setupError.textContent = 'Kokoonpano tyhj√§.'; showMainView('setup'); return; }
            currentGame = { id: Date.now(), date: new Date().toISOString(), opponent: opponentName, players, roster, shots: [], plusMinus: {}, teamId: currentTeamId, teamName: teamNameHeader.textContent };
            
            // ALUSTA PALLONHALLINTA ERITT√ÑIN YKSINKERTAISESTI PER ER√Ñ + summary
            currentGame.possession = {
                1: { home:0, away:0 }, 2: { home:0, away:0 }, 3: { home:0, away:0 },
                summary: { home:0, away:0 }
            };

            players.forEach(p => { currentGame.plusMinus[p] = { plus: 0, minus: 0 }; });
            sessionStorage.setItem(`inProgressGame-${userId}`, JSON.stringify(currentGame));
            
            initializeGameUI(); 
            // Nollaa ajanoton UI
            resetPossessionUI();

            initializePlayers(); 
            addEventListeners(); 
            showView(1);
        }
        
        function initializeGameUI() {
            periodTabs.innerHTML = `<button data-period="home" class="period-tab">Koti</button> <button data-period="1" class="period-tab active">Er√§ 1</button> <button data-period="2" class="period-tab">Er√§ 2</button> <button data-period="3" class="period-tab">Er√§ 3</button> <button data-period="summary" class="period-tab">Ottelu</button> <button data-period="plus-minus" class="period-tab">+/-</button> <button data-period="season" class="period-tab">Kausi</button>`;
            document.getElementById('sidebar-content').innerHTML = `<h2 class="text-xl font-bold mb-4 text-center">Koti</h2><div id="home-player-list" class="grid grid-cols-3 gap-3 mb-6"></div><h2 class="text-xl font-bold mb-4 text-center">Vieras</h2><div id="away-player-list" class="flex justify-center mb-6"></div><div id="stats-container" class="border-t border-slate-700 pt-4"></div><div id="player-stats-container" class="hidden border-t border-slate-700 pt-4 mt-4"></div>`;
            document.getElementById('field-area').innerHTML = `<div class="text-slate-500 font-bold text-lg -rotate-90">Vieras</div><div id="field-container" class="relative w-full max-w-[1200px] aspect-[2/1] bg-white rounded-lg shadow-2xl border-2 border-slate-800"><svg class="w-full h-full" viewBox="0 0 400 200"><line x1="200" y1="0" x2="200" y2="200" stroke="#94a3b8" stroke-width="2"/><rect x="30" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"/><line x1="40" y1="90" x2="40" y2="110" stroke="#94a3b8" stroke-width="2"/><rect x="330" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"/><line x1="360" y1="90" x2="360" y2="110" stroke="#94a3b8" stroke-width="2"/></svg><div id="shots-layer" class="absolute inset-0"></div></div><div class="text-slate-500 font-bold text-lg rotate-90">Koti</div>`;
            outcomeModal.innerHTML = `<button data-outcome="goal" class="w-28 text-white font-semibold py-2 rounded-md bg-emerald-500">Maali</button> <button data-outcome="miss" class="w-28 text-white font-semibold py-2 rounded-md bg-blue-500">Ohi</button><button data-outcome="block" class="w-28 text-slate-800 font-semibold py-2 rounded-md bg-yellow-400">Blokki</button> <button data-outcome="save" class="w-28 text-white font-semibold py-2 rounded-md bg-red-500">Torjunta</button>`;
            qualityModal.innerHTML = `<button data-quality="high" class="w-28 text-white font-semibold py-2 px-4 rounded-md bg-red-700">Laadukas</button><button data-quality="low" class="w-28 text-white font-semibold py-2 px-4 rounded-md bg-blue-700">Heikko</button>`;
            editOutcomeModal.innerHTML = `<button data-outcome="goal" class="w-32 text-white font-semibold py-2 rounded-md bg-emerald-500">Maali</button> <button data-outcome="miss" class="w-32 text-white font-semibold py-2 rounded-md bg-blue-500">Ohi</button><button data-outcome="block" class="w-32 text-slate-800 font-semibold py-2 rounded-md bg-yellow-400">Blokki</button> <button data-outcome="save" class="w-32 text-white font-semibold py-2 rounded-md bg-red-500">Torjunta</button><div class="border-t my-1"></div> <button id="delete-shot-btn" class="w-32 text-white font-semibold py-2 rounded-md bg-slate-600">Poista</button><div class="border-t my-1"></div><div class="flex gap-2 justify-center"><button data-special="YV" class="w-20 text-white font-semibold py-2 rounded-md bg-purple-600 hover:bg-purple-700">YV</button><button data-special="AV" class="w-20 text-white font-semibold py-2 rounded-md bg-amber-600 hover:bg-amber-700">AV</button><button data-special="none" class="w-24 text-slate-800 font-semibold py-2 rounded-md bg-slate-300 hover:bg-slate-400">Poista</button></div>`;
        }

        function initializePlayers() {
            const home = document.getElementById('home-player-list');
            const away = document.getElementById('away-player-list');
            home.innerHTML = '';
            away.innerHTML = '';
            const v = document.createElement('div');
            v.className = 'player-number away-player';
            v.textContent = 'V';
            away.appendChild(v);
            (currentGame.players || []).forEach(num => {
                const el = document.createElement('div');
                el.className = 'player-number';
                el.textContent = num;
                el.title = currentGame.roster?.[num] || '';
                home.appendChild(el);
            });
        }
        
        function showView(viewId) {
            // Pys√§yt√§ mahdolliset timerit ennen vaihtoja
            stopPossession();

            document.querySelectorAll('.period-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.period-tab[data-period="${viewId}"]`)?.classList.add('active');

            mainAppView.classList.add('hidden'); 
            plusMinusView.classList.add('hidden'); 
            seasonView.classList.add('hidden');

            // M√§√§rit√§ nykyinen periodi
            currentGame.currentPeriod = isNaN(viewId) ? viewId : parseInt(viewId, 10);

            // ‚è±Ô∏è N√§yt√§ LEIJUVAT timer-napit vain eriss√§ 1‚Äì3
            const posControls = document.querySelector('.possession-controls');
            const isPeriodView = [1,2,3].includes(currentGame.currentPeriod);
            if (posControls) posControls.classList.toggle('hidden', !isPeriodView);

            if(viewId === 'home' || (viewId === 'season' && currentGame.isReadOnly)) { 
                if (currentGame.isReadOnly) currentGame = {};
                showMainView('landing'); 
                return;
            }

            if (viewId === 'plus-minus') { 
                renderPlusMinusView(); 
                plusMinusView.classList.remove('hidden'); 
            } else if (viewId === 'season') { 
                renderSeasonStats(); 
                seasonView.classList.remove('hidden'); 
            } else { 
                mainAppView.classList.remove('hidden'); 
                renderShots(); 
                updateStats(); 
            }
            
            // jokaisen n√§kym√§vaihdon j√§lkeen p√§ivit√§ pylv√§s, koska sekin voi n√§ytt√§√§ summaa
            renderPossession();
        }
        
        function addEventListeners() {
            document.getElementById('save-game-button').addEventListener('click', () => { if (currentGame.isReadOnly) return; showConfirmation('Tallenna ottelu?', 'Haluatko varmasti tallentaa ja p√§√§tt√§√§ ottelun? Tallennuksen j√§lkeen nykyisen pelin merkinn√§t poistuvat n√§kyvist√§. Ota tarvittavat ruutukaappaukset ennen tallennusta.', 'Kyll√§, tallenna', 'bg-blue-600', saveAndEndGameInFirestore) });
            outcomeModal.addEventListener('click', onOutcomeSelect);
            qualityModal.addEventListener('click', onQualitySelect);
            editOutcomeModal.addEventListener('click', onEditOutcomeSelect);
            periodTabs.addEventListener('click', (e) => { const btn = e.target.closest('button.period-tab'); if (btn) showView(btn.dataset.period); });
            ['home-player-list','away-player-list'].forEach(id => {
                const list = document.getElementById(id);
                if(list) list.addEventListener('pointerdown', onPointerDown, { passive: false });
            });
            const field = document.getElementById('field-area');
            if (field) {
                 const fieldContainer = field.querySelector('#field-container');
                 if(fieldContainer) fieldContainer.addEventListener('contextmenu', e => e.preventDefault());
                 const shotsLayer = field.querySelector('#shots-layer');
                 if(shotsLayer) shotsLayer.addEventListener('click', onShotMarkerClick);
            }
            document.body.addEventListener('pointermove', onPointerMove, { passive: false });
            document.body.addEventListener('pointerup', onPointerUp);

            // Pallonhallinnan napit
            document.getElementById('pos-home-btn')?.addEventListener('click', () => startPossession('home'));
            document.getElementById('pos-away-btn')?.addEventListener('click', () => startPossession('away'));
            document.getElementById('pos-stop-btn')?.addEventListener('click', stopPossession);
        }
        
        function onPointerDown(e) { const target = e.target.closest('.player-number'); if (!target || !currentGame.id || currentGame.isReadOnly) return; draggedElement = target; ghostElement = target.cloneNode(true); ghostElement.classList.add('dragging'); document.body.appendChild(ghostElement); updateGhostPosition(e.pageX, e.pageY); }
        function onPointerMove(e) { if (!ghostElement) return; e.preventDefault(); updateGhostPosition(e.pageX, e.pageY); }
        function onPointerUp(e) { if (!draggedElement || !ghostElement) return; ghostElement.style.display = 'none'; const dropTarget = document.elementFromPoint(e.clientX, e.clientY); ghostElement.style.display = ''; const fieldContainer = document.getElementById('field-container'); if (fieldContainer && fieldContainer.contains(dropTarget)) { const shotsLayer = document.getElementById('shots-layer'); const rect = shotsLayer.getBoundingClientRect(); const x = ((e.clientX - rect.left) / rect.width) * 100, y = ((e.clientY - rect.top) / rect.height) * 100; tempShotData = { player: draggedElement.textContent, team: draggedElement.classList.contains('away-player') ? 'away' : 'home', x, y, clientX: e.clientX, clientY: e.clientY }; showOutcomeModal(e.clientX, e.clientY); } document.body.removeChild(ghostElement); ghostElement = null; draggedElement = null; }
        function updateGhostPosition(x, y) { if (ghostElement) { ghostElement.style.left = `${x - 25}px`; ghostElement.style.top = `${y - 25}px`; } }
        function onOutcomeSelect(e) { const target = e.target.closest('[data-outcome]'); if (!target) return; tempShotData.outcome = target.dataset.outcome; hideOutcomeModal(); showQualityModal(tempShotData.clientX, tempShotData.clientY); }
        function onQualitySelect(e) { const target = e.target.closest('[data-quality]'); if (!target) return; const newShot = { id: Date.now() + Math.random(), ...tempShotData, quality: target.dataset.quality, period: currentGame.currentPeriod, xG: calculateXg(tempShotData.x, tempShotData.y, tempShotData.team), special: null }; delete newShot.clientX; delete newShot.clientY; currentGame.shots.push(newShot); sessionStorage.setItem(`inProgressGame-${userId}`, JSON.stringify(currentGame)); hideQualityModal(); renderShots(); updateStats(); }
        function onShotMarkerClick(e) { const target = e.target.closest('.shot-marker'); if (!target || draggedElement || currentGame.isReadOnly) { hideEditOutcomeModal(); return; } shotToEditId = Number(target.dataset.shotId); showEditOutcomeModal(e.clientX, e.clientY); }
        
        function onEditOutcomeSelect(e) {
            if (!shotToEditId) return;
            const target = e.target;
            const idx = currentGame.shots.findIndex(s => s.id === shotToEditId);
            if (idx === -1) return;

            let changed = false;

            // Poisto
            if (target.id === 'delete-shot-btn') {
                currentGame.shots.splice(idx, 1);
                changed = true;
            }
            // Tuloksen muutos (goal/miss/block/save)
            else if (target.closest('[data-outcome]')) {
                currentGame.shots[idx].outcome = target.closest('[data-outcome]').dataset.outcome;
                delete currentGame.shots[idx].quality; // Keep this logic
                changed = true;
            }
            // YV/AV/Poista
            else if (target.closest('[data-special]')) {
                const val = target.closest('[data-special]').dataset.special;
                currentGame.shots[idx].special = (val === 'none') ? null : val;
                changed = true;
            }

            if (changed) {
                sessionStorage.setItem(`inProgressGame-${userId}`, JSON.stringify(currentGame));
                hideEditOutcomeModal();
                renderShots();
                updateStats();
            }
        }

        function showOutcomeModal(x, y) { hideEditOutcomeModal(); hideQualityModal(false); outcomeModal.style.left = `${x}px`; outcomeModal.style.top = `${y}px`; outcomeModal.classList.remove('hidden'); }
        function hideOutcomeModal() { outcomeModal.classList.add('hidden'); }
        function showQualityModal(x, y) { hideOutcomeModal(); qualityModal.style.left = `${x}px`; qualityModal.style.top = `${y}px`; qualityModal.classList.remove('hidden'); }
        function hideQualityModal(clearData = true) { qualityModal.classList.add('hidden'); if (clearData) { tempShotData = {}; } }
        function showEditOutcomeModal(x, y) { hideOutcomeModal(); hideQualityModal(false); editOutcomeModal.style.left = `${x}px`; editOutcomeModal.style.top = `${y}px`; editOutcomeModal.classList.remove('hidden'); }
        function hideEditOutcomeModal() { editOutcomeModal.classList.add('hidden'); shotToEditId = null; }
        
        function onPmPlayerClick(e) {
            const btn = e.target.closest('.pm-player-btn');
            if (!btn) return;

            const num = Number(btn.dataset.player);
            if (!pmMode) {
                // Ei tilaa valittuna ‚Üí pieni ‚Äút√∂n√§isy‚Äù: vaihda + ‚Üî ‚àí nopeasti
                if (pmSelectedPlus.has(num))     { pmSelectedPlus.delete(num); pmSelectedMinus.add(num); }
                else if (pmSelectedMinus.has(num)){ pmSelectedMinus.delete(num); pmSelectedPlus.add(num); }
                else { pmSelectedPlus.add(num); }
            } else if (pmMode === 'plus') {
                // toggle plus
                if (pmSelectedPlus.has(num)) pmSelectedPlus.delete(num);
                else { pmSelectedPlus.add(num); pmSelectedMinus.delete(num); }
            } else if (pmMode === 'minus') {
                // toggle minus
                if (pmSelectedMinus.has(num)) pmSelectedMinus.delete(num);
                else { pmSelectedMinus.add(num); pmSelectedPlus.delete(num); }
            }

            // visuaalinen korostus
            btn.classList.toggle('pm-select-plus',  pmSelectedPlus.has(num));
            btn.classList.toggle('pm-select-minus', pmSelectedMinus.has(num));

            // p√§ivit√§ laskurit
            const badge = document.querySelector('.pm-badge');
            if (badge) badge.textContent = `Valittuja +: ${pmSelectedPlus.size} ‚Ä¢ ‚àí: ${pmSelectedMinus.size}`;
        }

        function calculateXg(x, y, team) { const [MAX_XG, X_POWER, Y_POWER] = [0.65, 3, 1.5], xNorm = x / 100, yNorm = Math.abs(y - 50) / 50; const xFactor = (team === 'home') ? Math.pow(1 - xNorm, X_POWER) : Math.pow(xNorm, X_POWER); const yFactor = Math.pow(1 - yNorm, Y_POWER); return parseFloat((MAX_XG * xFactor * yFactor).toFixed(2)); }
        async function saveAndEndGameInFirestore() { if (!userId || !currentTeamId || !currentGame.id || currentGame.isReadOnly) return; try { const gameToSave = { ...currentGame }; delete gameToSave.id; await addDoc(collection(db, 'users', userId, 'teams', currentTeamId, 'games'), gameToSave); sessionStorage.removeItem(`inProgressGame-${userId}`); const saveButton = document.getElementById('save-game-button'); saveButton.disabled = true; saveButton.textContent = 'Tallennettu'; saveButton.classList.remove('bg-blue-600'); saveButton.classList.add('bg-gray-500', 'cursor-not-allowed'); document.getElementById('sidebar-content').style.pointerEvents = 'none'; currentGame.isReadOnly = true; } catch (error) {} }
        function listenForGames() { if (!userId || !currentTeamId) return; if(gamesUnsubscribe) gamesUnsubscribe(); const q = query(collection(db, 'users', userId, 'teams', currentTeamId, 'games')); gamesUnsubscribe = onSnapshot(q, (snap) => { seasonData.games = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); document.getElementById('view-season-data-btn').disabled = seasonData.games.length === 0; if (!seasonView.classList.contains('hidden')) renderSeasonStats(); }); }
        async function saveRosterToFirestore(roster) { if (userId && currentTeamId) await setDoc(doc(db, 'users', userId, 'teams', currentTeamId, 'roster', 'main'), { players: roster }); }
        async function loadRosterFromFirestore() { if (!userId || !currentTeamId) return; try { const docSnap = await getDoc(doc(db, 'users', userId, 'teams', currentTeamId, 'roster', 'main')); rosterData = docSnap.exists() ? docSnap.data().players || {} : {}; } catch (error) {} }
        async function deleteGameFromFirestore(gameId) { if (userId && currentTeamId) await deleteDoc(doc(db, 'users', userId, 'teams', currentTeamId, 'games', gameId)); }
        function prefillRosterInput() { playerRosterInput.value = Object.keys(rosterData).map(Number).sort((a,b)=>a-b).map(num => `${num} ${rosterData[num]||''}`).join('\n'); }
        function renderShots() { const shotsLayer = document.getElementById('shots-layer'); if(shotsLayer) { shotsLayer.innerHTML = ''; const shotsToRender = (currentGame.shots || []).filter(s => currentGame.currentPeriod === 'summary' || s.period === currentGame.currentPeriod); shotsToRender.forEach(s => shotsLayer.appendChild(createShotMarker(s))); } }
        
        function createShotMarker(shotData) {
            const s = document.createElement('div');
            s.className = `shot-marker ${shotData.outcome}`;
            if (shotData.quality === 'high') s.classList.add('quality-high');
            if (shotData.quality === 'low') s.classList.add('quality-low');
            s.dataset.shotId = shotData.id;
            s.innerHTML = `<span>${shotData.team === 'away' ? 'V' : shotData.player}</span>` +
              (shotData.special ? `<small style="position:absolute;right:-4px;top:-4px;background:#111827;color:#fff;border-radius:6px;padding:0 4px;font-size:10px">${shotData.special}</small>` : '');
            s.style.left = `${shotData.x}%`;
            s.style.top = `${shotData.y}%`;
            return s;
        }

        function normalizeSideFromShot(shot) {
            return shot.team === 'away' ? 'away' : 'home';
        }

        function updateStats() {
            if (!currentGame?.shots) return;

            const period = currentGame.currentPeriod;
            const set = currentGame.shots.filter(s => period === 'summary' ? true : s.period === period);

            let stats = { home:{goals:0,shots:0,xg:0,saves:0,blocks:0,qualityHigh:0,qualityLow:0,ppGoals:0,shGoals:0},
                          away:{goals:0,shots:0,xg:0,saves:0,blocks:0,qualityHigh:0,qualityLow:0,ppGoals:0,shGoals:0} };

            set.forEach(shot => {
                const side = normalizeSideFromShot(shot);
                const opp  = side === 'home' ? 'away' : 'home';
                stats[side].shots++;
                stats[side].xg += calculateXg(shot.x, shot.y, shot.team);
                if (shot.outcome === 'goal') {
                    stats[side].goals++;
                    if (shot.special === 'YV') stats[side].ppGoals++;
                    if (shot.special === 'AV') stats[side].shGoals++;
                }
                if (shot.outcome === 'save')  stats[opp].saves++;
                if (shot.outcome === 'block') stats[opp].blocks++;
                if (shot.quality === 'high') stats[side].qualityHigh++;
                if (shot.quality === 'low')  stats[side].qualityLow++;
            });

            // üî¢ Pallonhallinta %
            const poss = getPossessionPctFor(currentGame, period);

            document.getElementById('stats-container').innerHTML = `
                <h3 class="text-lg font-bold text-center mb-3">${(period === 'summary') ? 'Koko ottelu' : `Er√§ ${period}`}</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between font-semibold"><span>Koti</span></div>
                        <div class="flex justify-between text-sm mt-1"><span>Maalit: ${stats.home.goals}</span><span>Laukaukset: ${stats.home.shots}</span></div>
                        <div class="flex justify-between text-sm"><span>xG: ${stats.home.xg.toFixed(2)}</span><span>L+: ${stats.home.qualityHigh} / H-: ${stats.home.qualityLow}</span></div>
                        <div class="flex justify-between text-sm mt-1"><span>Pallonhallinta: ${poss.homePct}%</span><span></span></div>
                        <div class="flex justify-between text-sm mt-1 border-t pt-1"><span>Torjunnat: ${stats.home.saves}</span><span>Blokit: ${stats.home.blocks}</span></div>
                    </div>
                    <div>
                        <div class="flex justify-between font-semibold"><span>Vieras</span></div>
                        <div class="flex justify-between text-sm mt-1"><span>Maalit: ${stats.away.goals}</span><span>Laukaukset: ${stats.away.shots}</span></div>
                        <div class="flex justify-between text-sm"><span>xG: ${stats.away.xg.toFixed(2)}</span><span>L+: ${stats.away.qualityHigh} / H-: ${stats.away.qualityLow}</span></div>
                        <div class="flex justify-between text-sm mt-1"><span>Pallonhallinta: ${poss.awayPct}%</span><span></span></div>
                        <div class="flex justify-between text-sm mt-1 border-t pt-1"><span>Torjunnat: ${stats.away.saves}</span><span>Blokit: ${stats.away.blocks}</span></div>
                    </div>
                </div>`;

            const playerStatsContainer = document.getElementById('player-stats-container');
            playerStatsContainer.classList.toggle('hidden', period !== 'summary');
            if (period === 'summary') updatePlayerStats();
        }

        function updatePlayerStats() { const playerStatsContainer = document.getElementById('player-stats-container'); let html = `<h3 class="text-lg font-bold text-center mb-3">Pelaajatilastot</h3><div class="grid grid-cols-7 text-center font-semibold text-xs text-slate-400 mb-2 px-1"><span class="col-span-2">Pelaaja</span><span>L</span><span>M</span><span>L+</span><span>H-</span><span>+/-</span></div>`; (currentGame.players || []).forEach(pNum => { const shots = (currentGame.shots || []).filter(s => s.team === 'home' && s.player == pNum), goals = shots.filter(s => s.outcome === 'goal').length, qH = shots.filter(s=>s.quality==='high').length, qL = shots.filter(s=>s.quality==='low').length; const pm = currentGame.plusMinus[pNum]; if (shots.length > 0 || pm?.plus > 0 || pm?.minus > 0) { const bal = (pm?.plus || 0) - (pm?.minus || 0); const name = (currentGame.roster[pNum] || '').split(' ')[0] || ''; html += `<div class="grid grid-cols-7 text-center text-sm py-1 border-b border-slate-700 items-center"><span class="font-bold text-left col-span-2 truncate">#${pNum} ${name}</span><span>${shots.length}</span><span>${goals}</span><span class="text-red-400 font-semibold">${qH}</span><span class="text-blue-400 font-semibold">${qL}</span><span class="font-semibold">${bal > 0 ? '+' : ''}${bal}</span></div>`; } }); playerStatsContainer.innerHTML = html; }
        
        function resetPossessionUI() {
            posActiveTeam = null;
            posLastSwitch = null;
            posClockMs = 0;
            if (posTick) { clearInterval(posTick); posTick = null; }
            clearActivePosButtons();
            renderPossession();
            updatePosClock();
        }

        // K√§ynnist√§ hallinta valitulle joukkueelle
        function startPossession(team) {
            const now = performance.now();

            // Kertym√§ edelliselle, jos vaihtuu
            if (posActiveTeam && posLastSwitch != null) {
                const delta = now - posLastSwitch;
                addPossessionTime(posActiveTeam, delta);
            }
            
            clearActivePosButtons();
            if (team === 'home') {
                document.getElementById('pos-home-btn')?.classList.add('ring-4', 'ring-emerald-400');
            } else {
                document.getElementById('pos-away-btn')?.classList.add('ring-4', 'ring-blue-400');
            }

            posActiveTeam = team;         // 'home' | 'away'
            posLastSwitch = now;
            posClockMs = 0;

            if (!posTick) {
                posTick = setInterval(() => {
                    posClockMs += 1000;
                    updatePosClock();
                    // P√§ivitet√§√§n pylv√§s my√∂s k√§ynniss√§ ollessa (smooth)
                    renderPossession();
                }, 1000);
            }
            renderPossession();
        }

        function stopPossession() {
            const now = performance.now();
            if (posActiveTeam && posLastSwitch != null) {
                const delta = now - posLastSwitch;
                addPossessionTime(posActiveTeam, delta);
            }
            posActiveTeam = null;
            posLastSwitch = null;
            posClockMs = 0;
            if (posTick) { clearInterval(posTick); posTick = null; }
            clearActivePosButtons();
            updatePosClock();
            renderPossession();
        }

        // Kirjaa ms -> currentGame.possession[currentPeriod]
        function addPossessionTime(team, ms) {
            const p = currentGame.currentPeriod;
            if (!['1','2','3',1,2,3].includes(String(p))) return; // vain eriss√§ ker√§t√§√§n
            const key = Number(p);
            if(currentGame.possession[key]) {
                currentGame.possession[key][team] += ms;
            }
        }

        // Render√∂i pylv√§√§n ja prosentit nykyisen n√§kym√§n mukaan
        function renderPossession() {
            if (!currentGame || !currentGame.possession) return;
            const poss = getPossessionPctFor(currentGame, currentGame.currentPeriod);
            
            // palkit
            if (elPosHomeBar()) elPosHomeBar().style.width = `${poss.homePct}%`;
            if (elPosAwayBar()) elPosAwayBar().style.width = `${100 - poss.homePct}%`;

            // tekstit
            if (elPosHomeLabel()) elPosHomeLabel().textContent = `Koti ${poss.homePct}%`;
            if (elPosAwayLabel()) elPosAwayLabel().textContent = `Vieras ${poss.awayPct}%`;
        }

        function updatePosClock() {
            const m = Math.floor(posClockMs / 60000);
            const s = Math.floor((posClockMs % 60000) / 1000);
            if (elPosClock()) elPosClock().textContent = `${m}:${String(s).padStart(2,'0')}`;
        }
        
        function clearActivePosButtons() {
            document.getElementById('pos-home-btn')?.classList.remove('ring-4', 'ring-emerald-400');
            document.getElementById('pos-away-btn')?.classList.remove('ring-4', 'ring-blue-400');
        }
        
        function getPossessionPctFor(game, period) {
            // Palauttaa { homeMs, awayMs, homePct, awayPct }
            const pos = game.possession || {};
            let homeMs = 0, awayMs = 0;

            if (period === 'summary') {
                [1,2,3].forEach(p => {
                    if (pos[p]) { homeMs += pos[p].home || 0; awayMs += pos[p].away || 0; }
                });
            } else if ([1,2,3].includes(period)) {
                homeMs = (pos[period]?.home || 0);
                awayMs = (pos[period]?.away || 0);

                // Jos kyseess√§ on NYKYINEN er√§ ja timer k√§y, lasketaan k√§ynniss√§ oleva segmentti mukaan n√§ytt√∂√∂n
                if (game === currentGame && currentGame.currentPeriod === period && typeof performance !== 'undefined' && posActiveTeam && posLastSwitch != null) {
                    const delta = performance.now() - posLastSwitch;
                    if (posActiveTeam === 'home') homeMs += delta; else awayMs += delta;
                }
            } else {
                // Muissa n√§kymiss√§ n√§ytet√§√§n summat
                [1,2,3].forEach(p => {
                    if (pos[p]) { homeMs += pos[p].home || 0; awayMs += pos[p].away || 0; }
                });
            }

            const total = homeMs + awayMs;
            const homePct = total ? ((homeMs / total) * 100) : 50;
            const awayPct = total ? 100 - homePct : 50;

            return {
                homeMs, awayMs,
                homePct: Number(homePct.toFixed(1)),
                awayPct: Number(awayPct.toFixed(1))
            };
        }

        function renderPlusMinusView() {
          plusMinusView.innerHTML = `
            <div class="w-full max-w-4xl mx-auto my-auto bg-slate-900 text-slate-200 p-6 rounded-lg">
              <h2 class="text-2xl font-bold mb-5 text-center">+ / ‚àí Merkint√§</h2>

              <!-- TILAKYTKIN -->
              <div class="flex justify-center gap-2 mb-5">
                <button id="pm-mode-plus"  class="pm-mode-btn ${pmMode==='plus' ? 'pm-mode-plus' : 'pm-mode-off'}">+ Oma maali</button>
                <button id="pm-mode-minus" class="pm-mode-btn ${pmMode==='minus'? 'pm-mode-minus': 'pm-mode-off'}">‚àí Vastustajan maali</button>
                <button id="pm-mode-off"   class="pm-mode-btn pm-mode-off">Pois</button>
              </div>

              <!-- Pelaajapainikkeet -->
              <div id="pm-home" class="grid grid-cols-4 lg:grid-cols-5 gap-4 mb-5"></div>

              <!-- Alapalkki -->
              <div class="pm-footer">
                <span class="pm-badge">Valittuja +: ${pmSelectedPlus.size} ‚Ä¢ ‚àí: ${pmSelectedMinus.size}</span>
                <button id="pm-confirm" class="pm-confirm">Vahvista</button>
                <button id="pm-clear"   class="pm-clear">Tyhjenn√§</button>
              </div>

              <div id="plus-minus-summary" class="mt-6 border-t border-slate-700 pt-4"></div>
            </div>`;

          // Luo vain KOTI-pelaajapainikkeet
          const homeC = document.getElementById('pm-home');
          (currentGame.players || []).forEach(num => {
            const btn = document.createElement('button');
            btn.className = 'player-number pm-player-btn';
            btn.textContent = num;
            btn.dataset.player = num;
            if (pmSelectedPlus.has(num))  btn.classList.add('pm-select-plus');
            if (pmSelectedMinus.has(num)) btn.classList.add('pm-select-minus');
            homeC.appendChild(btn);
          });

          // Kytkimet
          document.getElementById('pm-mode-plus').onclick  = () => { pmMode = 'plus'; renderPlusMinusView(); };
          document.getElementById('pm-mode-minus').onclick = () => { pmMode = 'minus'; renderPlusMinusView(); };
          document.getElementById('pm-mode-off').onclick   = () => { pmMode = null;   renderPlusMinusView(); };

          document.getElementById('pm-clear').onclick = () => {
            pmSelectedPlus.clear();
            pmSelectedMinus.clear();
            renderPlusMinusView();
          };

          document.getElementById('pm-confirm').onclick = () => {
            // Kirjaa kootusti: + lis√§t√§√§n plusiin, ‚àí lis√§t√§√§n minukseen
            pmSelectedPlus.forEach(num  => { if(currentGame.plusMinus[num]) currentGame.plusMinus[num].plus++;  });
            pmSelectedMinus.forEach(num => { if(currentGame.plusMinus[num]) currentGame.plusMinus[num].minus++; });

            // Nollaa valinnat ja tila
            pmSelectedPlus.clear();
            pmSelectedMinus.clear();
            pmMode = null;

            renderPlusMinusView();
            renderPlusMinusSummary && renderPlusMinusSummary();
          };

          // Pelaajapainikkeiden klikkilogiikka (vain koti)
          homeC.addEventListener('click', onPmPlayerClick);

          renderPlusMinusSummary && renderPlusMinusSummary();
        }
        function renderPlusMinusSummary() { const container = document.getElementById('plus-minus-summary'); if (!container) return; let html = `<h3 class="text-xl font-bold text-center mb-3">+/- Saldo</h3><div class="grid grid-cols-4 text-center font-semibold text-xs text-slate-400 mb-2 px-1"><span>Pelaaja</span><span>+</span><span>-</span><span>Yht.</span></div>`; (currentGame.players || []).forEach(pNum => { const stats = currentGame.plusMinus[pNum], bal = (stats.plus || 0) - (stats.minus || 0); const name = (currentGame.roster[pNum] || '').split(' ')[0] || ''; html += `<div class="grid grid-cols-4 text-center text-sm py-2 border-b border-slate-700 items-center"><span class="font-bold text-left truncate pr-2">#${pNum} ${name}</span><button data-player="${pNum}" data-type="remove-plus" class="font-mono text-lg text-emerald-500">${stats.plus || 0}</button><button data-player="${pNum}" data-type="remove-minus" class="font-mono text-lg text-red-500">${stats.minus || 0}</button><span class="font-semibold text-lg">${bal > 0 ? '+' : ''}${bal}</span></div>`; }); container.innerHTML = html; }
        
        function renderSeasonStats(sortKey = 'name', sortDir = 'asc') {
            try {
                if (!Array.isArray(seasonData.games)) seasonData.games = [];
                const { playerStats, fullRoster, allPlayers } = calculateSeasonStats();
                
                let sortedPlayers = [...allPlayers];
                sortedPlayers.sort((a, b) => {
                    const statsA = playerStats[a] || { games:0, shots:0, goals:0, plus:0, minus:0, qualityHigh:0, qualityLow:0, xg: 0 };
                    const statsB = playerStats[b] || { games:0, shots:0, goals:0, plus:0, minus:0, qualityHigh:0, qualityLow:0, xg: 0 };
                    let valA, valB;

                    switch (sortKey) {
                        case 'name': valA = fullRoster[a] || ''; valB = fullRoster[b] || ''; break;
                        case 'games': valA = statsA.games; valB = statsB.games; break;
                        case 'shots': valA = statsA.shots; valB = statsB.shots; break;
                        case 'goals': valA = statsA.goals; valB = statsB.goals; break;
                        case 'xg': valA = statsA.xg; valB = statsB.xg; break;
                        case 'plus': valA = statsA.qualityHigh; valB = statsB.qualityHigh; break;
                        case 'minus': valA = statsA.qualityLow; valB = statsB.qualityLow; break;
                        case 'pm': valA = statsA.plus - statsA.minus; valB = statsB.plus - statsB.minus; break;
                        default: return 0;
                    }

                    if (typeof valA === 'string') {
                        return sortDir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    }
                    return sortDir === 'asc' ? valA - valB : valB - valA;
                });

                let playerTable = `<div class="flex justify-between items-center"><h3 class="text-xl font-bold text-slate-100 mb-3">Pelaajatilastot</h3><button id="share-players-btn" class="bg-emerald-600 text-sm font-semibold py-2 px-4 rounded-lg">Jaa</button></div>
                <div class="grid grid-cols-9 text-center font-semibold text-xs text-slate-400 mb-2 px-1">
                    <span class="col-span-2 sortable" data-sort="name">Pelaaja</span>
                    <span class="sortable" data-sort="games">O</span>
                    <span class="sortable" data-sort="shots">L</span>
                    <span class="sortable" data-sort="goals">M</span>
                    <span class="sortable" data-sort="xg">xG</span>
                    <span class="sortable" data-sort="plus">L+</span>
                    <span class="sortable" data-sort="minus">H-</span>
                    <span class="sortable" data-sort="pm">+/-</span>
                </div>`;

                sortedPlayers.forEach(pNum => { 
                    const stats = playerStats[pNum] || { games:0, shots:0, goals:0, plus:0, minus:0, qualityHigh:0, qualityLow:0, xg: 0 }; 
                    const bal = (stats.plus || 0) - (stats.minus || 0); 
                    const name = fullRoster[pNum] || ''; 
                    playerTable += `<div class="grid grid-cols-9 text-center text-sm py-1.5 border-b border-slate-700 items-center">
                        <span class="font-bold text-left col-span-2 truncate">#${pNum} ${name}</span>
                        <span>${stats.games}</span>
                        <span>${stats.shots}</span>
                        <span>${stats.goals}</span>
                        <span>${stats.xg.toFixed(2)}</span>
                        <span class="text-red-400 font-semibold">${stats.qualityHigh || 0}</span>
                        <span class="text-blue-400 font-semibold">${stats.qualityLow || 0}</span>
                        <span class="font-semibold">${bal > 0 ? '+' : ''}${bal}</span>
                    </div>`; 
                });

                const safeGames = Array.isArray(seasonData.games) ? [...seasonData.games] : [];
                safeGames.sort((a, b) => safeDateValue(b) - safeDateValue(a));
                let gamesTable = `<h3 class="text-xl font-bold text-slate-100 my-4">Tallennetut ottelut</h3>`;
                if (safeGames.length > 0) {
                    safeGames.forEach(game => {
                        const s = getGameStats(game);
                        const possG = getPossessionPctFor(game, 'summary');
                        const ts = safeDateValue(game);
                        const dateStr = Number.isFinite(ts) ? new Date(ts).toLocaleDateString('fi-FI') : '‚Äî';
                        const possRowHtml = `<p class="text-sm text-slate-400 mt-1">Pallonhallinta: ${possG.homePct}% - ${possG.awayPct}%</p>`;
                        gamesTable += `<details class="bg-slate-900 rounded-lg shadow mb-2"><summary class="flex justify-between items-center p-3 font-semibold"><div><p class="font-bold">${dateStr} vs ${game.opponent || ''}</p><p class="text-sm text-slate-300">Tulos: ${s.home.goals} - ${s.away.goals}</p>${possRowHtml}</div></summary><div class="p-4 border-t border-slate-700">${generateGameDetailsHTML(game)}<div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mt-4"><button data-game-id="${game.id}" class="generate-pdf-btn bg-purple-600 text-sm font-semibold py-2 px-4 rounded-lg">Luo PDF-raportti</button><button data-game-id="${game.id}" class="share-game-btn bg-emerald-600 text-sm font-semibold py-2 px-4 rounded-lg">Jaa data</button><button data-game-id="${game.id}" class="delete-game-btn bg-red-600 text-sm font-semibold py-2 px-4 rounded-lg">Poista ottelu</button></div></div></details>`;
                    });
                } else { gamesTable += `<p class="text-center text-slate-400">Ei tallennettuja otteluita.</p>`; }
                seasonView.innerHTML = `<div class="w-full max-w-4xl mx-auto"><button id="new-game-from-season-btn" class="w-full bg-indigo-600 font-bold py-3 rounded-lg mb-6">Aloita uusi ottelu</button><div class="bg-slate-800 p-6 rounded-lg">${playerTable}</div><div class="mt-6 bg-slate-800 p-6 rounded-lg">${gamesTable}</div></div>`;
                
                seasonView.querySelectorAll('.sortable').forEach(header => {
                    const key = header.dataset.sort;
                    if (key === sortKey) {
                        header.classList.add(sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                    header.addEventListener('click', () => {
                        const newSortDir = (sortKey === key && sortDir === 'asc') ? 'desc' : 'asc';
                        renderSeasonStats(key, newSortDir);
                    });
                });

                seasonView.addEventListener('click', (e) => {
                    const newGameBtn = e.target.closest('#new-game-from-season-btn');
                    const sharePlayersBtn = e.target.closest('#share-players-btn');
                    const shareGameBtn = e.target.closest('.share-game-btn');
                    const deleteGameBtn = e.target.closest('.delete-game-btn');
                    const pdfBtn = e.target.closest('.generate-pdf-btn');
                    const playerReportBtn = e.target.closest('.player-report-btn');

                    if (newGameBtn) { showMainView('setup'); prefillRosterInput(); } 
                    else if (sharePlayersBtn) { shareDataByEmail('players'); } 
                    else if (shareGameBtn) { shareDataByEmail('game', shareGameBtn.dataset.gameId); } 
                    else if (deleteGameBtn) { e.preventDefault(); showConfirmation('Poista ottelu?', 'Haluatko varmasti poistaa t√§m√§n ottelun?', 'Kyll√§, poista', 'bg-red-600', () => deleteGameFromFirestore(deleteGameBtn.dataset.gameId)); }
                    else if (pdfBtn) { 
                        e.preventDefault(); 
                        window.__allowBlobNavFor();
                        generatePdfReport(pdfBtn.dataset.gameId, pdfBtn); 
                    }
                    else if (playerReportBtn) { 
                        e.preventDefault(); 
                        window.__allowBlobNavFor();
                        generatePlayerPdfReport(playerReportBtn.dataset.gameId, playerReportBtn.dataset.playerNum, playerReportBtn); 
                    }
                });
            } catch (err) {
                seasonView.innerHTML = `<div class="w-full max-w-2xl mx-auto bg-red-900/30 border border-red-700 text-red-200 p-4 rounded"><p class="font-bold mb-2">Kausidatan render√∂inti ep√§onnistui.</p><p class="text-sm opacity-80">Virhe: ${err?.message || err}</p></div>`;
            }
        }
        function safeDateValue(game) { if (game?.date) { const d = new Date(game.date); if (!isNaN(+d)) return +d; } const asNum = Number(game?.id); return Number.isFinite(asNum) ? asNum : NaN; }
        
        function getGameStats(game) {
            const s = { home: { goals:0, shots:0, xg:0, saves:0, blocks:0, qualityHigh: 0, qualityLow: 0, ppGoals:0, shGoals:0 }, away: { goals:0, shots:0, xg:0, saves:0, blocks:0, qualityHigh: 0, qualityLow: 0, ppGoals:0, shGoals:0 } };
            const shots = Array.isArray(game?.shots) ? game.shots : [];
            shots.forEach(shot => {
                const teamKey = (shot.team === 'away') ? 'away' : 'home'; const oppKey  = (teamKey === 'home') ? 'away' : 'home';
                const shooter = s[teamKey], opponent = s[oppKey];
                shooter.shots++; 
                shooter.xg += calculateXg(shot.x, shot.y, shot.team); // Recalculate xG
                if (shot.quality === 'high') shooter.qualityHigh++; if (shot.quality === 'low')  shooter.qualityLow++;
                if (shot.outcome === 'goal') {
                    shooter.goals++;
                    if (shot.special === 'YV') shooter.ppGoals++;
                    if (shot.special === 'AV') shooter.shGoals++;
                }
                if (shot.outcome === 'save') opponent.saves++; if (shot.outcome === 'block') opponent.blocks++;
            });
            return s;
        }

        function generateGameDetailsHTML(game) {
            const gameStats = getGameStats(game);
            const roster  = game?.roster || {}; 
            const shots   = Array.isArray(game?.shots) ? game.shots : []; 
            const pmAll   = game?.plusMinus || {}; 
            let html = '';
            const allGamePlayers = Array.isArray(game?.players) ? game.players.slice().sort((a,b)=>a-b) : [];

            let playerStats = allGamePlayers.map(pNum => {
                const p = Number(pNum);
                const pShots = shots.filter(s => s.team === 'home' && Number(s.player) === p);
                const xg = pShots.reduce((sum, s) => sum + calculateXg(s.x, s.y, s.team), 0);
                const goals  = pShots.filter(s => s.outcome === 'goal').length;
                const qH = pShots.filter(s => s.quality === 'high').length;
                const qL = pShots.filter(s => s.quality === 'low').length;
                const pm = pmAll[p] || pmAll[String(p)] || { plus:0, minus:0 };
                const bal = (pm.plus || 0) - (pm.minus || 0);
                const name = roster[p] || roster[String(p)] || '';
                return { pNum, name, shots: pShots.length, goals, xg, qH, qL, bal };
            });

            const sortKey = sortState.game || 'name';
            const sortDir = sortState.gameDir || 'asc';

            playerStats.sort((a, b) => {
                let valA, valB;
                switch (sortKey) {
                    case 'name': valA = a.name; valB = b.name; break;
                    case 'shots': valA = a.shots; valB = b.shots; break;
                    case 'goals': valA = a.goals; valB = b.goals; break;
                    case 'xg': valA = a.xg; valB = b.xg; break;
                    case 'qH': valA = a.qH; valB = b.qH; break;
                    case 'qL': valA = a.qL; valB = b.qL; break;
                    case 'bal': valA = a.bal; valB = b.bal; break;
                    default: return 0;
                }
                if (typeof valA === 'string') {
                    return sortDir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                return sortDir === 'asc' ? valA - valB : valB - valA;
            });

            playerStats.forEach(stats => {
                const { pNum, name, shots, goals, xg, qH, qL, bal } = stats;
                const playerButton = `<button class="player-report-btn font-semibold text-left col-span-2 truncate text-indigo-400 hover:text-indigo-300" data-game-id="${game.id}" data-player-num="${pNum}">#${pNum} ${name}</button>`;
                html += `<div class="grid grid-cols-9 text-center text-xs py-1 border-b border-slate-700 items-center">
                    ${playerButton}
                    <span>${shots}</span>
                    <span>${goals}</span>
                    <span>${xg.toFixed(2)}</span>
                    <span class="text-red-400">${qH}</span>
                    <span class="text-blue-400">${qL}</span>
                    <span>${shots > 0 ? `${Math.round((goals/shots)*100)}%` : '‚Äî'}</span>
                    <span class="font-semibold">${bal > 0 ? '+' : ''}${bal}</span>
                </div>`;
            });

            const headerHTML = `
                <div class="grid grid-cols-9 text-center font-bold text-xs text-slate-400 mt-2 px-1">
                    <span class="col-span-2 sortable" data-sort-game="name">Nimi</span>
                    <span class="sortable" data-sort-game="shots">L</span>
                    <span class="sortable" data-sort-game="goals">M</span>
                    <span class="sortable" data-sort-game="xg">xG</span>
                    <span class="sortable" data-sort-game="qH">L+</span>
                    <span class="sortable" data-sort-game="qL">H-</span>
                    <span>T%</span>
                    <span class="sortable" data-sort-game="bal">+/-</span>
                </div>`;

            const container = document.createElement('div');
            container.innerHTML = `<div class="space-y-3"><div><p class="font-semibold text-sm">Joukkueet</p><div class="text-xs text-slate-400 mt-1"><p><b>Koti:</b> L ${gameStats.home.shots}, xG ${gameStats.home.xg.toFixed(2)}, L+ ${gameStats.home.qualityHigh}, H- ${gameStats.home.qualityLow}, T ${gameStats.home.saves}, B ${gameStats.home.blocks}</p><p><b>Vieras:</b> L ${gameStats.away.shots}, xG ${gameStats.away.xg.toFixed(2)}, L+ ${gameStats.away.qualityHigh}, H- ${gameStats.away.qualityLow}, T ${gameStats.away.saves}, B ${gameStats.away.blocks}</p></div></div><div><p class="font-semibold text-sm mt-3">Pelaajat</p>${headerHTML}${html || `<div class="text-center text-slate-400 py-2">Ei pelaajakohtaisia tilastoja.</div>`}</div></div>`;
            
            container.querySelectorAll('[data-sort-game]').forEach(header => {
                const key = header.dataset.sortGame;
                if(key === sortState.game) {
                    header.classList.add(sortState.gameDir === 'asc' ? 'sort-asc' : 'sort-desc');
                }
                header.addEventListener('click', () => {
                    const newSortDir = (sortState.game === key && sortState.gameDir === 'asc') ? 'desc' : 'asc';
                    sortState.game = key;
                    sortState.gameDir = newSortDir;
                    const details = header.closest('details');
                    details.querySelector('.p-4').innerHTML = generateGameDetailsHTML(game);
                });
            });

            return container.innerHTML;
        }
        
        function ensureConfirmModalContent() { if (!document.getElementById('confirm-btn')) { confirmModal.innerHTML = `<div class="bg-white rounded-lg shadow-xl p-6 max-w-sm text-center"><h3 id="confirm-title" class="text-xl font-bold text-slate-800 mb-4"></h3><p id="confirm-text" class="text-slate-600 mb-6"></p><div class="flex justify-center gap-4"><button id="cancel-confirm-btn" class="px-6 py-2 rounded-lg bg-slate-200 text-slate-800">Peruuta</button><button id="confirm-btn" class="px-6 py-2 rounded-lg text-white font-semibold"></button></div></div>`; document.getElementById('cancel-confirm-btn').addEventListener('click', () => confirmModal.classList.add('hidden')); } }
        function showConfirmation(title, text, btnText, btnClass, callback) { ensureConfirmModalContent(); const confirmTitle = document.getElementById('confirm-title'); const confirmText  = document.getElementById('confirm-text'); const btn          = document.getElementById('confirm-btn'); confirmTitle.textContent = title; confirmText.textContent  = text; btn.textContent          = btnText; btn.className            = `px-6 py-2 rounded-lg text-white font-semibold ${btnClass}`; const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn); newBtn.addEventListener('click', () => { try { callback(); } finally { confirmModal.classList.add('hidden'); } }); confirmModal.classList.remove('hidden'); }
        function shareDataByEmail(type, gameId = null) {
            let subject = "", textBody = "", xlsxFilename = "";
            const { playerStats, fullRoster, allPlayers } = calculateSeasonStats();
            if (type === 'players') {
                subject = "Kauden pelaajatilastot"; textBody = generateShareableText_Players(playerStats, fullRoster, allPlayers); xlsxFilename = "pelaajatilastot.xlsx";
                generateAndDownloadXLSX_Players(playerStats, fullRoster, allPlayers, xlsxFilename);
            } else if (type === 'game' && gameId) {
                const game = seasonData.games.find(g => g.id === gameId); if (!game) return;
                subject = `Ottelukooste: ${new Date(game.date).toLocaleDateString('fi-FI')} vs ${game.opponent}`; textBody = generateShareableText_Game(game);
                xlsxFilename = `ottelu_${game.opponent}_${new Date(game.date).toLocaleDateString('fi-FI').replace(/\./g, '-')}.xlsx`;
                generateAndDownloadXLSX_Game(game, xlsxFilename);
            } else { return; }
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(textBody + "\n\n---\nLataa liitteeksi juuri tallentunut tiedosto: " + xlsxFilename)}`;
            showConfirmation( 'Lataus valmis', `Tiedosto "${xlsxFilename}" on ladattu. L√∂yd√§t sen selaimesi latausvalikosta tai laitteesi Tiedostot-sovelluksesta.`, 'Avaa s√§hk√∂posti', 'bg-emerald-600', () => { window.location.href = mailtoLink; });
        }
        function calculateSeasonStats() { 
            const fullRoster = {}, seasonPlayerStats = {}; 
            (seasonData.games || []).forEach(g => Object.assign(fullRoster, g.roster || {})); 
            const allPlayers = [...new Set((seasonData.games || []).flatMap(g => g.players || []))].map(n=>Number(n)).filter(n=>!isNaN(n)).sort((a,b)=>a-b); 
            allPlayers.forEach(p => { seasonPlayerStats[p] = { games: 0, shots: 0, goals: 0, xg: 0, plus: 0, minus: 0, qualityHigh: 0, qualityLow: 0 }; }); 
            (seasonData.games || []).forEach(game => { 
                (game.players || []).forEach(pNum => { 
                    const p = Number(pNum); 
                    if (seasonPlayerStats[p]) seasonPlayerStats[p].games++; 
                }); 
                (game.shots || []).forEach(shot => { 
                    if (shot.team === 'home') { 
                        const p = Number(shot.player); 
                        if (seasonPlayerStats[p]) { 
                            seasonPlayerStats[p].shots++; 
                            seasonPlayerStats[p].xg += calculateXg(shot.x, shot.y, shot.team);
                            if (shot.outcome === 'goal') seasonPlayerStats[p].goals++; 
                            if (shot.quality === 'high') seasonPlayerStats[p].qualityHigh++; 
                            if (shot.quality === 'low') seasonPlayerStats[p].qualityLow++; 
                        } 
                    } 
                }); 
                Object.keys(game.plusMinus || {}).forEach(pNum => { 
                    const p = Number(pNum); 
                    if (seasonPlayerStats[p]) { 
                        seasonPlayerStats[p].plus += game.plusMinus[pNum].plus || 0; 
                        seasonPlayerStats[p].minus += game.plusMinus[pNum].minus || 0; 
                    } 
                }); 
            }); 
            return { playerStats: seasonPlayerStats, fullRoster, allPlayers }; 
        }
        function generateShareableText_Players(playerStats, fullRoster, allPlayers) { let text = "Pelaajatilastot:\n\nPelaaja\tOtt.\tLauk.\tMaalit\tL+\tH-\tT%\t+/-\n" + "-".repeat(60) + "\n"; allPlayers.forEach(pNum => { const stats = playerStats[pNum], eff = stats.shots > 0 ? `${Math.round((stats.goals / stats.shots) * 100)}%` : '‚Äî', bal = stats.plus - stats.minus; text += `#${pNum} ${fullRoster[pNum] || ''}\t${stats.games}\t${stats.shots}\t${stats.goals}\t${stats.qualityHigh || 0}\t${stats.qualityLow || 0}\t${eff}\t${bal > 0 ? '+' : ''}${bal}\n`; }); return text; }
        function generateShareableText_Game(game) { const gameStats = getGameStats(game); let text = `Ottelukooste: ${new Date(game.date).toLocaleDateString('fi-FI')} vs ${game.opponent}\nLopputulos: ${gameStats.home.goals} - ${gameStats.away.goals}\n\nJoukkueiden tilastot:\nKoti:\tLauk. ${gameStats.home.shots}, xG ${gameStats.home.xg.toFixed(2)}, L+ ${gameStats.home.qualityHigh}, H- ${gameStats.home.qualityLow}, Torj. ${gameStats.home.saves}, Blok. ${gameStats.home.blocks}\nVieras:\tLauk. ${gameStats.away.shots}, xG ${gameStats.away.xg.toFixed(2)}, L+ ${gameStats.away.qualityHigh}, H- ${gameStats.away.qualityLow}, Torj. ${gameStats.away.saves}, B ${gameStats.away.blocks}\n\nPelaajakohtaiset tilastot:\nPelaaja`.padEnd(20) + "L\tM\tL+\tH-\tT%\t+/-\n" + "-".repeat(60) + "\n"; game.players.forEach(pNum => { const shots = game.shots.filter(s => s.team === 'home' && s.player == pNum); const goals = shots.filter(s => s.outcome === 'goal').length; const qH = shots.filter(s=>s.quality==='high').length; const qL = shots.filter(s=>s.quality==='low').length; const pm = game.plusMinus[pNum]; if (shots.length > 0 || (pm && (pm.plus > 0 || pm.minus > 0))) { const eff = shots.length > 0 ? `${Math.round((goals / shots.length) * 100)}%` : '‚Äî'; const bal = (pm?.plus || 0) - (pm?.minus || 0); const playerName = `#${pNum} ${game.roster[pNum] || ''}`; text += `${playerName.padEnd(20)}\t${shots.length}\t${goals}\t${qH}\t${qL}\t${eff}\t${bal > 0 ? '+' : ''}${bal}\n`; } }); return text; }
        function generateAndDownloadXLSX_Players(playerStats, fullRoster, allPlayers, filename) { const data = [["Pelaaja", "Ottelut", "Laukaukset", "Maalit", "Laadukkaat", "Heikot", "Teho %", "+/-"]]; allPlayers.forEach(pNum => { const stats = playerStats[pNum]; data.push([`#${pNum} ${fullRoster[pNum] || ''}`, stats.games, stats.shots, stats.goals, stats.qualityHigh || 0, stats.qualityLow || 0, stats.shots > 0 ? (stats.goals / stats.shots) : 0, stats.plus - stats.minus]); }); const ws = XLSX.utils.aoa_to_sheet(data); ws['!cols'] = [{wch:20}, {wch:8}, {wch:10}, {wch:8}, {wch:10}, {wch:8}, {wch:8}, {wch:8}]; for (let i = 2; i <= data.length; i++) { if(ws[`G${i}`]) { ws[`G${i}`].t = 'n'; ws[`G${i}`].z = '0%'; } } const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Pelaajatilastot"); downloadXLSX(wb, filename); }
        function generateAndDownloadXLSX_Game(game, filename) { const data = [["Pelaaja", "Laukaukset", "Maalit", "Laadukkaat", "Heikot", "Teho %", "+/-"]]; game.players.forEach(pNum => { const shots = game.shots.filter(s => s.team === 'home' && s.player == pNum), goals = shots.filter(s => s.outcome === 'goal').length; const qH = shots.filter(s=>s.quality==='high').length; const qL = shots.filter(s=>s.quality==='low').length; const pm = game.plusMinus[pNum]; if (shots.length > 0 || pm?.plus > 0 || pm?.minus > 0) { data.push([`#${pNum} ${game.roster[pNum]||''}`, shots.length, goals, qH, qL, shots.length > 0 ? (goals/shots.length):0, (pm?.plus || 0) - (pm?.minus || 0)]); } }); const ws = XLSX.utils.aoa_to_sheet(data); ws['!cols'] = [{wch:20}, {wch:10}, {wch:8}, {wch:10}, {wch:8}, {wch:8}, {wch:8}]; for (let i = 2; i <= data.length; i++) { if(ws[`F${i}`]) { ws[`F${i}`].t = 'n'; ws[`F${i}`].z = '0%'; } } const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, `Ottelu ${game.opponent}`); downloadXLSX(wb, filename); }
        function downloadXLSX(workbook, filename) { const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' }); const blob = new Blob([wbout], { type: 'application/octet-stream' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); }
        
        async function generatePdfReport(gameId, buttonElement) {
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'Luodaan‚Ä¶';
            buttonElement.disabled = true;

            try {
                const game = (seasonData.games || []).find(g => g.id === gameId);
                if (!game) throw new Error('Ottelua ei l√∂ytynyt.');

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

                const dateStr = game.date ? new Date(game.date).toLocaleDateString('fi-FI') : '';
                const filename = `Otteluraportti ${game.opponent || ''} ${dateStr}.pdf`;
                doc.setProperties({
                    title: filename
                });


                const margin = 10;
                const pageW = doc.internal.pageSize.getWidth();
                const pageH = doc.internal.pageSize.getHeight();
                let yPos = margin;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(18);
                doc.text(`Otteluraportti: ${game.opponent || ''}`, pageW / 2, yPos, { align: 'center' });
                yPos += 8;
                doc.setFontSize(12);
                doc.text(dateStr, pageW / 2, yPos, { align: 'center' });
                yPos += 15;

                for (const period of [1, 2, 3, 'summary']) {
                    const title = period === 'summary' ? 'Koko ottelu' : `Er√§ ${period}`;
                    const stats = getStatsForPeriod(game, period);
                    const poss = getPossessionPctFor(game, period);
                    const mapContainer = createShotmapElement(game, period);
                    document.body.appendChild(mapContainer);
                    await new Promise(r => requestAnimationFrame(() => r()));
                    const canvas = await html2canvas(mapContainer, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        useCORS: true
                    });
                    document.body.removeChild(mapContainer);

                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 140;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    const sectionHeight = imgHeight + 70; // Arvioi osion korkeus
                    if (yPos + sectionHeight > pageH - margin && period !== 1) {
                        doc.addPage();
                        yPos = margin;
                    }

                    doc.setFontSize(14);
                    doc.text(title, margin, yPos);
                    yPos += 8;
                    
                    doc.addImage(imgData, 'PNG', margin, yPos, imgWidth, imgHeight);
                    yPos += imgHeight + 5;

                    callAutoTable(doc, {
                        startY: yPos,
                        margin: { left: margin },
                        theme: 'grid',
                        head: [['Tapahtuma', 'Koti', 'Vieras']],
                        body: [
                            ['Maalit', stats.home.goals, stats.away.goals],
                            ['YV-maalit', stats.home.ppGoals || 0, stats.away.ppGoals || 0],
                            ['AV-maalit', stats.home.shGoals || 0, stats.away.shGoals || 0],
                            ['Laukaukset', stats.home.shots, stats.away.shots],
                            ['xG', stats.home.xg.toFixed(2), stats.away.xg.toFixed(2)],
                            ['Laadukkaat (L+)', stats.home.qualityHigh, stats.away.qualityHigh],
                            ['Heikot (H-)', stats.home.qualityLow, stats.away.qualityLow],
                            ['Torjunnat', stats.home.saves, stats.away.saves],
                            ['Blokit', stats.home.blocks, stats.away.blocks],
                            ['Pallonhallinta %', `${poss.homePct}%`, `${poss.awayPct}%`],
                        ],
                        styles: { font: 'helvetica', fontSize: 10 },
                        headStyles: { fillColor: [41, 52, 72], textColor: 255 },
                        columnStyles: { 0:{cellWidth:40}, 1:{cellWidth:20, halign:'right'}, 2:{cellWidth:20, halign:'right'} }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 15;
                }

                doc.addPage();
                yPos = margin;
                doc.setFontSize(16);
                doc.text('Pelaajakohtaiset tilastot', pageW / 2, yPos, { align: 'center' });
                yPos += 10;
                generatePlayerStatsForPdf(doc, game, yPos);

                doc.save(filename);

            } catch (err) {
                console.error('PDF-raportin luonti ep√§onnistui:', err);
                alert(`Raportin luonti ep√§onnistui: ${err?.message || err}`);
            } finally {
                buttonElement.textContent = originalText;
                buttonElement.disabled = false;
            }
        }
        
        async function generatePlayerPdfReport(gameId, playerNum, buttonElement) {
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'Luodaan‚Ä¶';
            buttonElement.disabled = true;

            try {
                const game = (seasonData.games || []).find(g => g.id === gameId);
                if (!game) throw new Error('Ottelua ei l√∂ytynyt.');
                
                const pNum = Number(playerNum);
                const playerName = (game.roster?.[pNum] || '').trim();
                const playerLastName = playerName.split(' ').pop() || `Pelaaja ${pNum}`;
                const playerDisplay = playerName ? `#${pNum} ${playerName}` : `#${pNum}`;

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const dateStr = game.date ? new Date(game.date).toLocaleDateString('fi-FI') : '';
                const filename = `Otteluraportti ${playerLastName} - ${game.opponent || ''} ${dateStr}.pdf`;
                doc.setProperties({
                    title: `Pelaajaraportti ${playerDisplay} vs ${game.opponent || ''}`
                });

                const margin = 10;
                const pageW = doc.internal.pageSize.getWidth();
                const pageH = doc.internal.pageSize.getHeight();
                let yPos = margin;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(18);
                doc.text(`Pelaajaraportti: ${playerDisplay}`, pageW / 2, yPos, { align: 'center' });
                yPos += 8;
                doc.setFontSize(12);
                doc.text(`Ottelu vs ${game.opponent || ''} - ${dateStr}`, pageW / 2, yPos, { align: 'center' });
                yPos += 15;

                for (const period of ['summary', 1, 2, 3]) {
                    const isSummary = period === 'summary';
                    const title = isSummary ? 'Koko ottelu' : `Er√§ ${period}`;
                    
                    const playerShots = (game.shots || []).filter(s => {
                        if (s.team === 'home') return Number(s.player) === pNum;
                        return false;
                    });

                    const periodShots = isSummary ? playerShots : playerShots.filter(s => s.period === period);

                    if (!isSummary && periodShots.length === 0) {
                        continue;
                    }

                    const stats = getPlayerStatsForPeriod(game, pNum, period);
                    const mapContainer = createShotmapElement({ shots: periodShots }, 'summary');
                    document.body.appendChild(mapContainer);
                    await new Promise(r => requestAnimationFrame(() => r()));
                    const canvas = await html2canvas(mapContainer, { scale: 2, backgroundColor: '#ffffff', useCORS: true });
                    document.body.removeChild(mapContainer);

                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 140;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    const sectionHeight = imgHeight + 60; 
                    if (yPos + sectionHeight > pageH - margin) {
                        doc.addPage();
                        yPos = margin;
                    }

                    doc.setFontSize(14);
                    doc.text(title, margin, yPos);
                    yPos += 8;
                    
                    doc.addImage(imgData, 'PNG', margin, yPos, imgWidth, imgHeight);
                    yPos += imgHeight + 5;
                    
                    const pm = (game.plusMinus && game.plusMinus[pNum]) ? game.plusMinus[pNum] : { plus:0, minus:0 };
                    const bal = (pm.plus || 0) - (pm.minus || 0);
                    
                    callAutoTable(doc, {
                        startY: yPos,
                        margin: { left: margin },
                        theme: 'grid',
                        head: [['Tilasto', 'Arvo']],
                        body: [
                            ['Laukaukset', stats.shots],
                            ['Maalit', stats.goals],
                            ['xG', stats.xg.toFixed(2)],
                            ['Laadukkaat (L+)', stats.qualityHigh],
                            ['Heikot (H-)', stats.qualityLow],
                            ['Laukaisuprosentti', stats.shots > 0 ? `${Math.round((stats.goals / stats.shots) * 100)}%` : '‚Äî'],
                            ...(isSummary ? [['+/-', `${bal > 0 ? '+' : ''}${bal}`]] : [])
                        ],
                        styles: { font: 'helvetica', fontSize: 10 },
                        headStyles: { fillColor: [41, 52, 72], textColor: 255 },
                        columnStyles: { 0:{cellWidth:40}, 1:{cellWidth:30, halign:'right'} }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 15;
                }

                doc.save(filename);

            } catch (err) {
                console.error('Pelaajaraportin luonti ep√§onnistui:', err);
                alert(`Raportin luonti ep√§onnistui: ${err?.message || err}`);
            } finally {
                buttonElement.textContent = originalText;
                buttonElement.disabled = false;
            }
        }

        const callAutoTable = (doc, opts) => {
            if (window.jspdfAutoTable) return window.jspdfAutoTable(doc, opts);
            if (doc.autoTable) return doc.autoTable(opts);
            throw new Error('AutoTable-plugin ei ole ladattu');
        };

        function createShotmapElement(game, period) {
            const shots = (game?.shots || []).filter(s => period === 'summary' ? true : s.period === period);

            const W = 900, H = 450;    // kuvapinta PDF:√§√§ varten (2:1)
            const wrap = document.createElement('div');
            Object.assign(wrap.style, {
                position: 'fixed', left: '-10000px', top: '0',
                width: `${W}px`, height: `${H}px`,
                background: '#ffffff', borderRadius: '12px',
                boxShadow: '0 10px 30px rgba(0,0,0,.2)', overflow: 'hidden', zIndex: '-1'
            });

            // taustakentt√§
            wrap.innerHTML = `
                <svg id="pdfField" width="${W}" height="${H}" viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">
                    <rect x="0" y="0" width="400" height="200" fill="#ffffff" stroke="#1f2937" stroke-width="3"/>
                    <line x1="200" y1="0" x2="200" y2="200" stroke="#94a3b8" stroke-width="2"/>
                    <rect x="30"  y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"/>
                    <rect x="330" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"/>
                    <!-- Piirret√§√§n pisteet t√§h√§n ryhm√§√§n -->
                    <g id="marks"></g>
                </svg>
            `;
            const svg = wrap.querySelector('#pdfField');
            const gMarks = wrap.querySelector('#marks');

            const fillFor = o =>
                o === 'goal' ? '#10B981' :
                o === 'miss' ? '#3B82F6' :
                o === 'block' ? '#FACC15' : '#EF4444';

            const ringFor = q =>
                q === 'high' ? '#b91c1c' :
                q === 'low'  ? '#2563eb' : null;

            const ns = 'http://www.w3.org/2000/svg';

            shots.forEach(s => {
                // PDF-SVG koordinaatit (viewBox 400x200)
                const cx = Math.max(0, Math.min(400, (s.x/100)*400));
                const cy = Math.max(0, Math.min(200, (s.y/100)*200));

                const fill = fillFor(s.outcome);
                const ring = ringFor(s.quality);
                const textColor = (s.outcome === 'block') ? '#111827' : '#ffffff';
                const label = (String(s.player).toUpperCase() === 'V' || s.team === 'away') ? 'V' : s.player;

                // peruspallo
                const circle = document.createElementNS(ns,'circle');
                circle.setAttribute('cx', cx); circle.setAttribute('cy', cy);
                circle.setAttribute('r', 8.5); // ~34px @ 900x450
                circle.setAttribute('fill', fill);
                circle.setAttribute('stroke', '#ffffff');
                circle.setAttribute('stroke-width', '1.6');
                gMarks.appendChild(circle);

                // laadun keh√§
                if (ring) {
                    const ringC = document.createElementNS(ns,'circle');
                    ringC.setAttribute('cx', cx); ringC.setAttribute('cy', cy);
                    ringC.setAttribute('r', 10.5);
                    ringC.setAttribute('fill', 'none');
                    ringC.setAttribute('stroke', ring);
                    ringC.setAttribute('stroke-width', '3.2');
                    gMarks.appendChild(ringC);
                }

                // numero / "V" t√§sm√§lleen keskelle
                const t = document.createElementNS(ns,'text');
                t.textContent = label;
                t.setAttribute('x', cx); t.setAttribute('y', cy);
                t.setAttribute('font-size', '6.2');       // skaalautuu viewBoxiin
                t.setAttribute('font-weight', '700');
                t.setAttribute('fill', textColor);
                t.setAttribute('text-anchor', 'middle');
                t.setAttribute('dominant-baseline', 'middle'); // üëà pystykeskitys
                gMarks.appendChild(t);
            });

            return wrap;
        }

        function getStatsForPeriod(game, period) {
            const shots = (game?.shots || []).filter(s =>
                period === 'summary' ? true : s.period === period
            );
            const agg = {
                home: { goals: 0, shots: 0, xg: 0, saves: 0, blocks: 0, qualityHigh: 0, qualityLow: 0, ppGoals: 0, shGoals: 0 },
                away: { goals: 0, shots: 0, xg: 0, saves: 0, blocks: 0, qualityHigh: 0, qualityLow: 0, ppGoals: 0, shGoals: 0 }
            };
            shots.forEach(shot => {
                const team = shot.team === 'away' ? 'away' : 'home';
                const opp  = team === 'home' ? 'away' : 'home';
                agg[team].shots++;
                agg[team].xg += calculateXg(shot.x, shot.y, shot.team); // Recalculate xG
                if (shot.outcome === 'goal') {
                    agg[team].goals++;
                    if (shot.special === 'YV') agg[team].ppGoals++;
                    if (shot.special === 'AV') agg[team].shGoals++;
                }
                if (shot.outcome === 'save') agg[opp].saves++;
                if (shot.outcome === 'block') agg[opp].blocks++;
                if (shot.quality === 'high') agg[team].qualityHigh++;
                if (shot.quality === 'low')  agg[team].qualityLow++;
            });
            return agg;
        }

        function getPlayerStatsForPeriod(game, playerNum, period) {
            const pNum = Number(playerNum);
            const isSummary = period === 'summary';
            
            const shots = (game?.shots || []).filter(s => {
                const correctPlayer = (s.team === 'home' && Number(s.player) === pNum);
                if (!correctPlayer) return false;
                return isSummary ? true : s.period === period;
            });

            const agg = { goals: 0, shots: 0, xg: 0, qualityHigh: 0, qualityLow: 0 };
            shots.forEach(shot => {
                agg.shots++;
                agg.xg += calculateXg(shot.x, shot.y, shot.team); // Recalculate xG
                if (shot.outcome === 'goal') agg.goals++;
                if (shot.quality === 'high') agg.qualityHigh++;
                if (shot.quality === 'low')  agg.qualityLow++;
            });
            return agg;
        }
        
        function generatePlayerStatsForPdf(doc, game, startY = 20) {
            const rows = [];
            const players = (game.players || []).slice().sort((a,b)=>a-b);
            players.forEach(pNum => {
                const p = Number(pNum); 
                const pShots = (game.shots || []).filter(s => s.team === 'home' && Number(s.player) === p);
                const goals  = pShots.filter(s => s.outcome === 'goal').length; 
                const qH = pShots.filter(s => s.quality === 'high').length; 
                const qL = pShots.filter(s => s.quality === 'low').length; 
                const pm = (game.plusMinus && game.plusMinus[p]) ? game.plusMinus[p] : { plus:0, minus:0 };
                
                const bal = (pm.plus || 0) - (pm.minus || 0); 
                const name = (game.roster?.[p] || '').trim();
                const display = name ? `#${p} ${name}` : `#${p}`;
                
                rows.push([
                    display, 
                    pShots.length, 
                    goals, 
                    qH, 
                    qL, 
                    pShots.length > 0 ? `${Math.round((goals/pShots.length)*100)}%` : '‚Äî', 
                    `${bal > 0 ? '+' : ''}${bal}`
                ]);
            });
            callAutoTable(doc, {
                startY,
                theme: 'grid',
                head: [['Pelaaja', 'Lauk.', 'Maalit', 'L+', 'H-', 'T%', '+/-']],
                body: rows.length ? rows : [['‚Äî', 0, 0, 0, 0, '‚Äî', '0']],
                styles: { font: 'helvetica', fontSize: 10 },
                headStyles: { fillColor: [41,52,72], textColor: 255 },
                columnStyles: {
                    0: { cellWidth: 60 },
                    1: { cellWidth: 20, halign:'right' },
                    2: { cellWidth: 20, halign:'right' },
                    3: { cellWidth: 20, halign:'right' },
                    4: { cellWidth: 20, halign:'right' },
                    5: { cellWidth: 20, halign:'right' }
                }
            });
        }
        
        window.addEventListener('DOMContentLoaded', startFirebaseApp);
    </script>
</body>
</html>


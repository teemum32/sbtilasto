<!DOCTYPE html>
<html lang="fi" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Salibandyn Kausitilastot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: pan-y; -webkit-user-select: none; user-select: none; }
        .player-number { cursor: grab; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; border: 2px solid white; background-color: #020617; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); touch-action: none; }
        .away-player { font-size: 1.5rem; }
        .dragging { position: absolute; pointer-events: none; opacity: 0.7; z-index: 1000; }
        .shot-marker { position: absolute; width: 36px; height: 36px; border-radius: 50%; font-weight: bold; font-size: 0.875rem; box-shadow: 0 1px 3px rgba(0,0,0,0.4); color: white; transform: translate(-50%, -50%); transition: opacity 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1; }
        .goal { background-color: #10B981; } .miss { background-color: #3B82F6; }
        .block { background-color: #FACC15; color: black; } .save { background-color: #EF4444; }
        .quality-high { border: 3px solid #b91c1c; } .quality-low { border: 2px solid rgba(255,255,255,0.8); }
        .action-modal { position: absolute; transform: translate(-50%, -50%); z-index: 50; display: flex; flex-direction: column; }
        .period-tab { padding: 8px 16px; border-radius: 6px; font-weight: 600; transition: background-color 0.2s; }
        .period-tab.active { background-color: #4f46e5; }
    </style>
</head>
<body class="bg-slate-900 h-full text-slate-200">

    <!-- Auth View -->
    <div id="auth-view" class="h-full flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-slate-800 p-8 rounded-lg shadow-xl text-center border border-slate-700">
            <h1 class="text-2xl font-bold">Kirjaudu sisään</h1>
            <div class="mt-6 space-y-4">
                <input id="email-input" type="email" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-center" placeholder="Sähköposti">
                <input id="password-input" type="password" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-center" placeholder="Salasana">
                <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded-lg font-bold">Kirjaudu</button>
            </div>
            <p id="auth-error" class="text-red-500 text-sm mt-4 h-5"></p>
        </div>
    </div>
    
    <!-- Teams Selection -->
    <div id="teams-view" class="h-full hidden flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center">
            <h1 class="text-2xl font-bold mb-6">Valitse joukkue</h1>
            <div id="teams-list" class="space-y-2 max-h-60 overflow-y-auto mb-6"></div>
            <div class="border-t border-slate-700 pt-6">
                <input id="new-team-name" type="text" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-center" placeholder="Uusi joukkue">
                <button id="create-team-btn" class="w-full mt-2 bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-bold">Luo joukkue</button>
            </div>
            <button id="logout-btn-teams" class="w-full mt-6 text-slate-400 font-semibold">Kirjaudu ulos</button>
        </div>
    </div>

    <!-- Landing View -->
    <div id="landing-view" class="h-full hidden flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center">
            <h1 id="team-name-header" class="text-3xl font-bold">Joukkue</h1>
            <div class="mt-8 space-y-4">
                <button id="start-new-game-btn" class="w-full bg-indigo-600 py-3 rounded-lg font-bold text-lg">Uusi ottelu</button>
                <button id="view-season-data-btn" class="w-full bg-slate-600 py-3 rounded-lg font-bold text-lg">Kausitilastot</button>
                <button id="change-team-btn" class="w-full border border-slate-600 py-2 rounded-lg text-slate-400 mt-4">Vaihda joukkuetta</button>
                <button id="logout-btn" class="w-full text-red-400 py-2 mt-2">Kirjaudu ulos</button>
            </div>
        </div>
    </div>

    <!-- Setup View -->
    <div id="setup-view" class="h-full hidden flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center">
            <h1 class="text-2xl font-bold mb-4">Uusi ottelu</h1>
            <input id="opponent-name-input" type="text" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-center mb-4" placeholder="Vastustaja">
            <textarea id="player-roster-input" class="w-full h-48 p-3 bg-slate-700 border border-slate-600 rounded-lg text-sm font-mono mb-4" placeholder="7 Matti, 10 Pekka..."></textarea>
            <p id="setup-error" class="text-red-500 text-sm mb-4 h-5"></p>
            <button id="start-button" class="w-full bg-indigo-600 py-3 rounded-lg font-bold">Aloita merkintä</button>
            <button id="back-to-landing-btn" class="mt-4 text-slate-400">Takaisin</button>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="h-full hidden flex-col">
        <div id="period-tabs" class="bg-slate-800 p-2 flex justify-center gap-1 shrink-0 flex-wrap border-b border-slate-700"></div>
        <div class="flex-1 min-h-0 relative">
            <div id="main-app" class="absolute inset-0 grid grid-cols-1 md:grid-cols-[256px,1fr]">
                <aside class="bg-slate-900 p-4 flex flex-col overflow-y-auto border-r border-slate-800">
                    <div id="sidebar-content"></div>
                    <button id="save-game-button" class="mt-auto w-full bg-blue-600 py-3 rounded-lg font-bold">Tallenna ottelu</button>
                </aside>
                <main class="flex items-center justify-center p-4 bg-slate-200 overflow-hidden">
                    <div id="field-area" class="w-full h-full flex items-center justify-center gap-4"></div>
                </main>
            </div>
            <div id="plus-minus-view" class="absolute inset-0 hidden bg-slate-100 overflow-y-auto p-4"></div>
            <div id="season-view" class="absolute inset-0 hidden bg-slate-100 overflow-y-auto p-4"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
    <div id="quality-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
    <div id="edit-outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border"></div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000] p-4"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State
        let db, auth, userId, currentTeamId;
        let seasonData = { games: [] }, rosterData = {}, currentGame = {};
        let gamesUnsubscribe = () => {}, teamsUnsubscribe = () => {};
        let draggedElement = null, ghostElement = null, tempShotData = {}, shotToEditId = null;

        const COLORS = { goal: '#10B981', miss: '#3B82F6', block: '#FACC15', save: '#EF4444' };
        const firebaseConfig = { apiKey: "AIzaSyDdqRwtwIat2t_qKYE9H3jmbVM1_EIvKy0", authDomain: "sbtilastot.firebaseapp.com", projectId: "sbtilastot", storageBucket: "sbtilastot.appspot.com", messagingSenderId: "1056099775207", appId: "1:1056099775207:web:6dc886fb56b71f708fe842" };

        function showMainView(viewKey) {
            const views = ['auth-view', 'teams-view', 'landing-view', 'setup-view', 'app-container'];
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            
            const targetId = { auth:'auth-view', teams:'teams-view', landing:'landing-view', setup:'setup-view', app:'app-container' }[viewKey];
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
                targetEl.classList.remove('hidden');
                if (viewKey === 'app') targetEl.classList.add('flex');
            }
            
            if (viewKey === 'landing') {
                document.getElementById('start-new-game-btn').textContent = (currentGame && currentGame.id) ? 'Jatka ottelua' : 'Uusi ottelu';
            }
        }

        async function initApp() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const saved = sessionStorage.getItem(`inProgressGame-${userId}`);
                    if (saved) {
                        currentGame = JSON.parse(saved);
                        currentTeamId = currentGame.teamId;
                        document.getElementById('team-name-header').textContent = currentGame.teamName;
                        initializeGameUI();
                        addEventListeners();
                        showMainView('app');
                        showView(1);
                    } else {
                        listenForTeams();
                        showMainView('teams');
                    }
                } else {
                    showMainView('auth');
                }
            });
        }

        function listenForTeams() {
            if (!userId) return;
            if (teamsUnsubscribe) teamsUnsubscribe();
            teamsUnsubscribe = onSnapshot(query(collection(db, 'users', userId, 'teams')), (snap) => {
                const list = document.getElementById('teams-list');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const team = { id: doc.id, ...doc.data() };
                    const btn = document.createElement('button');
                    btn.className = "w-full bg-slate-700 hover:bg-indigo-600 p-4 rounded-lg font-bold transition-colors";
                    btn.textContent = team.name;
                    btn.onclick = () => selectTeam(team);
                    list.appendChild(btn);
                });
            });
        }

        async function selectTeam(team) {
            currentTeamId = team.id;
            document.getElementById('team-name-header').textContent = team.name;
            const docSnap = await getDoc(doc(db, 'users', userId, 'teams', currentTeamId, 'roster', 'main'));
            rosterData = docSnap.exists() ? docSnap.data().players || {} : {};
            listenForGames();
            showMainView('landing');
        }

        function listenForGames() {
            if (!userId || !currentTeamId) return;
            if (gamesUnsubscribe) gamesUnsubscribe();
            gamesUnsubscribe = onSnapshot(query(collection(db, 'users', userId, 'teams', currentTeamId, 'games')), (snap) => {
                seasonData.games = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (!document.getElementById('season-view').classList.contains('hidden')) renderSeasonStats();
            });
        }

        function initializeGameUI() {
            const tabs = document.getElementById('period-tabs');
            tabs.innerHTML = `
                <button data-period="home" class="period-tab">Koti</button>
                <button data-period="1" class="period-tab active">Erä 1</button>
                <button data-period="2" class="period-tab">Erä 2</button>
                <button data-period="3" class="period-tab">Erä 3</button>
                <button data-period="summary" class="period-tab">Ottelu</button>
                <button data-period="plus-minus" class="period-tab">+/-</button>
                <button data-period="season" class="period-tab">Kausi</button>
            `;
            document.getElementById('sidebar-content').innerHTML = `
                <div class="mb-6"><h2 class="text-center font-bold text-slate-400 mb-2 uppercase">Koti</h2><div id="home-player-list" class="grid grid-cols-3 gap-2"></div></div>
                <div class="mb-6"><h2 class="text-center font-bold text-slate-400 mb-2 uppercase">Vieras</h2><div id="away-player-list" class="flex justify-center"></div></div>
                <div id="stats-container" class="border-t border-slate-700 pt-4"></div>
                <div id="player-stats-container" class="hidden border-t border-slate-700 pt-4 mt-4"></div>
            `;
            document.getElementById('field-area').innerHTML = `
                <div id="field-container" class="relative w-full max-w-[1000px] aspect-[2/1] bg-white rounded shadow-xl border-2 border-slate-400">
                    <svg class="w-full h-full" viewBox="0 0 400 200">
                        <line x1="200" y1="0" x2="200" y2="200" stroke="#cbd5e1" stroke-width="2"/>
                        <rect x="30" y="75" width="40" height="50" fill="none" stroke="#cbd5e1" stroke-width="2"/>
                        <rect x="330" y="75" width="40" height="50" fill="none" stroke="#cbd5e1" stroke-width="2"/>
                    </svg>
                    <div id="shots-layer" class="absolute inset-0"></div>
                </div>
            `;
            initializePlayers();
        }

        function initializePlayers() {
            const homeList = document.getElementById('home-player-list');
            const awayList = document.getElementById('away-player-list');
            if (!homeList || !awayList) return;
            homeList.innerHTML = '';
            awayList.innerHTML = `<div class="player-number away-player bg-slate-600">V</div>`;
            (currentGame.players || []).forEach(num => {
                const div = document.createElement('div');
                div.className = 'player-number'; div.textContent = num;
                homeList.appendChild(div);
            });
        }

        function showView(viewId) {
            document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-period="${viewId}"]`)?.classList.add('active');
            const mainApp = document.getElementById('main-app'), pmView = document.getElementById('plus-minus-view'), seasonView = document.getElementById('season-view');
            [mainApp, pmView, seasonView].forEach(s => s.classList.add('hidden'));

            if (viewId === 'home') { showMainView('landing'); return; }
            if (viewId === 'plus-minus') { renderPlusMinusView(); pmView.classList.remove('hidden'); }
            else if (viewId === 'season') { renderSeasonStats(); seasonView.classList.remove('hidden'); }
            else { 
                currentGame.currentPeriod = isNaN(viewId) ? viewId : parseInt(viewId);
                mainApp.classList.remove('hidden');
                renderShots(); updateStats();
            }
        }

        function addEventListeners() {
            document.getElementById('period-tabs').onclick = (e) => {
                const btn = e.target.closest('.period-tab');
                if (btn) showView(btn.dataset.period);
            };
            document.getElementById('save-game-button').onclick = () => {
                showConfirmation('Tallenna ottelu?', 'Peliä ei voi enää muokata.', 'Tallenna', 'bg-blue-600', saveGame);
            };
            ['home-player-list', 'away-player-list'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('pointerdown', onPointerDown);
            });
            document.body.addEventListener('pointermove', onPointerMove);
            document.body.addEventListener('pointerup', onPointerUp);
            document.getElementById('shots-layer').addEventListener('click', onShotClick);
            document.getElementById('outcome-modal').onclick = onOutcomeSelect;
            document.getElementById('quality-modal').onclick = onQualitySelect;
            document.getElementById('edit-outcome-modal').onclick = onEditSelect;
        }

        function onPointerDown(e) {
            const target = e.target.closest('.player-number');
            if (!target || currentGame.isReadOnly) return;
            draggedElement = target;
            ghostElement = target.cloneNode(true);
            ghostElement.classList.add('dragging');
            document.body.appendChild(ghostElement);
            updateGhost(e.pageX, e.pageY);
        }
        function onPointerMove(e) { if (ghostElement) updateGhost(e.pageX, e.pageY); }
        function onPointerUp(e) {
            if (!ghostElement) return;
            ghostElement.style.display = 'none';
            const drop = document.elementFromPoint(e.clientX, e.clientY);
            ghostElement.style.display = '';
            const field = document.getElementById('field-container');
            if (field && field.contains(drop)) {
                const rect = document.getElementById('shots-layer').getBoundingClientRect();
                tempShotData = {
                    player: draggedElement.textContent,
                    team: draggedElement.classList.contains('away-player') ? 'away' : 'home',
                    x: ((e.clientX - rect.left) / rect.width) * 100,
                    y: ((e.clientY - rect.top) / rect.height) * 100,
                    clientX: e.clientX, clientY: e.clientY
                };
                showModal('outcome-modal', e.clientX, e.clientY);
            }
            document.body.removeChild(ghostElement);
            ghostElement = null; draggedElement = null;
        }
        function updateGhost(x, y) { ghostElement.style.left = `${x-20}px`; ghostElement.style.top = `${y-20}px`; }

        function showModal(id, x, y) {
            const m = document.getElementById(id);
            m.classList.remove('hidden');
            m.style.left = `${Math.min(window.innerWidth - 150, x)}px`;
            m.style.top = `${Math.min(window.innerHeight - 200, y)}px`;
            if (id === 'outcome-modal') {
                m.innerHTML = `<button data-val="goal" class="w-24 bg-emerald-500 text-white p-2 rounded">Maali</button><button data-val="miss" class="w-24 bg-blue-500 text-white p-2 rounded">Ohi</button><button data-val="save" class="w-24 bg-red-500 text-white p-2 rounded">Torjunta</button><button data-val="block" class="w-24 bg-yellow-400 text-slate-900 p-2 rounded">Blokki</button>`;
            } else if (id === 'quality-modal') {
                m.innerHTML = `<button data-val="high" class="w-24 bg-red-700 text-white p-2 rounded">Laatu</button><button data-val="low" class="w-24 bg-blue-700 text-white p-2 rounded">Heikko</button>`;
            } else if (id === 'edit-outcome-modal') {
                m.innerHTML = `<button data-val="goal" class="w-24 bg-emerald-500 text-white p-2 rounded">Maali</button><button data-val="delete" class="w-24 bg-slate-600 text-white p-2 rounded">Poista</button>`;
            }
        }

        function onOutcomeSelect(e) {
            const val = e.target.dataset.val; if (!val) return;
            tempShotData.outcome = val;
            document.getElementById('outcome-modal').classList.add('hidden');
            showModal('quality-modal', tempShotData.clientX, tempShotData.clientY);
        }
        function onQualitySelect(e) {
            const val = e.target.dataset.val; if (!val) return;
            const shot = { id: Date.now(), ...tempShotData, quality: val, period: currentGame.currentPeriod, xG: calcXG(tempShotData.x, tempShotData.y, tempShotData.team) };
            delete shot.clientX; delete shot.clientY;
            currentGame.shots.push(shot); saveLocal();
            document.getElementById('quality-modal').classList.add('hidden');
            renderShots(); updateStats();
        }
        function onShotClick(e) {
            const marker = e.target.closest('.shot-marker'); if (!marker || currentGame.isReadOnly) return;
            shotToEditId = Number(marker.dataset.id);
            showModal('edit-outcome-modal', e.clientX, e.clientY);
        }
        function onEditSelect(e) {
            const val = e.target.dataset.val; if (!val) return;
            const idx = currentGame.shots.findIndex(s => s.id === shotToEditId);
            if (val === 'delete') currentGame.shots.splice(idx, 1);
            else currentGame.shots[idx].outcome = val;
            saveLocal(); document.getElementById('edit-outcome-modal').classList.add('hidden');
            renderShots(); updateStats();
        }

        function calcXG(x, y, team) {
            const MAX_XG = 0.65; const X_POWER = 3; const Y_POWER = 1.5;
            const xNorm = x / 100; const yNorm = Math.abs(y - 50) / 50;
            const xFactor = (team === 'home') ? Math.pow(1 - xNorm, X_POWER) : Math.pow(xNorm, X_POWER);
            const yFactor = Math.pow(1 - yNorm, Y_POWER);
            return parseFloat((MAX_XG * xFactor * yFactor).toFixed(2));
        }

        function renderShots() {
            const layer = document.getElementById('shots-layer'); layer.innerHTML = '';
            const filtered = (currentGame.shots || []).filter(s => currentGame.currentPeriod === 'summary' || s.period === currentGame.currentPeriod);
            filtered.forEach(s => {
                const m = document.createElement('div');
                m.className = `shot-marker ${s.outcome} ${s.quality === 'high' ? 'quality-high' : 'quality-low'}`;
                m.style.left = `${s.x}%`; m.style.top = `${s.y}%`;
                m.dataset.id = s.id; 
                m.textContent = s.player; // Asetetaan numero suoraan ilman span-elementtiä
                layer.appendChild(m);
            });
        }

        function updateStats() {
            const stats = getStatsForPeriod(currentGame, currentGame.currentPeriod);
            const container = document.getElementById('stats-container');
            const title = currentGame.currentPeriod === 'summary' ? 'Ottelu' : `Erä ${currentGame.currentPeriod}`;
            container.innerHTML = `
                <h3 class="font-bold text-center mb-3 text-slate-400">${title}</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><p class="font-bold text-emerald-400 uppercase">Koti</p><p>Maalit: ${stats.home.goals}</p><p>xG: ${stats.home.xg.toFixed(2)}</p></div>
                    <div><p class="font-bold text-slate-400 uppercase">Vieras</p><p>Maalit: ${stats.away.goals}</p><p>Lauk: ${stats.away.shots}</p></div>
                </div>
            `;
            if (currentGame.currentPeriod === 'summary') {
                document.getElementById('player-stats-container').classList.remove('hidden');
                updatePlayerStatsUI();
            } else document.getElementById('player-stats-container').classList.add('hidden');
        }

        function updatePlayerStatsUI() {
            const container = document.getElementById('player-stats-container');
            let html = `<h3 class="font-bold text-center mb-2">Pelaajat</h3>`;
            (currentGame.players || []).forEach(p => {
                const pShots = (currentGame.shots || []).filter(s => s.player == p && s.team === 'home');
                if (pShots.length > 0) html += `<div class="flex justify-between text-xs py-1 border-b border-slate-700"><span>#${p}</span><span>${pShots.length} L / ${pShots.filter(s=>s.outcome==='goal').length} M</span></div>`;
            });
            container.innerHTML = html;
        }

        function renderSeasonStats() {
            const view = document.getElementById('season-view');
            let html = `<div class="max-w-3xl mx-auto"><h2 class="text-2xl font-bold mb-6 text-slate-800 text-center">Tallennetut ottelut</h2>`;
            const games = [...seasonData.games].sort((a,b) => new Date(b.date) - new Date(a.date));
            if (games.length === 0) html += `<p class="text-center text-slate-500">Ei tallennettuja otteluita.</p>`;
            games.forEach(game => {
                const s = getStatsForPeriod(game, 'summary');
                html += `<div class="bg-white text-slate-900 p-4 rounded-lg shadow mb-4"><div class="flex justify-between items-center"><div><p class="font-bold">${new Date(game.date).toLocaleDateString('fi-FI')}</p><p class="text-sm">vs ${game.opponent}</p></div><div class="text-xl font-bold">${s.home.goals} - ${s.away.goals}</div><div class="flex gap-2"><button data-id="${game.id}" class="pdf-btn bg-purple-600 text-white px-4 py-2 rounded font-bold">PDF-raportti</button><button data-id="${game.id}" class="del-btn bg-red-500 text-white p-2 rounded text-xs">Poista</button></div></div></div>`;
            });
            view.innerHTML = html + `</div>`;
            view.onclick = (e) => {
                const pdfBtn = e.target.closest('.pdf-btn'); if (pdfBtn) generatePdfReport(pdfBtn.dataset.id, pdfBtn);
                const delBtn = e.target.closest('.del-btn'); if (delBtn) showConfirmation('Poista?', 'Poistetaanko ottelu?', 'Poista', 'bg-red-600', () => deleteDoc(doc(db, 'users', userId, 'teams', currentTeamId, 'games', delBtn.dataset.id)));
            };
        }

        // --- PDF GENERATION ---
        async function generatePdfReport(gameId, btn) {
            const origText = btn.textContent; btn.textContent = 'Luodaan...'; btn.disabled = true;
            try {
                const game = seasonData.games.find(g => g.id === gameId); if (!game) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const margin = 10; const pageW = doc.internal.pageSize.getWidth(); const pageH = doc.internal.pageSize.getHeight();
                let yPos = margin;

                doc.setFontSize(20); doc.text(`Otteluraportti: ${game.opponent}`, pageW/2, yPos, {align:'center'});
                yPos += 10;
                doc.setFontSize(12); doc.text(new Date(game.date).toLocaleDateString('fi-FI'), pageW/2, yPos, {align:'center'});
                yPos += 15;

                for (const period of [1, 2, 3, 'summary']) {
                    const stats = getStatsForPeriod(game, period);
                    const title = period === 'summary' ? 'Koko ottelu' : `Erä ${period}`;

                    const mapEl = createShotmapElement(game, period);
                    document.body.appendChild(mapEl);
                    await new Promise(r => requestAnimationFrame(r));
                    const canvas = await html2canvas(mapEl, { scale: 2 });
                    document.body.removeChild(mapEl);

                    const imgW = 180; const imgH = 90; const approxTableH = 62;
                    if (yPos + 6 + imgH + approxTableH > pageH - margin) { doc.addPage(); yPos = margin; }

                    doc.setFontSize(14); doc.text(title, margin, yPos);
                    yPos += 6;
                    doc.addImage(canvas.toDataURL('image/png'), 'PNG', (pageW-imgW)/2, yPos, imgW, imgH);
                    yPos += imgH + 8;

                    callAutoTable(doc, {
                        startY: yPos,
                        margin: { left: margin, right: margin },
                        tableWidth: pageW - margin*2,
                        theme: 'grid',
                        head: [['Tapahtuma', 'Koti', 'Vieras']],
                        body: [
                            ['Maalit', stats.home.goals, stats.away.goals],
                            ['Laukaukset', stats.home.shots, stats.away.shots],
                            ['xG (Maaliodottama)', stats.home.xg.toFixed(2), stats.away.xg.toFixed(2)],
                            ['Laadukkaat (L+)', stats.home.qualityHigh, stats.away.qualityHigh],
                            ['Torjunnat', stats.home.saves, stats.away.saves],
                            ['Blokit', stats.home.blocks, stats.away.blocks],
                        ],
                        styles: { fontSize: 10 },
                        headStyles: { fillColor: [41, 52, 72] },
                        columnStyles: { 0: { cellWidth: 110 }, 1: { cellWidth: 35, halign: 'right' }, 2: { cellWidth: 35, halign: 'right' } }
                    });
                    yPos = doc.lastAutoTable.finalY + 14;
                }

                doc.addPage(); yPos = margin;
                doc.setFontSize(16); doc.text('Pelaajakohtaiset tilastot', pageW/2, yPos, {align:'center'});
                yPos += 10;

                const rows = [];
                (game.players || []).sort((a,b)=>a-b).forEach(pNum => {
                    const shots = (game.shots || []).filter(s => s.team === 'home' && String(s.player) === String(pNum));
                    const goals = shots.filter(s => s.outcome === 'goal').length;
                    const pm = (game.plusMinus && game.plusMinus[pNum]) ? game.plusMinus[pNum] : { plus:0, minus:0 };
                    const bal = (pm.plus - pm.minus) >= 0 ? `+${pm.plus - pm.minus}` : `${pm.plus - pm.minus}`;
                    if (shots.length > 0 || pm.plus > 0 || pm.minus > 0) {
                        const name = (game.roster?.[pNum] || '').trim();
                        rows.push([`#${pNum} ${name}`, shots.length, goals, shots.filter(s=>s.quality==='high').length, shots.filter(s=>s.quality==='low').length, bal]);
                    }
                });

                callAutoTable(doc, {
                    startY: yPos,
                    theme: 'grid',
                    head: [['Pelaaja', 'Lauk.', 'Maalit', 'L+', 'H-', '+/-', 'T%']],
                    body: rows.map(r => {
                        const pct = r[1] ? Math.round((r[2]/r[1])*100) + '%' : '—';
                        return [...r, pct];
                    }),
                    columnStyles: {
                        0: { cellWidth: 60 }, 1: { cellWidth: 20, halign: 'right' }, 2: { cellWidth: 20, halign: 'right' },
                        3: { cellWidth: 18, halign: 'right' }, 4: { cellWidth: 18, halign: 'right' },
                        5: { cellWidth: 22, halign: 'right' }, 6: { cellWidth: 22, halign: 'right' }
                    }
                });
                doc.save(`Raportti_${game.opponent}.pdf`);
            } catch (err) { console.error(err); } finally { btn.textContent = origText; btn.disabled = false; }
        }

        function createShotmapElement(game, p) {
            const w = 900, h = 450;
            const wrap = document.createElement('div');
            Object.assign(wrap.style, { position:'fixed', left:'-9999px', width:w+'px', height:h+'px', background:'#fff' });
            wrap.innerHTML = `
                <svg width="${w}" height="${h}" viewBox="0 0 400 200" style="position:absolute;inset:0">
                    <rect x="10" y="10" width="380" height="180" fill="none" stroke="#1e293b" stroke-width="2"/>
                    <line x1="200" y1="10" x2="200" y2="190" stroke="#94a3b8" stroke-width="1"/>
                    <rect x="30" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="1"/>
                    <rect x="330" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="1"/>
                </svg>
                <div id="shot-layer-pdf" style="position:absolute;inset:0;width:100%;height:100%;"></div>
            `;
            const layer = wrap.querySelector('#shot-layer-pdf');
            (game.shots || []).filter(s => p === 'summary' || s.period === p).forEach(s => {
                const dot = document.createElement('div');
                const leftPct = 2.5 + (s.x / 100) * 95;
                const topPct = 5 + (s.y / 100) * 90;
                // PDF-merkinnän tyylit ja tekstin keskitys
                Object.assign(dot.style, {
                    position:'absolute', width:'28px', height:'28px', background: COLORS[s.outcome],
                    borderRadius:'50%', left: leftPct + '%', top: topPct + '%',
                    transform:'translate(-50%,-50%)', border: s.quality === 'high' ? '3px solid #b91c1c' : '2px solid white',
                    color:'white', fontSize:'12px', fontWeight:'bold', 
                    display:'block', textAlign:'center', lineHeight:'24px' // lineHeight on tässä varmin tapa keskittää teksti html2canvasille
                });
                dot.textContent = s.player; layer.appendChild(dot);
            });
            return wrap;
        }

        function getStatsForPeriod(game, p) {
            const agg = { home: {goals:0, shots:0, xg:0, saves:0, blocks:0, qualityHigh:0}, away: {goals:0, shots:0, xg:0, saves:0, blocks:0, qualityHigh:0} };
            (game.shots || []).filter(s => p === 'summary' || s.period === p).forEach(s => {
                const t = s.team; const o = t === 'home' ? 'away' : 'home';
                agg[t].shots++; agg[t].xg += Number(s.xG) || 0;
                if (s.outcome === 'goal') agg[t].goals++;
                if (s.outcome === 'save') agg[o].saves++;
                if (s.outcome === 'block') agg[o].blocks++;
                if (s.quality === 'high') agg[t].qualityHigh++;
            });
            return agg;
        }

        function callAutoTable(doc, opts) {
            if (window.jspdfAutoTable) return window.jspdfAutoTable(doc, opts);
            if (doc.autoTable) return doc.autoTable(opts);
            throw new Error('AutoTable not found');
        }

        // Logic
        document.getElementById('login-btn').onclick = async () => {
            const e = document.getElementById('email-input').value, p = document.getElementById('password-input').value;
            try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { document.getElementById('auth-error').textContent = 'Virhe kirjautumisessa.'; }
        };
        document.getElementById('logout-btn').onclick = () => { sessionStorage.clear(); signOut(auth); };
        document.getElementById('logout-btn-teams').onclick = () => signOut(auth);
        document.getElementById('start-new-game-btn').onclick = () => { if (currentGame?.id) showMainView('app'); else showMainView('setup'); };
        document.getElementById('view-season-data-btn').onclick = () => { showMainView('app'); showView('season'); };
        document.getElementById('change-team-btn').onclick = () => showMainView('teams');
        document.getElementById('back-to-landing-btn').onclick = () => showMainView('landing');
        document.getElementById('start-button').onclick = async () => {
            const opp = document.getElementById('opponent-name-input').value.trim();
            const rosterStr = document.getElementById('player-roster-input').value;
            if (!opp) return;
            const roster = {}; const matches = rosterStr.matchAll(/(\d{1,3})\s*([^,\n\r]*)/g);
            for (const m of matches) roster[Number(m[1])] = m[2].trim();
            if (Object.keys(roster).length === 0) return;
            currentGame = { id: Date.now(), date: new Date().toISOString(), opponent: opp, roster, teamId: currentTeamId, teamName: document.getElementById('team-name-header').textContent, players: Object.keys(roster).map(Number), shots: [], plusMinus: {}, currentPeriod: 1 };
            currentGame.players.forEach(p => currentGame.plusMinus[p] = {plus:0, minus:0});
            await setDoc(doc(db, 'users', userId, 'teams', currentTeamId, 'roster', 'main'), { players: roster });
            saveLocal(); initializeGameUI(); addEventListeners(); showMainView('app'); showView(1);
        };
        async function saveGame() {
            const saveObj = {...currentGame}; delete saveObj.id;
            await addDoc(collection(db, 'users', userId, 'teams', currentTeamId, 'games'), saveObj);
            sessionStorage.removeItem(`inProgressGame-${userId}`); currentGame = {}; showMainView('landing');
        }
        function saveLocal() { if (userId) sessionStorage.setItem(`inProgressGame-${userId}`, JSON.stringify(currentGame)); }
        function showConfirmation(title, text, btnTxt, btnClass, cb) {
            const m = document.getElementById('confirm-modal'); m.classList.remove('hidden');
            m.innerHTML = `<div class="bg-white p-6 rounded-lg max-w-sm w-full text-slate-900 text-center"><h3 class="text-xl font-bold mb-2">${title}</h3><p class="text-sm mb-6">${text}</p><div class="flex gap-2"><button id="conf-cancel" class="flex-1 py-2 bg-slate-200 rounded font-bold">Peruuta</button><button id="conf-ok" class="flex-1 py-2 ${btnClass} text-white rounded font-bold">${btnTxt}</button></div></div>`;
            document.getElementById('conf-cancel').onclick = () => m.classList.add('hidden');
            document.getElementById('conf-ok').onclick = () => { cb(); m.classList.add('hidden'); };
        }
        function renderPlusMinusView() {
            const v = document.getElementById('plus-minus-view');
            v.innerHTML = `<div class="max-w-4xl mx-auto bg-slate-100 p-6 rounded-xl text-slate-900"><h2 class="text-2xl font-bold text-center mb-6">+/- Merkintä</h2><div class="grid grid-cols-2 gap-8"><div class="bg-emerald-50 p-4 rounded-lg border-2 border-emerald-200"><h3 class="font-bold text-emerald-700 text-center mb-4 uppercase">Oma maali (+)</h3><div id="pm-plus-grid" class="grid grid-cols-4 gap-2"></div></div><div class="bg-red-50 p-4 rounded-lg border-2 border-red-200"><h3 class="font-bold text-red-700 text-center mb-4 uppercase">Vastustajan maali (-)</h3><div id="pm-minus-grid" class="grid grid-cols-4 gap-2"></div></div></div><div id="pm-summary" class="mt-8"></div></div>`;
            const plusG = v.querySelector('#pm-plus-grid'), minusG = v.querySelector('#pm-minus-grid');
            (currentGame.players || []).forEach(p => {
                const bP = document.createElement('button'); bP.className = "p-2 bg-emerald-500 text-white font-bold rounded"; bP.textContent = p;
                bP.onclick = () => { currentGame.plusMinus[p].plus++; saveLocal(); renderPMTable(); };
                plusG.appendChild(bP);
                const bM = document.createElement('button'); bM.className = "p-2 bg-red-500 text-white font-bold rounded"; bM.textContent = p;
                bM.onclick = () => { currentGame.plusMinus[p].minus++; saveLocal(); renderPMTable(); };
                minusG.appendChild(bM);
            });
            renderPMTable();
        }
        function renderPMTable() {
            const summ = document.getElementById('pm-summary');
            let html = `<table class="w-full text-left text-sm mt-4 text-slate-700"><thead><tr><th class="p-2">Pelaaja</th><th class="p-2 text-center">+</th><th class="p-2 text-center">-</th><th class="p-2 text-center">Yht.</th></tr></thead><tbody>`;
            (currentGame.players || []).forEach(p => {
                const s = currentGame.plusMinus[p]; const bal = s.plus - s.minus;
                html += `<tr class="border-t border-slate-300"><td class="p-2">#${p} ${currentGame.roster[p]||''}</td><td class="p-2 text-center">${s.plus}</td><td class="p-2 text-center">${s.minus}</td><td class="p-2 text-center font-bold"> ${bal>0?'+':''}${bal}</td></tr>`;
            });
            summ.innerHTML = html + `</tbody></table>`;
        }

        window.onload = initApp;
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <!-- KORJAUS: Laajennettu CSP käyttämään jokerimerkkiä, joka kattaa kaikki Googlen vaatimat palvelut. -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' blob: https://cdn.tailwindcss.com https://www.gstatic.com https://www.googletagmanager.com; connect-src 'self' wss://*.firebaseio.com https://*.googleapis.com https://csp.withgoogle.com https://www.gstatic.com; style-src 'self' 'unsafe-inline'; worker-src 'self' blob: data:; img-src 'self' data:;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Salibandyn Kausitilastot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Yleiset tyylit ja varmistukset mobiilikäyttöön */
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden; /* Estää koko sivun vierityksen */
        }

        /* Pelaajanumero sivupalkissa */
        .player-number {
            cursor: grab;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            border: 2px solid white;
            background-color: #020617; /* slate-950 */
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Vierasjoukkueen merkki */
        .away-player {
            font-size: 1.5rem;
        }

        /* Raahattava "haamu"-elementti */
        .dragging {
            position: absolute;
            pointer-events: none;
            opacity: 0.7;
            z-index: 1000;
        }

        /* Kentälle pudotettu laukausmerkintä */
        .shot-marker {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
            color: white;
            transform: translate(-50%, -50%);
            transition: opacity 0.2s;
            cursor: pointer;
        }
        
        .shot-marker span {
           position: absolute;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
        }
        
        /* Väritäytöt laukauksen tuloksen mukaan */
        .goal { background-color: #10B981; }
        .miss { background-color: #3B82F6; }
        .block { background-color: #FACC15; color: black; }
        .save { background-color: #EF4444; }
        
        /* Valintamodaalit */
        .action-modal {
            position: absolute;
            transform: translate(-50%, -50%);
            z-index: 50;
            display: flex;
            flex-direction: column;
        }
        
        /* Erävalinnan välilehdet */
        .period-tab {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .period-tab.active {
            background-color: #4f46e5; /* indigo-600 */
        }
        /* Plus/Miinus näkymän pelaajanapit */
        #plus-minus-view .pm-player-btn {
            cursor: pointer;
            transition: transform 0.1s;
        }
        #plus-minus-view .pm-player-btn:active {
            transform: scale(0.9);
        }
        
        /* Kausikoosteen haitarivalikko */
        details > summary {
            cursor: pointer;
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-900 h-screen flex flex-col">
    
    <!-- Salasanan syöttö -->
    <div id="password-view" class="flex flex-col items-center justify-center h-full p-4">
        <div class="w-full max-w-sm bg-slate-800 p-8 rounded-lg shadow-xl text-center">
            <h1 class="text-2xl font-bold text-slate-100 mb-4">Salasana vaaditaan</h1>
            <p class="text-slate-400 mb-6">Syötä salasana jatkaaksesi.</p>
            <input id="password-input" name="password" type="password" class="w-full p-3 border bg-slate-700 border-slate-600 text-slate-100 rounded-lg text-lg text-center focus:ring-2 focus:ring-indigo-500" placeholder="••••••••">
            <p id="password-error" class="text-red-500 text-sm mt-2 h-5"></p>
            <button id="password-submit-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors text-lg">Kirjaudu</button>
        </div>
    </div>

    <!-- Aloitusvalikko (piilotettu aluksi) -->
    <div id="landing-view" class="hidden flex-col items-center justify-center h-full p-4">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center">
            <h1 class="text-3xl font-bold text-slate-100 mb-2">Tilastotyökalu</h1>
            <p class="text-slate-400 mb-8">Valitse toiminto</p>
            <div class="space-y-4">
                <button id="start-new-game-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors text-lg">Aloita uusi ottelu</button>
                <button id="view-season-data-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition-colors text-lg disabled:bg-slate-400 disabled:cursor-not-allowed">Tarkastele kausidataa</button>
            </div>
             <p id="auth-status" class="text-xs text-slate-500 mt-8"></p>
        </div>
    </div>


    <!-- Pelaajien valintanäkymä -->
    <div id="setup-view" class="hidden flex-col items-center justify-center h-full p-4">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-lg shadow-xl text-center">
            <h1 class="text-3xl font-bold text-slate-100 mb-4">Uusi ottelu</h1>
            <p class="text-slate-400 mb-6">Syötä vastustajan nimi ja muokkaa kokoonpanoa.</p>
            <input id="opponent-name-input" name="opponent-name" type="text" class="w-full p-3 border bg-slate-700 border-slate-600 text-slate-100 rounded-lg text-lg text-center focus:ring-2 focus:ring-indigo-500 mb-4" placeholder="Vastustajan nimi">
            <textarea id="player-roster-input" name="player-roster" class="w-full h-48 p-3 border bg-slate-700 border-slate-600 text-slate-100 rounded-lg text-sm text-left focus:ring-2 focus:ring-indigo-500 font-mono" placeholder="7 Matti Meikäläinen&#10;10 Teppo Testaaja&#10;21..."></textarea>
            <p id="setup-error" class="text-red-500 text-sm mt-2 h-5"></p>
            <p class="text-xs text-slate-500 mt-2 text-left">Syötä jokainen pelaaja omalle rivilleen: numero, välilyönti ja nimi (vapaaehtoinen).</p>
            <button id="start-button" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors text-lg disabled:opacity-50">Aloita merkintä</button>
            <button id="back-to-landing-btn" class="mt-2 w-full text-slate-400 hover:text-slate-200 font-semibold py-2">Takaisin</button>
        </div>
    </div>

    <!-- Varsinainen sovellus (piilossa aluksi) -->
    <div id="app-container" class="hidden h-full flex-col">
        <!-- Erävalinta -->
        <div id="period-tabs" class="bg-slate-800 text-white p-2 flex justify-center gap-1 md:gap-2 shrink-0 flex-wrap">
            <button data-period="1" class="period-tab active">Erä 1</button>
            <button data-period="2" class="period-tab">Erä 2</button>
            <button data-period="3" class="period-tab">Erä 3</button>
            <button data-period="summary" class="period-tab">Ottelu</button>
            <button data-period="plus-minus" class="period-tab">+/-</button>
            <button data-period="season" class="period-tab">Kausi</button>
        </div>

        <!-- Pääsovellus -->
        <div id="main-app" class="hidden flex flex-row flex-grow overflow-hidden">
            <!-- Sivupalkki pelaajille ja tilastoille -->
            <div class="w-full md:w-64 bg-slate-900 text-slate-200 p-4 shadow-lg flex flex-col shrink-0 overflow-y-auto">
                <div class="flex-grow">
                    <h2 class="text-xl font-bold mb-4 text-center text-slate-100">Koti</h2>
                    <div id="home-player-list" class="grid grid-cols-4 md:grid-cols-3 gap-4 mb-6">
                        <!-- Kotijoukkueen pelaajanumerot luodaan JavaScriptillä -->
                    </div>
                    <h2 class="text-xl font-bold mb-4 text-center text-slate-100">Vieras</h2>
                    <div id="away-player-list" class="flex justify-center mb-6">
                         <!-- Vierasjoukkueen pelaaja luodaan JavaScriptillä -->
                    </div>

                    <!-- Tilastot -->
                    <div id="stats-container" class="border-t border-slate-700 pt-4">
                        <h3 id="stats-title" class="text-lg font-bold text-slate-100 text-center mb-3">Erä 1 tilastot</h3>
                        <div class="space-y-4">
                             <div>
                                <div class="flex justify-between font-semibold text-slate-100"><span>Koti</span></div>
                                <div class="flex justify-between text-sm text-slate-300 mt-1">
                                    <span id="home-goals-display">Maalit: 0</span>
                                    <span id="home-shots-display">Laukaukset: 0</span>
                                </div>
                                <div class="flex justify-end text-sm text-slate-300">
                                    <span id="home-xg-display">xG: 0.00</span>
                                </div>
                                <div class="flex justify-between text-sm text-slate-300 mt-1 border-t border-slate-700 pt-1">
                                    <span id="home-saves-made-display">Torjunnat: 0</span>
                                    <span id="home-blocks-made-display">Blokit: 0</span>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between font-semibold text-slate-100"><span>Vieras</span></div>
                                <div class="flex justify-between text-sm text-slate-300 mt-1">
                                    <span id="away-goals-display">Maalit: 0</span>
                                    <span id="away-shots-display">Laukaukset: 0</span>
                                </div>
                                <div class="flex justify-end text-sm text-slate-300">
                                    <span id="away-xg-display">xG: 0.00</span>
                                </div>
                                <div class="flex justify-between text-sm text-slate-300 mt-1 border-t border-slate-700 pt-1">
                                    <span id="away-saves-made-display">Torjunnat: 0</span>
                                    <span id="away-blocks-made-display">Blokit: 0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pelaajakohtaiset tilastot (vain koosteessa) -->
                    <div id="player-stats-container" class="hidden border-t border-slate-700 pt-4 mt-4">
                        <!-- Sisältö luodaan JavaScriptillä -->
                    </div>

                </div>
                <button id="save-game-button" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Tallenna ottelu
                </button>
            </div>

            <!-- Pääsisältö: Kenttä - Muokattu keskitystä siirtämään kenttää vasemmalle. -->
            <main class="flex-1 flex flex-col items-center justify-center p-4 md:pr-32 bg-slate-200 overflow-hidden min-w-0">
                <div class="text-slate-500 font-bold text-lg mb-1">Vieras</div>
                <div id="field-container" class="relative w-auto max-w-full max-h-[85vh] aspect-[1/2] bg-white rounded-lg shadow-2xl overflow-hidden border-2 border-slate-800">
                    <svg class="w-full h-full" viewBox="0 0 200 400" preserveAspectRatio="xMidYMid meet">
                        <line x1="0" y1="200" x2="200" y2="200" stroke="#94a3b8" stroke-width="2"/>
                        <rect x="75" y="30" width="50" height="40" fill="none" stroke="#94a3b8" stroke-width="2"/>
                        <line x1="90" y1="40" x2="110" y2="40" stroke="#94a3b8" stroke-width="2"/>
                        <rect x="75" y="330" width="50" height="40" fill="none" stroke="#94a3b8" stroke-width="2"/>
                        <line x1="90" y1="360" x2="110" y2="360" stroke="#94a3b8" stroke-width="2"/>
                    </svg>
                    <div id="shots-layer" class="absolute top-0 left-0 w-full h-full"></div>
                </div>
                <div class="text-slate-500 font-bold text-lg mt-1">Koti</div>
            </main>
        </div>
        
        <!-- Plus/Miinus -näkymä -->
        <div id="plus-minus-view" class="hidden flex flex-grow p-4 bg-slate-200 overflow-y-auto">
            <!-- Sisältö luodaan JS:llä -->
        </div>

        <!-- Kausikooste-näkymä -->
        <div id="season-view" class="hidden flex flex-grow p-4 bg-slate-200 overflow-y-auto">
            <!-- Sisältö luodaan JS:llä -->
        </div>
    </div>


    <!-- Laukauksen tuloksen valintamodaali (oletuksena piilossa) -->
    <div id="outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border border-slate-200">
        <button data-outcome="goal" class="outcome-btn w-28 text-white font-semibold py-2 px-4 rounded-md bg-emerald-500 hover:bg-emerald-600">Maali</button>
        <button data-outcome="miss" class="outcome-btn w-28 text-white font-semibold py-2 px-4 rounded-md bg-blue-500 hover:bg-blue-600">Ohi</button>
        <button data-outcome="block" class="outcome-btn w-28 text-slate-800 font-semibold py-2 px-4 rounded-md bg-yellow-400 hover:bg-yellow-500">Blokki</button>
        <button data-outcome="save" class="outcome-btn w-28 text-white font-semibold py-2 px-4 rounded-md bg-red-500 hover:bg-red-600">Torjunta</button>
    </div>

    <!-- Laukauksen muokkausmodaali -->
    <div id="edit-outcome-modal" class="action-modal hidden gap-2 p-2 bg-white rounded-lg shadow-xl border border-slate-200">
        <button data-outcome="goal" class="edit-outcome-btn w-32 text-white font-semibold py-2 px-4 rounded-md bg-emerald-500 hover:bg-emerald-600">Maali</button>
        <button data-outcome="miss" class="edit-outcome-btn w-32 text-white font-semibold py-2 px-4 rounded-md bg-blue-500 hover:bg-blue-600">Ohi</button>
        <button data-outcome="block" class="edit-outcome-btn w-32 text-slate-800 font-semibold py-2 px-4 rounded-md bg-yellow-400 hover:bg-yellow-500">Blokki</button>
        <button data-outcome="save" class="edit-outcome-btn w-32 text-white font-semibold py-2 px-4 rounded-md bg-red-500 hover:bg-red-600">Torjunta</button>
        <div class="border-t my-1"></div>
        <button id="delete-shot-btn" class="w-32 text-white font-semibold py-2 px-4 rounded-md bg-slate-600 hover:bg-slate-700">Poista laukaus</button>
    </div>

    <!-- Varmistusmodaali nollaukselle -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm text-center">
            <h3 id="confirm-title" class="text-xl font-bold text-slate-800 mb-4"></h3>
            <p id="confirm-text" class="text-slate-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="cancel-confirm-btn" class="px-6 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 font-semibold">Peruuta</button>
                <button id="confirm-btn" class="px-6 py-2 rounded-lg text-white font-semibold"></button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Firebase & Globaalit muuttujat ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, onSnapshot, collection, query, writeBatch, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Elementtiviittaukset ---
        const landingView = document.getElementById('landing-view');
        const setupView = document.getElementById('setup-view');
        const appContainer = document.getElementById('app-container');
        const startNewGameBtn = document.getElementById('start-new-game-btn');
        const viewSeasonDataBtn = document.getElementById('view-season-data-btn');
        const backToLandingBtn = document.getElementById('back-to-landing-btn');
        const opponentNameInput = document.getElementById('opponent-name-input');
        const playerRosterInput = document.getElementById('player-roster-input');
        const startButton = document.getElementById('start-button');
        const homePlayerList = document.getElementById('home-player-list');
        const awayPlayerList = document.getElementById('away-player-list');
        const fieldContainer = document.getElementById('field-container');
        const shotsLayer = document.getElementById('shots-layer');
        const outcomeModal = document.getElementById('outcome-modal');
        const editOutcomeModal = document.getElementById('edit-outcome-modal');
        const saveGameButton = document.getElementById('save-game-button');
        const periodTabs = document.getElementById('period-tabs');
        const mainAppView = document.getElementById('main-app');
        const plusMinusView = document.getElementById('plus-minus-view');
        const seasonView = document.getElementById('season-view');
        const playerStatsContainer = document.getElementById('player-stats-container');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmText = document.getElementById('confirm-text');
        const confirmBtn = document.getElementById('confirm-btn');
        const cancelConfirmBtn = document.getElementById('cancel-confirm-btn');
        const authStatus = document.getElementById('auth-status');
        const passwordView = document.getElementById('password-view');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmitBtn = document.getElementById('password-submit-btn');
        const passwordError = document.getElementById('password-error');
        const setupError = document.getElementById('setup-error');
        
        // --- Sovelluksen tila (State) ---
        // ==========================================================
        // Aseta tähän salasana, jolla sovelluksen saa käyttöön.
        // Muista vaihtaa tämä johonkin turvallisempaan!
        const APP_PASSWORD = "sbt";
        // ==========================================================
        let db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let seasonData = { games: [] };
        let rosterData = {};
        let currentGame = {};
        let draggedElement = null;
        let ghostElement = null;
        let tempShotData = {};
        let shotToEditId = null;
        let gamesUnsubscribe = () => {}; // Funktio Firestore-kuuntelijan poistamiseen
        let previousView = 'landing'; // Muistaa, mistä näkymästä tultiin asetuksiin

        // --- Alustus ---
        function onAppLoad() {
            console.log("onAppLoad: Sovellus käynnistyy.");
            // Tarkistetaan, onko käyttäjä jo syöttänyt salasanan tässä istunnossa
            if (sessionStorage.getItem('isAuthenticated') === 'true') {
                console.log("onAppLoad: Käyttäjä on jo tunnistautunut salasanalla tässä istunnossa.");
                passwordView.classList.add('hidden');
                startFirebaseApp();
            } else {
                console.log("onAppLoad: Salasanatunnistusta ei löydy, näytetään salasananäkymä.");
                // Varmistetaan, että vain salasanakenttä on näkyvissä
                landingView.classList.add('hidden');
                setupView.classList.add('hidden');
                appContainer.classList.add('hidden');
                passwordView.classList.remove('hidden');
            }
        }

        function checkPassword() {
            console.log("checkPassword: Tarkistetaan salasana.");
            if (passwordInput.value === APP_PASSWORD) {
                console.log("checkPassword: Salasana oikein.");
                sessionStorage.setItem('isAuthenticated', 'true'); // Tallenna onnistuminen istuntoon
                passwordView.classList.add('hidden');
                startFirebaseApp(); // Käynnistä varsinainen sovellus
            } else {
                console.error("checkPassword: Väärä salasana.");
                passwordError.textContent = 'Väärä salasana.';
                passwordInput.value = '';
                passwordInput.focus();
                setTimeout(() => passwordError.textContent = '', 2000);
            }
        }

        passwordSubmitBtn.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        async function startFirebaseApp() {
            console.log("startFirebaseApp: Yritetään käynnistää Firebase.");
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyDdqRwtwIat2t_qKYE9H3jmbVM1_EIvKy0",
                  authDomain: "sbtilastot.firebaseapp.com",
                  projectId: "sbtilastot",
                  storageBucket: "sbtilastot.firebasestorage.app",
                  messagingSenderId: "1056099775207",
                  appId: "1:1056099775207:web:6dc886fb56b71f708fe842"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                try {
                    await enableIndexedDbPersistence(db);
                    console.log("startFirebaseApp: Firestore offline-tuki aktivoitu.");
                } catch (err) {
                    console.warn("Firestore offline-tuen aktivointi epäonnistui:", err.code);
                }

                authStatus.textContent = 'Yhdistetään tietokantaan...';

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log(`onAuthStateChanged: Käyttäjä tunnistettu, UID: ${user.uid}`);
                        if (setupView.classList.contains('hidden') && appContainer.classList.contains('hidden')) {
                           landingView.classList.remove('hidden');
                           console.log("onAuthStateChanged: Näytetään aloitusnäkymä.");
                        }

                        userId = user.uid;
                        authStatus.textContent = `Käyttäjä: ${userId.substring(0, 8)}...`;
                        
                        await loadRosterFromFirestore();
                        listenForGames(); 
                        
                        viewSeasonDataBtn.disabled = seasonData.games.length === 0;
                    } else {
                        console.log("onAuthStateChanged: Ei käyttäjää.");
                        userId = null;
                        authStatus.textContent = 'Ei kirjautunut sisään.';
                        gamesUnsubscribe();
                    }
                });

                try {
                    console.log("startFirebaseApp: Yritetään anonyymiä sisäänkirjautumista.");
                    await signInAnonymously(auth);
                    console.log("startFirebaseApp: Anonyymi sisäänkirjautuminen onnistui.");
                } catch (authError) {
                    console.error("startFirebaseApp: Anonyymi sisäänkirjautuminen epäonnistui:", authError);
                    throw authError;
                }

            } catch (error) {
                console.error("KOKO SOVELLUKSEN KÄYNNISTYS EPÄONNISTUI:", error);
                document.body.innerHTML = `<div class="text-white text-center p-8">Tietokantayhteys epäonnistui. Päivitä sivu. Virhe: ${error.message}</div>`;
            }
        }
        
        startNewGameBtn.addEventListener('click', () => {
            console.log("startNewGameBtn: Klikattu. Siirrytään asetusnäkymään aloitusvalikosta.");
            previousView = 'landing';
            landingView.classList.add('hidden');
            setupView.classList.remove('hidden');
            prefillRosterInput();
        });

        viewSeasonDataBtn.addEventListener('click', () => {
            console.log("viewSeasonDataBtn: Klikattu. Siirrytään kausinäkymään.");
            landingView.classList.add('hidden');
            appContainer.classList.remove('hidden');
            showView('season');
        });

        backToLandingBtn.addEventListener('click', () => {
            console.log(`backToLandingBtn: Klikattu. Edellinen näkymä oli: ${previousView}`);
            setupView.classList.add('hidden');
            if (previousView === 'season') {
                console.log("backToLandingBtn: Palataan kausinäkymään.");
                appContainer.classList.remove('hidden');
                showView('season');
            } else {
                console.log("backToLandingBtn: Palataan aloitusvalikkoon.");
                landingView.classList.remove('hidden');
            }
        });

        function startNewGame(roster, opponentName) {
            console.log("startNewGame: Luodaan uusi peli.");
            const players = Object.keys(roster).map(Number).sort((a, b) => a - b);
            currentGame = {
                id: Date.now(),
                date: new Date().toISOString(),
                opponent: opponentName,
                players: players,
                roster: roster,
                shots: [],
                plusMinus: {}
            };
            players.forEach(p => {
                currentGame.plusMinus[p] = { plus: 0, minus: 0 };
            });
            
            initializePlayers();
            initializePlusMinusView();
            addEventListeners();
            showView(1);
            console.log("startNewGame: Uusi peli alustettu onnistuneesti.");
        }

        function initializePlayers() {
            homePlayerList.innerHTML = '';
            currentGame.players.forEach(number => {
                const player = document.createElement('div');
                player.className = 'player-number';
                player.textContent = number;
                homePlayerList.appendChild(player);
            });

            awayPlayerList.innerHTML = '';
            const awayPlayer = document.createElement('div');
            awayPlayer.className = 'player-number away-player';
            awayPlayer.textContent = 'V';
            awayPlayerList.appendChild(awayPlayer);
        }

        function initializePlusMinusView() {
            plusMinusView.innerHTML = `
                <div class="w-full max-w-4xl mx-auto my-auto bg-slate-900 text-slate-200 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-slate-100 mb-6 text-center">+/- Merkintä</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold text-emerald-500 mb-4 text-center">Oma maali (+)</h3>
                            <p class="text-center text-slate-400 mb-4 text-sm">Paina pelaajia, jotka olivat kentällä oman maalin aikana.</p>
                            <div id="plus-players" class="grid grid-cols-4 lg:grid-cols-5 gap-4"></div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-red-500 mb-4 text-center">Vastustajan maali (-)</h3>
                            <p class="text-center text-slate-400 mb-4 text-sm">Paina pelaajia, jotka olivat kentällä vastustajan maalin aikana.</p>
                            <div id="minus-players" class="grid grid-cols-4 lg:grid-cols-5 gap-4"></div>
                        </div>
                    </div>
                    <div id="plus-minus-summary" class="mt-8 border-t border-slate-700 pt-4"></div>
                </div>`;

            const plusContainer = document.getElementById('plus-players');
            const minusContainer = document.getElementById('minus-players');

            currentGame.players.forEach(number => {
                const plusPlayer = document.createElement('button');
                plusPlayer.className = 'player-number pm-player-btn';
                plusPlayer.textContent = number;
                plusPlayer.dataset.player = number;
                plusPlayer.dataset.type = 'add-plus';
                plusContainer.appendChild(plusPlayer);
                
                const minusPlayer = plusPlayer.cloneNode(true);
                minusPlayer.dataset.type = 'add-minus';
                minusContainer.appendChild(minusPlayer);
            });
        }
        
        // --- Tapahtumankuuntelijat ---
        startButton.addEventListener('click', async () => {
            console.log("startButton: 'Aloita merkintä' -painiketta klikattu.");
            startButton.disabled = true;
            startButton.textContent = 'Käsitellään...';
            setupError.textContent = ''; 
            
            try {
                const rosterText = playerRosterInput.value;
                const opponentName = opponentNameInput.value.trim();
                const newRoster = {};
                const lines = rosterText.split('\n').filter(line => line.trim() !== '');
                
                if (opponentName === '') { 
                    console.error("startButton: Validointivirhe - vastustajan nimi puuttuu.");
                    setupError.textContent = 'Syötä vastustajan nimi.';
                    return; 
                }
                if (lines.length === 0) { 
                    console.error("startButton: Validointivirhe - pelaajia ei syötetty.");
                    setupError.textContent = 'Syötä vähintään yksi pelaaja.';
                    return; 
                }

                let error = false;
                lines.forEach(line => {
                    const parts = line.trim().split(/\s+/);
                    const number = parseInt(parts[0], 10);
                    if (isNaN(number)) {
                        error = true;
                    } else {
                        const name = parts.slice(1).join(' ');
                        newRoster[number] = name || '';
                    }
                });

                if(error) { 
                    console.error("startButton: Validointivirhe - virheellinen syöte pelaajalistassa.");
                    setupError.textContent = 'Virheellinen syöte pelaajalistassa.';
                    return; 
                }

                console.log("startButton: Validointi onnistui. Tallennetaan kokoonpanoa...");
                await saveRosterToFirestore(newRoster);
                rosterData = newRoster;

                console.log("startButton: Siirrytään pelinäkymään.");
                setupView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                startNewGame(newRoster, opponentName);
            } catch (e) {
                console.error("startButton: Pelin aloitus epäonnistui virheeseen:", e);
                setupError.textContent = 'Pelin aloitus epäonnistui. Yritä uudelleen.';
            } finally {
                // Palautetaan painikkeen tila, jos tapahtui virhe ja näkymä ei vaihtunut.
                startButton.disabled = false;
                startButton.textContent = 'Aloita merkintä';
            }
        });
        
        saveGameButton.addEventListener('click', () => {
            showConfirmation('Tallenna ottelu?', 'Haluatko tallentaa nykyisen ottelun tiedot tietokantaan?', 'Kyllä, tallenna', 'bg-blue-600', saveAndEndGameInFirestore);
        });
        
        cancelConfirmBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));

        function addEventListeners() {
            [homePlayerList, awayPlayerList].forEach(bar => {
                bar.addEventListener('mousedown', onDragStart);
                bar.addEventListener('touchstart', onDragStart, { passive: false });
            });
            
            document.body.addEventListener('mousemove', onDragMove);
            document.body.addEventListener('touchmove', onDragMove, { passive: false });
            document.body.addEventListener('mouseup', onDragEnd);
            document.body.addEventListener('touchend', onDragEnd);

            outcomeModal.addEventListener('click', onOutcomeSelect);
            editOutcomeModal.addEventListener('click', onEditOutcomeSelect);
            shotsLayer.addEventListener('click', onShotMarkerClick);
            periodTabs.addEventListener('click', onPeriodChange);
            plusMinusView.addEventListener('click', onPlusMinusClick);
            fieldContainer.addEventListener('contextmenu', e => e.preventDefault());
        }

        // --- Raahauslogiikka ---
        function onDragStart(e) {
            const target = e.target.closest('.player-number');
            if (!target || !currentGame.id) return;
            
            draggedElement = target;
            ghostElement = target.cloneNode(true);
            ghostElement.classList.add('dragging');
            document.body.appendChild(ghostElement);
            const touch = e.touches ? e.touches[0] : e;
            updateGhostPosition(touch.clientX, touch.clientY);
        }

        function onDragMove(e) {
            if (!ghostElement) return;
            e.preventDefault(); 
            const touch = e.touches ? e.touches[0] : e;
            updateGhostPosition(touch.clientX, touch.clientY);
        }

        function onDragEnd(e) {
            if (!draggedElement || !ghostElement) return;
            const touch = e.changedTouches ? e.changedTouches[0] : e;
            ghostElement.style.display = 'none';
            const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
            ghostElement.style.display = '';
            if (fieldContainer.contains(dropTarget)) {
                const rect = shotsLayer.getBoundingClientRect();
                const x = ((touch.clientX - rect.left) / rect.width) * 100;
                const y = ((touch.clientY - rect.top) / rect.height) * 100;
                tempShotData = { player: draggedElement.textContent, team: draggedElement.classList.contains('away-player') ? 'away' : 'home', x, y };
                showOutcomeModal(touch.clientX, touch.clientY);
            }
            document.body.removeChild(ghostElement);
            ghostElement = null;
            draggedElement = null;
        }
        
        function updateGhostPosition(x, y) {
             if (ghostElement) { ghostElement.style.left = `${x - 25}px`; ghostElement.style.top = `${y - 25}px`; }
        }

        // --- Laukauksen tuloksen ja datan käsittely ---
        function onOutcomeSelect(e) {
            const target = e.target.closest('.outcome-btn');
            if (!target) return;
            const newShot = {
                id: Date.now() + Math.random(),
                ...tempShotData,
                outcome: target.dataset.outcome,
                period: currentGame.currentPeriod,
                xG: calculateXg(tempShotData.x, tempShotData.y, tempShotData.team)
            };
            currentGame.shots.push(newShot);
            hideOutcomeModal();
            renderShots();
            updateStats();
        }

        function onShotMarkerClick(e) {
            const target = e.target.closest('.shot-marker');
            if (!target || draggedElement) {
                hideEditOutcomeModal();
                return;
            }
            shotToEditId = Number(target.dataset.shotId);
            showEditOutcomeModal(e.clientX, e.clientY);
        }

        function onEditOutcomeSelect(e) {
            const target = e.target;
            if (!shotToEditId) return;
            const shotIndex = currentGame.shots.findIndex(s => s.id === shotToEditId);
            if (shotIndex === -1) return;
            if (target.id === 'delete-shot-btn') {
                currentGame.shots.splice(shotIndex, 1);
            } else if (target.closest('.edit-outcome-btn')) {
                currentGame.shots[shotIndex].outcome = target.dataset.outcome;
            }
            hideEditOutcomeModal();
            renderShots();
            updateStats();
        }

        function showOutcomeModal(x, y) {
            hideEditOutcomeModal();
            outcomeModal.style.left = `${x}px`;
            outcomeModal.style.top = `${y}px`;
            outcomeModal.classList.remove('hidden');
        }

        function hideOutcomeModal() {
            outcomeModal.classList.add('hidden');
            tempShotData = {};
        }

        function showEditOutcomeModal(x, y) {
            hideOutcomeModal();
            editOutcomeModal.style.left = `${x}px`;
            editOutcomeModal.style.top = `${y}px`;
            editOutcomeModal.classList.remove('hidden');
        }

        function hideEditOutcomeModal() {
            editOutcomeModal.classList.add('hidden');
            shotToEditId = null;
        }
        
        // --- Plus/Miinus-käsittely ---
        function onPlusMinusClick(e) {
            const target = e.target.closest('[data-player]');
            if (!target) return;
            const playerNum = target.dataset.player;
            const type = target.dataset.type;
            if (!currentGame.plusMinus[playerNum]) return;
            switch (type) {
                case 'add-plus': currentGame.plusMinus[playerNum].plus++; break;
                case 'add-minus': currentGame.plusMinus[playerNum].minus++; break;
                case 'remove-plus': if (currentGame.plusMinus[playerNum].plus > 0) { currentGame.plusMinus[playerNum].plus--; } break;
                case 'remove-minus': if (currentGame.plusMinus[playerNum].minus > 0) { currentGame.plusMinus[playerNum].minus--; } break;
            }
            if (type.startsWith('add')) {
                 target.classList.add('animate-ping', 'bg-slate-200');
                 setTimeout(() => target.classList.remove('animate-ping', 'bg-slate-200'), 300);
            }
            renderPlusMinusView();
        }

        // --- xG Laskentamalli ---
        function calculateXg(x, y, team) {
            const [MAX_XG, Y_POWER, X_POWER] = [0.65, 3, 1.5];
            const yNorm = y / 100;
            const xNorm = Math.abs(x - 50) / 50;
            const yFactor = (team === 'home') ? Math.pow(1 - yNorm, Y_POWER) : Math.pow(yNorm, Y_POWER);
            const xFactor = Math.pow(1 - xNorm, X_POWER);
            return parseFloat((MAX_XG * yFactor * xFactor).toFixed(2));
        }

        // --- Näkymien vaihto ---
        function onPeriodChange(e) {
            const target = e.target.closest('.period-tab');
            if (!target) return;
            showView(target.dataset.period);
        }

        function showView(viewId) {
            console.log(`showView: Yritetään näyttää näkymä: ${viewId}`);
            document.querySelectorAll('.period-tab').forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`.period-tab[data-period="${viewId}"]`);
            if(activeTab) activeTab.classList.add('active');

            mainAppView.classList.add('hidden');
            plusMinusView.classList.add('hidden');
            seasonView.classList.add('hidden');

            if (viewId === 'plus-minus') {
                renderPlusMinusView();
                plusMinusView.classList.remove('hidden');
            } else if (viewId === 'season') {
                renderSeasonStats();
                seasonView.classList.remove('hidden');
            } else {
                mainAppView.classList.remove('hidden');
                currentGame.currentPeriod = isNaN(viewId) ? viewId : parseInt(viewId);
                renderShots();
                updateStats();
            }
        }
        
        // --- Datan tallennus & luku (Firestore) ---
        async function saveAndEndGameInFirestore() {
            if (!userId) {
                console.error("saveAndEndGameInFirestore: Ei käyttäjätunnusta, tallennus epäonnistui.");
                return;
            }
            try {
                const gamesCol = collection(db, 'artifacts', appId, 'users', userId, 'games');
                const gameToSave = { ...currentGame };
                delete gameToSave.id; 
                await addDoc(gamesCol, gameToSave);
                console.log("saveAndEndGameInFirestore: Peli tallennettu onnistuneesti.");
                showView('season');
            } catch (error) {
                console.error("Pelin tallennus epäonnistui: ", error);
            }
        }
        
        function listenForGames() {
            if (!userId) return;
            console.log("listenForGames: Aloitetaan pelidatan kuuntelu.");
            gamesUnsubscribe();
            const gamesCol = collection(db, 'artifacts', appId, 'users', userId, 'games');
            const q = query(gamesCol);
            
            gamesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const games = [];
                querySnapshot.forEach((doc) => {
                    games.push({ id: doc.id, ...doc.data() });
                });
                console.log(`listenForGames: ${games.length} peliä haettu tietokannasta.`);
                seasonData.games = games;
                viewSeasonDataBtn.disabled = seasonData.games.length === 0;
                if (!seasonView.classList.contains('hidden')) {
                    console.log("listenForGames: Päivitetään avoinna oleva kausinäkymä.");
                    renderSeasonStats();
                }
            }, (error) => {
                console.error("Pelidatan kuuntelu epäonnistui:", error);
            });
        }

        async function saveRosterToFirestore(rosterToSave) {
            if (!userId) return;
            try {
                const rosterDoc = doc(db, 'artifacts', appId, 'users', userId, 'roster', 'main');
                await setDoc(rosterDoc, { players: rosterToSave });
                console.log("saveRosterToFirestore: Kokoonpano tallennettu.");
            } catch (error) {
                console.error("Kokoonpanon tallennus epäonnistui: ", error);
            }
        }

        async function loadRosterFromFirestore() {
             if (!userId) return;
             try {
                console.log("loadRosterFromFirestore: Ladataan kokoonpanoa...");
                const rosterDoc = doc(db, 'artifacts', appId, 'users', userId, 'roster', 'main');
                const docSnap = await getDoc(rosterDoc);
                if (docSnap.exists()) {
                    rosterData = docSnap.data().players || {};
                    console.log("loadRosterFromFirestore: Kokoonpano ladattu onnistuneesti.");
                } else {
                    rosterData = {};
                    console.log("loadRosterFromFirestore: Ei olemassa olevaa kokoonpanoa.");
                }
             } catch (error) {
                console.error("Kokoonpanon lataus epäonnistui: ", error);
                throw error;
             }
        }
        
        async function deleteGameFromFirestore(gameId) {
            if (!userId) return;
            try {
                const gameDoc = doc(db, 'artifacts', appId, 'users', userId, 'games', gameId);
                await deleteDoc(gameDoc);
                console.log(`Peli ${gameId} poistettu.`);
            } catch (error) {
                console.error(`Pelin ${gameId} poisto epäonnistui: `, error);
            }
        }
        
        async function deleteAllSeasonData() {
            if (!userId) return;
            try {
                console.log("deleteAllSeasonData: Poistetaan kaikki kauden tiedot.");
                const gamesCol = collection(db, 'artifacts', appId, 'users', userId, 'games');
                const querySnapshot = await getDocs(gamesCol);
                const batch = writeBatch(db);
                querySnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                const rosterDoc = doc(db, 'artifacts', appId, 'users', userId, 'roster', 'main');
                await deleteDoc(rosterDoc);
                rosterData = {};
                console.log("deleteAllSeasonData: Kaikki data poistettu. Palataan aloitusnäkymään.");

                appContainer.classList.add('hidden');
                setupView.classList.add('hidden');
                landingView.classList.remove('hidden');

            } catch (error) {
                console.error("Kausidatan poisto epäonnistui: ", error);
            }
        }


        function prefillRosterInput() {
            let rosterString = "";
            const sortedNumbers = Object.keys(rosterData).map(Number).sort((a,b) => a-b);
            sortedNumbers.forEach(number => {
                rosterString += `${number} ${rosterData[number] || ''}\n`;
            });
            playerRosterInput.value = rosterString;
        }
        
        // --- Piirtäminen ja tilastojen päivitys ---
        function renderShots() {
            shotsLayer.innerHTML = '';
            const shotsToRender = currentGame.shots ? currentGame.shots.filter(shot =>
                currentGame.currentPeriod === 'summary' || shot.period === currentGame.currentPeriod
            ) : [];
            shotsToRender.forEach(shotData => {
                const shotElement = createShotMarker(shotData);
                shotsLayer.appendChild(shotElement);
            });
        }
        
        function createShotMarker(shotData) {
            const shot = document.createElement('div');
            shot.className = 'shot-marker';
            shot.dataset.shotId = shotData.id;
            shot.classList.add(shotData.outcome);
            shot.innerHTML = `<span>${shotData.player}</span>`;
            shot.style.left = `${shotData.x}%`;
            shot.style.top = `${shotData.y}%`;
            return shot;
        }

        function updateStats() {
            if (!currentGame || !currentGame.shots) return;
            let stats = { home: { goals:0, shots:0, xg:0, saves:0, blocks:0 }, away: { goals:0, shots:0, xg:0, saves:0, blocks:0 }};
            const shotsToConsider = currentGame.shots.filter(shot => currentGame.currentPeriod === 'summary' || shot.period === currentGame.currentPeriod);

            shotsToConsider.forEach(shot => {
                if (shot.team === 'home') {
                    stats.home.shots++;
                    stats.home.xg += shot.xG;
                    if (shot.outcome === 'goal') stats.home.goals++;
                    if (shot.outcome === 'save') stats.away.saves++;
                    if (shot.outcome === 'block') stats.away.blocks++;
                } else {
                    stats.away.shots++;
                    stats.away.xg += shot.xG;
                    if (shot.outcome === 'goal') stats.away.goals++;
                    if (shot.outcome === 'save') stats.home.saves++;
                    if (shot.outcome === 'block') stats.home.blocks++;
                }
            });
            
            if (currentGame.currentPeriod === 'summary') {
                document.getElementById('stats-title').textContent = 'Koko ottelu';
                updatePlayerStats();
                playerStatsContainer.classList.remove('hidden');
            } else {
                document.getElementById('stats-title').textContent = `Erä ${currentGame.currentPeriod} tilastot`;
                playerStatsContainer.classList.add('hidden');
            }
            
            document.getElementById('home-goals-display').textContent = `Maalit: ${stats.home.goals}`;
            document.getElementById('home-shots-display').textContent = `Laukaukset: ${stats.home.shots}`;
            document.getElementById('home-xg-display').textContent = `xG: ${stats.home.xg.toFixed(2)}`;
            document.getElementById('home-saves-made-display').textContent = `Torjunnat: ${stats.home.saves}`;
            document.getElementById('home-blocks-made-display').textContent = `Blokit: ${stats.home.blocks}`;
            document.getElementById('away-goals-display').textContent = `Maalit: ${stats.away.goals}`;
            document.getElementById('away-shots-display').textContent = `Laukaukset: ${stats.away.shots}`;
            document.getElementById('away-xg-display').textContent = `xG: ${stats.away.xg.toFixed(2)}`;
            document.getElementById('away-saves-made-display').textContent = `Torjunnat: ${stats.away.saves}`;
            document.getElementById('away-blocks-made-display').textContent = `Blokit: ${stats.away.blocks}`;
        }
        
        function updatePlayerStats() {
            let tableHTML = `<h3 class="text-lg font-bold text-slate-100 text-center mb-3">Pelaajakohtaiset tilastot</h3>
                             <div class="grid grid-cols-5 text-center font-semibold text-xs text-slate-400 mb-2 px-1">
                                 <span>Pelaaja</span><span>Lauk.</span><span>Maalit</span><span>Teho %</span><span>+/-</span>
                             </div>`;
            
            currentGame.players.forEach(playerNum => {
                const playerShots = currentGame.shots.filter(s => s.team === 'home' && s.player == playerNum);
                const playerGoals = playerShots.filter(s => s.outcome === 'goal').length;
                const pm = currentGame.plusMinus[playerNum];
                
                if (playerShots.length > 0 || (pm && (pm.plus > 0 || pm.minus > 0))) {
                    const efficiency = playerGoals > 0 && playerShots.length > 0 ? `${Math.round((playerGoals / playerShots.length) * 100)}%` : '—';
                    const balance = pm ? pm.plus - pm.minus : 0;
                    const balanceText = balance > 0 ? `+${balance}` : balance;
                    const playerName = currentGame.roster[playerNum] ? ` ${currentGame.roster[playerNum].split(' ')[0]}` : '';
                    tableHTML += `<div class="grid grid-cols-5 text-center text-sm text-slate-200 py-1 border-b border-slate-700">
                                      <span class="font-bold text-left">#${playerNum}${playerName}</span><span>${playerShots.length}</span><span>${playerGoals}</span>
                                      <span>${efficiency}</span><span class="font-semibold">${balanceText}</span>
                                  </div>`;
                }
            });
            playerStatsContainer.innerHTML = tableHTML;
        }
        
        function renderPlusMinusView() {
            const container = document.getElementById('plus-minus-summary');
            if (!container) return;
            
            let summaryHTML = `<h3 class="text-xl font-bold text-slate-100 text-center mb-3">+/- Saldo</h3>
                               <div class="grid grid-cols-4 text-center font-semibold text-xs text-slate-400 mb-2 px-1">
                                   <span>Pelaaja</span><span>+</span><span>-</span><span>Yht.</span>
                               </div>`;
            
            currentGame.players.forEach(pNum => {
                const stats = currentGame.plusMinus[pNum];
                const balance = stats.plus - stats.minus;
                const balanceText = balance > 0 ? `+${balance}` : balance;
                const playerName = currentGame.roster[pNum] ? ` ${currentGame.roster[pNum].split(' ')[0]}` : '';

                summaryHTML += `<div class="grid grid-cols-4 text-center text-sm text-slate-200 py-2 border-b border-slate-700 items-center">
                                    <span class="font-bold text-left truncate pr-2">#${pNum}${playerName}</span>
                                    <button data-player="${pNum}" data-type="remove-plus" class="font-mono text-lg text-emerald-500 cursor-pointer rounded-md hover:bg-slate-700">${stats.plus}</button>
                                    <button data-player="${pNum}" data-type="remove-minus" class="font-mono text-lg text-red-500 cursor-pointer rounded-md hover:bg-slate-700">${stats.minus}</button>
                                    <span class="font-semibold text-lg">${balanceText}</span>
                                </div>`;
            });

            container.innerHTML = summaryHTML;
        }

        function renderSeasonStats() {
            const fullRoster = {};
            seasonData.games.forEach(g => {
                Object.assign(fullRoster, g.roster);
            });
            const allPlayers = [...new Set(seasonData.games.flatMap(g => g.players))].sort((a,b) => a-b);
            const seasonPlayerStats = {};
            allPlayers.forEach(p => {
                seasonPlayerStats[p] = { games: 0, shots: 0, goals: 0, plus: 0, minus: 0 };
            });

            seasonData.games.forEach(game => {
                game.players.forEach(pNum => {
                    if (seasonPlayerStats[pNum]) seasonPlayerStats[pNum].games++;
                });
                game.shots.forEach(shot => {
                    if (shot.team === 'home' && seasonPlayerStats[shot.player]) {
                        seasonPlayerStats[shot.player].shots++;
                        if (shot.outcome === 'goal') seasonPlayerStats[shot.player].goals++;
                    }
                });
                Object.keys(game.plusMinus).forEach(pNum => {
                    if (seasonPlayerStats[pNum]) {
                        seasonPlayerStats[pNum].plus += game.plusMinus[pNum].plus;
                        seasonPlayerStats[pNum].minus += game.plusMinus[pNum].minus;
                    }
                });
            });

            let playerTable = `<h3 class="text-xl font-bold text-slate-100 mb-3">Kauden pelaajatilastot</h3>
                               <div class="grid grid-cols-6 text-center font-semibold text-xs text-slate-400 mb-2 px-1">
                                   <span>Pelaaja</span><span>Ott.</span><span>Lauk.</span><span>Maalit</span><span>Teho %</span><span>+/-</span>
                               </div>`;
            allPlayers.forEach(pNum => {
                const stats = seasonPlayerStats[pNum];
                const efficiency = stats.shots > 0 && stats.goals > 0 ? `${Math.round((stats.goals / stats.shots) * 100)}%` : '—';
                const balance = stats.plus - stats.minus;
                const balanceText = balance > 0 ? `+${balance}` : balance;
                const playerName = fullRoster[pNum] ? ` ${fullRoster[pNum]}` : '';
                playerTable += `<div class="grid grid-cols-6 text-center text-sm text-slate-200 py-1.5 border-b border-slate-700">
                                    <span class="font-bold text-left">#${pNum}${playerName}</span><span>${stats.games}</span><span>${stats.shots}</span><span>${stats.goals}</span>
                                    <span>${efficiency}</span><span class="font-semibold">${balanceText}</span>
                                </div>`;
            });

            let gamesTable = `<h3 class="text-xl font-bold text-slate-100 mb-4">Tallennetut ottelut</h3>`;
            if (seasonData.games.length > 0) {
                 seasonData.games.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(game => {
                    const gameStats = getGameStats(game);
                    const homeGoals = gameStats.home.goals;
                    const awayGoals = gameStats.away.goals;
                    gamesTable += `
                        <details class="bg-slate-900 rounded-lg shadow mb-2">
                            <summary class="flex justify-between items-center p-3 font-semibold">
                                <div>
                                    <p class="font-bold text-slate-100">${new Date(game.date).toLocaleDateString('fi-FI')} vs ${game.opponent}</p>
                                    <p class="text-sm text-slate-300">Lopputulos: ${homeGoals} - ${awayGoals}</p>
                                </div>
                                <button data-game-id="${game.id}" class="delete-game-btn text-red-500 hover:text-red-700 font-semibold text-sm z-10 p-2">Poista</button>
                            </summary>
                            <div class="p-4 border-t border-slate-700">
                                ${generateGameDetailsHTML(game)}
                            </div>
                        </details>`;
                });
            } else {
                gamesTable += `<p class="text-slate-400 text-center">Ei tallennettuja otteluita.</p>`;
            }

            seasonView.innerHTML = `
                <div class="w-full max-w-4xl mx-auto">
                    <button id="new-game-from-season-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg mb-6">Aloita uusi ottelu</button>
                    <div class="bg-slate-800 p-6 rounded-lg shadow-lg">${playerTable}</div>
                    <div class="mt-6 bg-slate-800 p-6 rounded-lg shadow-lg">${gamesTable}</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                        <button id="share-season-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg">Jaa kausidata sähköpostiin</button>
                        <button id="delete-season-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg">Tyhjennä koko kausidata</button>
                    </div>
                </div>`;
            
            document.getElementById('new-game-from-season-btn').addEventListener('click', () => {
                console.log("new-game-from-season-btn: Klikattu. Siirrytään asetusnäkymään kausidatasta.");
                previousView = 'season';
                appContainer.classList.add('hidden');
                setupView.classList.remove('hidden');
                opponentNameInput.value = '';
                prefillRosterInput();
            });

            document.getElementById('share-season-btn').addEventListener('click', shareDataByEmail);

            document.getElementById('delete-season-btn').addEventListener('click', () => {
                 showConfirmation('Tyhjennä kausidata?', 'Tämä poistaa kaikki tallennetut ottelut ja kokoonpanon pysyvästi. Toimintoa ei voi perua.', 'Kyllä, poista kaikki', 'bg-red-600', deleteAllSeasonData);
            });

            document.querySelectorAll('.delete-game-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    const gameId = e.target.dataset.gameId;
                    showConfirmation('Poista ottelu?', 'Haluatko varmasti poistaa tämän ottelun tiedot?', 'Kyllä, poista', 'bg-red-600', () => deleteGameFromFirestore(gameId));
                });
            });
        }
        
        // --- Datan jakaminen ---
        function shareDataByEmail() {
            const subject = "Salibandykauden tilastokooste";
            const body = generateShareableText();
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function generateShareableText() {
            // This function would need to format the data into text, implementation later.
            return "Kausidataa...";
        }

        // --- APUFUNKTIOT ---
        function getGameStats(game) {
            let stats = { home: { goals:0, shots:0, xg:0, saves:0, blocks:0 }, away: { goals:0, shots:0, xg:0, saves:0, blocks:0 }};
            game.shots.forEach(shot => {
                if (shot.team === 'home') {
                    stats.home.shots++;
                    stats.home.xg += shot.xG;
                    if (shot.outcome === 'goal') stats.home.goals++;
                    if (shot.outcome === 'save') stats.away.saves++;
                    if (shot.outcome === 'block') stats.away.blocks++;
                } else {
                    stats.away.shots++;
                    stats.away.xg += shot.xG;
                    if (shot.outcome === 'goal') stats.away.goals++;
                    if (shot.outcome === 'save') stats.home.saves++;
                    if (shot.outcome === 'block') stats.home.blocks++;
                }
            });
            return stats;
        }
        
        function generateGameDetailsHTML(game) {
            const gameStats = getGameStats(game);
            let playerStatsHTML = '';
            game.players.forEach(playerNum => {
                const playerShots = game.shots.filter(s => s.team === 'home' && s.player == playerNum);
                const playerGoals = playerShots.filter(s => s.outcome === 'goal').length;
                const pm = game.plusMinus[playerNum];
                if (playerShots.length > 0 || (pm && (pm.plus > 0 || pm.minus > 0))) {
                    const efficiency = playerGoals > 0 && playerShots.length > 0 ? `${Math.round((playerGoals / playerShots.length) * 100)}%` : '—';
                    const balance = pm ? pm.plus - pm.minus : 0;
                    const balanceText = balance > 0 ? `+${balance}` : balance;
                    const playerName = game.roster[playerNum] ? ` ${game.roster[playerNum]}` : '';
                    playerStatsHTML += `<div class="grid grid-cols-5 text-center text-xs text-slate-300 py-1 border-b border-slate-700">
                                            <span class="font-semibold text-left">#${playerNum}${playerName}</span><span>${playerShots.length}</span><span>${playerGoals}</span>
                                            <span>${efficiency}</span><span class="font-semibold">${balanceText}</span>
                                        </div>`;
                }
            });

            return `
                <div class="space-y-3">
                    <div>
                        <p class="font-semibold text-sm text-slate-200">Joukkueiden tilastot</p>
                        <div class="text-xs text-slate-400 mt-1 space-y-1">
                            <p><b>Koti:</b> Lauk. ${gameStats.home.shots}, xG ${gameStats.home.xg.toFixed(2)}, Torj. ${gameStats.home.saves}, Blok. ${gameStats.home.blocks}</p>
                            <p><b>Vieras:</b> Lauk. ${gameStats.away.shots}, xG ${gameStats.away.xg.toFixed(2)}, Torj. ${gameStats.away.saves}, Blok. ${gameStats.away.blocks}</p>
                        </div>
                    </div>
                    <div>
                        <p class="font-semibold text-sm mt-3 text-slate-200">Pelaajakohtaiset tilastot</p>
                        <div class="grid grid-cols-5 text-center font-bold text-xs text-slate-400 mt-2 px-1">
                            <span>Pelaaja</span><span>Lauk.</span><span>Maalit</span><span>Teho %</span><span>+/-</span>
                        </div>
                        ${playerStatsHTML}
                    </div>
                </div>
            `;
        }

        // --- Varmistusmodaali ---
        function showConfirmation(title, text, confirmButtonText, buttonClass, callback) {
            confirmTitle.textContent = title;
            confirmText.textContent = text;
            confirmBtn.textContent = confirmButtonText;
            confirmBtn.className = `px-6 py-2 rounded-lg text-white font-semibold ${buttonClass}`;
            
            const newConfirmBtn = confirmBtn.cloneNode(true);
            const oldConfirmBtn = document.getElementById('confirm-btn');
            oldConfirmBtn.parentNode.replaceChild(newConfirmBtn, oldConfirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                callback();
                confirmModal.classList.add('hidden');
            });
            
            confirmModal.classList.remove('hidden');
        }

        // --- Käynnistetään sovellus ---
        onAppLoad();
    </script>
</body>
</html>








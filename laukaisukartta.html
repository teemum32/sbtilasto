<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <title>Floorball Shotmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase -->
  <script type="module">
    /***********************************************************
     * 1. FIREBASE-ALUSTUS
     ***********************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      addDoc,
      setDoc,
      deleteDoc,
      onSnapshot,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* TÄMÄ ON SUN PROJUN KONFFI (sama joka oli aiemmassa toimivassa versiossa) */
    const firebaseConfig = {
      apiKey: "AIzaSyDdqRwtwIat2t_qKYE9H3jmbVM1_EIvKy0",
      authDomain: "sbtilastot.firebaseapp.com",
      projectId: "sbtilastot",
      storageBucket: "sbtilastot.appspot.com",
      messagingSenderId: "1056099775207",
      appId: "1:1056099775207:web:6dc886fb56b71f708fe842"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /***********************************************************
     * 2. KOKONAISUUDEN TILA
     ***********************************************************/
    let currentUser = null;          // firebase user
    let currentTeamId = null;        // esim. "Top Team/Varta P16"
    let allTeams = [];               // rosters-kokoelman dokkarit
    let seasonData = { games: [] };  // haetaan games-kokoelmasta
    let currentGame = null;          // kun aloitetaan uusi ottelu
    let rosterData = {};             // valitun joukkueen pelaajat

    /***********************************************************
     * 3. NÄKYMÄT (DOM)
     ***********************************************************/
    const viewAuth   = document.getElementById("auth-view");
    const viewTeams  = document.getElementById("team-view");
    const viewHome   = document.getElementById("home-view");
    const viewSetup  = document.getElementById("setup-view");
    const viewApp    = document.getElementById("app-view");

    const emailInput = document.getElementById("email-input");
    const passInput  = document.getElementById("password-input");
    const loginBtn   = document.getElementById("login-btn");
    const loginErr   = document.getElementById("login-error");

    const teamList   = document.getElementById("team-list");
    const newTeamInput = document.getElementById("new-team-input");
    const newTeamBtn   = document.getElementById("new-team-btn");

    const opponentInput = document.getElementById("opponent-input");
    const startGameBtn  = document.getElementById("start-game-btn");

    const homePlayerList = document.getElementById("home-player-list");
    const awayPlayerList = document.getElementById("away-player-list");
    const fieldContainer = document.getElementById("field-container");
    const shotsLayer     = document.getElementById("shots-layer");
    const statsBox       = document.getElementById("stats-box");
    const saveGameBtn    = document.getElementById("save-game-btn");
    const seasonBtn      = document.getElementById("home-season-btn");
    const logoutBtn      = document.getElementById("home-logout-btn");

    const seasonView     = document.getElementById("season-view");
    const seasonBackBtn  = document.getElementById("season-back-btn");
    const seasonContent  = document.getElementById("season-content");

    /***********************************************************
     * 4. PIENI NÄKYMÄOHJAUS
     ***********************************************************/
    function showAuth() {
      viewAuth.classList.remove("hidden");
      viewTeams.classList.add("hidden");
      viewHome.classList.add("hidden");
      viewSetup.classList.add("hidden");
      viewApp.classList.add("hidden");
      seasonView.classList.add("hidden");
    }
    function showTeams() {
      viewAuth.classList.add("hidden");
      viewTeams.classList.remove("hidden");
      viewHome.classList.add("hidden");
      viewSetup.classList.add("hidden");
      viewApp.classList.add("hidden");
      seasonView.classList.add("hidden");
    }
    function showHome() {
      viewAuth.classList.add("hidden");
      viewTeams.classList.add("hidden");
      viewHome.classList.remove("hidden");
      viewSetup.classList.add("hidden");
      viewApp.classList.add("hidden");
      seasonView.classList.add("hidden");
      document.getElementById("selected-team-name").textContent = currentTeamId || "—";
    }
    function showSetup() {
      viewAuth.classList.add("hidden");
      viewTeams.classList.add("hidden");
      viewHome.classList.add("hidden");
      viewSetup.classList.remove("hidden");
      viewApp.classList.add("hidden");
      seasonView.classList.add("hidden");
      // roster näkyviin tekstialueeseen
      const ta = document.getElementById("roster-textarea");
      ta.value = Object.keys(rosterData)
        .map(n => `${n} ${rosterData[n] ?? ""}`.trim())
        .join("\n");
    }
    function showApp() {
      viewAuth.classList.add("hidden");
      viewTeams.classList.add("hidden");
      viewHome.classList.add("hidden");
      viewSetup.classList.add("hidden");
      viewApp.classList.remove("hidden");
      seasonView.classList.add("hidden");
    }
    function showSeason() {
      viewAuth.classList.add("hidden");
      viewTeams.classList.add("hidden");
      viewHome.classList.add("hidden");
      viewSetup.classList.add("hidden");
      viewApp.classList.add("hidden");
      seasonView.classList.remove("hidden");
    }

    /***********************************************************
     * 5. KIRJAUTUMINEN
     ***********************************************************/
    loginBtn.addEventListener("click", async () => {
      loginErr.textContent = "";
      try {
        const cred = await signInWithEmailAndPassword(
          auth,
          emailInput.value.trim(),
          passInput.value
        );
        // kaikki muu tapahtuu onAuthStateChanged:ssä
      } catch (err) {
        loginErr.textContent = err.message;
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        currentUser = null;
        showAuth();
        return;
      }
      currentUser = user;
      // 1) haetaan kaikki rosterit TÄSTÄ polusta:
      await loadAllRostersForUser(user.uid);
      // 2) haetaan pelit
      listenForGames(user.uid);
      // 3) jos käyttäjällä oli viimeksi valittu joukkue, otetaan se
      const last = localStorage.getItem("fs_selected_team");
      if (last && allTeams.find(t => t.id === last)) {
        currentTeamId = last;
        rosterData = allTeams.find(t => t.id === last).players || {};
        showHome();
      } else {
        showTeams();
      }
    });

    /***********************************************************
     * 6. ROSTERIEN HAKU OIKEASTA POLUSTA
     ***********************************************************/
    async function loadAllRostersForUser(uid) {
      // HUOM: sulla on Firestoressa tämä rakenne:
      // artifacts / default-app-id / users / <uid> / roster / <docit>
      const rosterCol = collection(
        db,
        "artifacts",
        "default-app-id",
        "users",
        uid,
        "roster"
      );
      const snap = await getDocs(rosterCol);
      allTeams = snap.docs.map(d => ({
        id: d.id,
        ...(d.data() || {})
      }));
      renderTeamList();
    }

    function renderTeamList() {
      teamList.innerHTML = "";
      if (!allTeams.length) {
        teamList.innerHTML = `<p class="text-slate-400 text-sm">Ei joukkueita vielä. Luo uusi.</p>`;
        return;
      }
      allTeams.forEach(team => {
        const btn = document.createElement("button");
        btn.className = "w-full bg-slate-700 hover:bg-slate-600 text-left px-4 py-2 rounded mb-2";
        btn.textContent = team.id;
        btn.addEventListener("click", () => {
          currentTeamId = team.id;
          rosterData = team.players || {};
          localStorage.setItem("fs_selected_team", currentTeamId);
          showHome();
        });
        teamList.appendChild(btn);
      });
    }

    /***********************************************************
     * 7. UUDEN JOUKKUEEN LUONTI
     ***********************************************************/
    newTeamBtn.addEventListener("click", async () => {
      const name = newTeamInput.value.trim();
      if (!name || !currentUser) return;
      const ref = doc(
        db,
        "artifacts",
        "default-app-id",
        "users",
        currentUser.uid,
        "roster",
        name
      );
      await setDoc(ref, { players: {} });
      newTeamInput.value = "";
      await loadAllRostersForUser(currentUser.uid);
    });

    /***********************************************************
     * 8. KOTINÄKYMÄN NAPIT
     ***********************************************************/
    document.getElementById("home-newgame-btn").addEventListener("click", () => {
      if (!currentTeamId) return;
      showSetup();
    });

    seasonBtn.addEventListener("click", () => {
      renderSeasonView();
      showSeason();
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      localStorage.removeItem("fs_selected_team");
      showAuth();
    });

    /***********************************************************
     * 9. UUDEN OTTELUN ALOITUS
     ***********************************************************/
    startGameBtn.addEventListener("click", async () => {
      const opponent = opponentInput.value.trim() || "Vieras";
      // päivitetään roster jos käyttäjä muokkasi textareaa
      const ta = document.getElementById("roster-textarea").value
        .split("\n")
        .map(l => l.trim())
        .filter(Boolean);

      const newRoster = {};
      ta.forEach(line => {
        const parts = line.split(/\s+/);
        const num = parseInt(parts[0], 10);
        if (!isNaN(num)) {
          newRoster[num] = parts.slice(1).join(" ");
        }
      });

      // tallenna muokattu roster takaisin samaan dokumenttiin
      if (currentUser && currentTeamId) {
        const ref = doc(
          db,
          "artifacts",
          "default-app-id",
          "users",
          currentUser.uid,
          "roster",
          currentTeamId
        );
        await setDoc(ref, { players: newRoster }, { merge: true });
      }
      rosterData = newRoster;

      // luodaan uusi peli APP-tilaan
      currentGame = {
        date: new Date().toISOString(),
        opponent,
        team: currentTeamId,
        players: Object.keys(rosterData).map(n => Number(n)).sort((a,b)=>a-b),
        roster: rosterData,
        shots: [],
        plusMinus: {},
        currentPeriod: 1
      };
      currentGame.players.forEach(p => {
        currentGame.plusMinus[p] = { plus:0, minus:0 };
      });

      renderPlayers();
      renderStatsBox();
      showApp();
    });

    function renderPlayers() {
      homePlayerList.innerHTML = "";
      if (!currentGame) return;
      currentGame.players.forEach(num => {
        const div = document.createElement("div");
        div.className = "player-number";
        div.textContent = num;
        homePlayerList.appendChild(div);
      });
      // vain yksi vieras
      awayPlayerList.innerHTML = "";
      const av = document.createElement("div");
      av.className = "player-number";
      av.textContent = "V";
      awayPlayerList.appendChild(av);
    }

    /***********************************************************
     * 10. LAUKAISUMERKINTÄ (yksinkertainen versio)
     ***********************************************************/
    fieldContainer.addEventListener("click", (e) => {
      if (!currentGame) return;
      // testiversio: tehdään aina KOTI laukaus maali
      const rect = fieldContainer.getBoundingClientRect();
      const xPct = ((e.clientX - rect.left) / rect.width) * 100;
      const yPct = ((e.clientY - rect.top) / rect.height) * 100;
      const shot = {
        id: Date.now(),
        team: "home",
        player: currentGame.players[0] || 0,
        outcome: "goal",
        x: xPct,
        y: yPct,
        period: currentGame.currentPeriod,
        xG: 0.25
      };
      currentGame.shots.push(shot);
      renderShots();
      renderStatsBox();
    });

    function renderShots() {
      shotsLayer.innerHTML = "";
      if (!currentGame) return;
      currentGame.shots.forEach(s => {
        const m = document.createElement("div");
        m.className = "shot-marker " + (s.outcome === "goal" ? "goal" : "miss");
        m.style.left = s.x + "%";
        m.style.top  = s.y + "%";
        const span = document.createElement("span");
        span.textContent = s.team === "home" ? s.player : "V";
        m.appendChild(span);
        shotsLayer.appendChild(m);
      });
    }

    function renderStatsBox() {
      if (!currentGame) return;
      let homeGoals = 0, awayGoals = 0, homeShots = 0, awayShots = 0, homeXg=0, awayXg=0;
      currentGame.shots.forEach(s => {
        if (s.team === "home") {
          homeShots++;
          homeXg += s.xG || 0;
          if (s.outcome === "goal") homeGoals++;
        } else {
          awayShots++;
          awayXg += s.xG || 0;
          if (s.outcome === "goal") awayGoals++;
        }
      });
      statsBox.innerHTML = `
        <h3 class="font-semibold mb-2">Erä ${currentGame.currentPeriod}</h3>
        <div class="text-sm">
          <p><b>Koti:</b> Maalit ${homeGoals}, Laukaukset ${homeShots}, xG ${homeXg.toFixed(2)}</p>
          <p><b>Vieras:</b> Maalit ${awayGoals}, Laukaukset ${awayShots}, xG ${awayXg.toFixed(2)}</p>
        </div>
      `;
    }

    /***********************************************************
     * 11. TALLENNA PELI FIREBASEEN
     ***********************************************************/
    saveGameBtn.addEventListener("click", async () => {
      if (!currentUser || !currentGame) return;
      await addDoc(
        collection(
          db,
          "artifacts",
          "default-app-id",
          "users",
          currentUser.uid,
          "games"
        ),
        currentGame
      );
      currentGame = null;
      showHome();
    });

    /***********************************************************
     * 12. KAUSINÄKYMÄ
     ***********************************************************/
    function listenForGames(uid) {
      const gamesCol = collection(
        db,
        "artifacts",
        "default-app-id",
        "users",
        uid,
        "games"
      );
      onSnapshot(gamesCol, (snap) => {
        seasonData.games = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        // jos kausinäkymä auki, piirrä
        if (!seasonView.classList.contains("hidden")) {
          renderSeasonView();
        }
      });
    }

    function renderSeasonView() {
      seasonContent.innerHTML = "";
      if (!seasonData.games.length) {
        seasonContent.innerHTML = `<p class="text-slate-300">Ei tallennettuja otteluita.</p>`;
        return;
      }
      seasonData.games
        .sort((a,b) => new Date(b.date) - new Date(a.date))
        .forEach(g => {
          const div = document.createElement("div");
          div.className = "bg-slate-800 rounded p-4 mb-3 flex justify-between items-center";
          const h = document.createElement("div");
          h.innerHTML = `<p class="font-semibold">${new Date(g.date).toLocaleDateString("fi-FI")} vs ${g.opponent}</p>
                         <p class="text-sm text-slate-400">${g.team || ""}</p>`;
          const del = document.createElement("button");
          del.className = "bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm";
          del.textContent = "Poista";
          del.addEventListener("click", async () => {
            await deleteDoc(doc(
              db,
              "artifacts",
              "default-app-id",
              "users",
              currentUser.uid,
              "games",
              g.id
            ));
          });
          div.appendChild(h);
          div.appendChild(del);
          seasonContent.appendChild(div);
        });
    }

    seasonBackBtn.addEventListener("click", () => {
      showHome();
    });

  </script>
</head>
<body class="bg-slate-900 min-h-screen text-white">

  <!-- 1. LOGIN -->
  <div id="auth-view" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-sm bg-slate-800 p-6 rounded-lg shadow text-center">
      <h1 class="text-2xl font-bold mb-2">Floorball Shotmap</h1>
      <p class="text-slate-400 mb-6">Kirjaudu sisään.</p>
      <input id="email-input" type="email" class="w-full mb-3 p-3 rounded bg-slate-700 border border-slate-600 text-center" placeholder="sähköposti">
      <input id="password-input" type="password" class="w-full mb-3 p-3 rounded bg-slate-700 border border-slate-600 text-center" placeholder="salasana">
      <p id="login-error" class="text-red-400 text-sm h-5 mb-3"></p>
      <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded font-bold">Kirjaudu sisään</button>
    </div>
  </div>

  <!-- 2. VALITSE TAI LUO JOUKKUE -->
  <div id="team-view" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-slate-800 p-6 rounded-lg shadow">
      <h2 class="text-2xl font-bold mb-4 text-center">Valitse tai luo joukkue</h2>
      <div id="team-list" class="mb-4 space-y-2"></div>
      <input id="new-team-input" class="w-full mb-3 p-3 rounded bg-slate-700 border border-slate-600" placeholder="Uuden joukkueen nimi">
      <button id="new-team-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 py-2 rounded font-semibold">Luo uusi joukkue</button>
      <button id="logout-btn-teams" class="w-full mt-3 bg-slate-600 hover:bg-slate-500 py-2 rounded" onclick="firebase.auth()?.signOut?.()">Kirjaudu ulos</button>
    </div>
  </div>

  <!-- 3. KOTINÄKYMÄ -->
  <div id="home-view" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-slate-800 p-6 rounded-lg text-center space-y-4">
      <h2 class="text-xl font-bold">Floorball Shotmap</h2>
      <p class="text-slate-400 text-sm" id="selected-team-name">—</p>
      <button id="home-newgame-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded font-bold">Aloita uusi ottelu</button>
      <button id="home-season-btn" class="w-full bg-slate-600 hover:bg-slate-500 py-3 rounded font-semibold">Tarkastele kausidataa</button>
      <button id="home-logout-btn" class="w-full bg-red-500 hover:bg-red-600 py-3 rounded font-semibold">Kirjaudu ulos</button>
    </div>
  </div>

  <!-- 4. OTTELUN ASETUKSET -->
  <div id="setup-view" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-lg bg-slate-800 p-6 rounded-lg space-y-4">
      <h2 class="text-2xl font-bold text-center mb-2">Uusi ottelu</h2>
      <input id="opponent-input" class="w-full p-3 rounded bg-slate-700 border border-slate-600" placeholder="Vastustaja">
      <p class="text-sm text-slate-400">Pelaajat (numero ja nimi):</p>
      <textarea id="roster-textarea" class="w-full h-48 p-3 rounded bg-slate-700 border border-slate-600 font-mono text-sm"></textarea>
      <button id="start-game-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded font-bold">Aloita merkintä</button>
      <button class="w-full bg-slate-600 hover:bg-slate-500 py-2 rounded" onclick="document.getElementById('home-view').classList.remove('hidden');document.getElementById('setup-view').classList.add('hidden');">Takaisin</button>
    </div>
  </div>

  <!-- 5. VARSINAINEN MERKINTÄNÄKYMÄ -->
  <div id="app-view" class="hidden min-h-screen flex flex-col md:flex-row">
    <aside class="w-full md:w-64 bg-slate-900 p-4 space-y-4">
      <h3 class="text-lg font-bold mb-3">Koti</h3>
      <div id="home-player-list" class="flex flex-wrap gap-2"></div>
      <h3 class="text-lg font-bold mt-6 mb-3">Vieras</h3>
      <div id="away-player-list" class="flex gap-2"></div>
      <div id="stats-box" class="mt-6 text-sm"></div>
      <button id="save-game-btn" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 py-2 rounded font-semibold">Tallenna ottelu</to-do-list>
      <button class="w-full bg-slate-600 hover:bg-slate-500 py-2 rounded" onclick="document.getElementById('app-view').classList.add('hidden');document.getElementById('home-view').classList.remove('hidden');">Takaisin</button>
    </aside>
    <main class="flex-1 min-h-0 flex items-center justify-center bg-slate-200">
      <div id="field-container" class="relative bg-white border-2 border-slate-800 rounded-lg shadow-2xl aspect-[2/1] w-11/12 max-w-4xl">
        <svg viewBox="0 0 400 200" class="w-full h-full">
          <line x1="200" y1="0" x2="200" y2="200" stroke="#94a3b8" stroke-width="2"></line>
          <rect x="30" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"></rect>
          <rect x="330" y="75" width="40" height="50" fill="none" stroke="#94a3b8" stroke-width="2"></rect>
        </svg>
        <div id="shots-layer" class="absolute inset-0"></div>
      </div>
    </main>
  </div>

  <!-- 6. KAUSINÄKYMÄ -->
  <div id="season-view" class="hidden min-h-screen p-4 bg-slate-900">
    <div class="max-w-3xl mx-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Tallennetut ottelut</h2>
        <button id="season-back-btn" class="bg-slate-600 hover:bg-slate-500 px-4 py-2 rounded">Takaisin</button>
      </div>
      <div id="season-content" class="space-y-3"></div>
    </div>
  </div>

</body>
</html>
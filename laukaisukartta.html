<!DOCTYPE html>
<html lang="fi" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Floorball Shotmap</title>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://www.googleapis.com; connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://www.googleapis.com https://securetoken.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; frame-src 'self';">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#0f172a; color:#e2e8f0; height:100vh; }
    .btn-primary { background:#4f46e5; }
    .btn-primary:hover { background:#4338ca; }
  </style>
</head>
<body class="h-full">

<!-- 1) KIRJAUTUMINEN -->
<div id="login-view" class="h-full w-full flex items-center justify-center">
  <div class="bg-slate-900 rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <h1 class="text-2xl font-bold text-center mb-6">Floorball Shotmap</h1>
    <label class="text-sm text-slate-400">sähköposti</label>
    <input id="login-email" type="email"
           class="w-full mt-1 mb-4 px-3 py-2 rounded bg-slate-800 border border-slate-700 focus:outline-none"
           placeholder="data@topteamsalibandy.net" />
    <label class="text-sm text-slate-400">salasana</label>
    <input id="login-password" type="password"
           class="w-full mt-1 mb-4 px-3 py-2 rounded bg-slate-800 border border-slate-700 focus:outline-none"
           placeholder="••••••••" />
    <p id="login-error" class="text-red-400 text-sm h-5 mb-3"></p>
    <button id="login-btn"
            class="w-full btn-primary text-white font-semibold py-2 rounded-lg">Kirjaudu</button>
  </div>
</div>

<!-- 2) JOUKKUEEN VALINTA -->
<div id="team-view" class="hidden h-full w-full flex items-center justify-center">
  <div class="bg-slate-900 rounded-2xl shadow-2xl p-8 w-full max-w-md space-y-4">
    <h2 class="text-2xl font-bold text-center mb-2">Valitse tai luo joukkue</h2>
    <div id="team-buttons" class="space-y-3">
      <!-- tähän luetaan Firebasesta löytyneet joukkueet -->
    </div>
    <div class="pt-3 border-t border-slate-700 space-y-3">
      <input id="new-team-name" type="text"
             class="w-full px-3 py-2 rounded bg-slate-800 border border-slate-700 focus:outline-none"
             placeholder="Uuden joukkueen nimi" />
      <button id="create-team-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 rounded-lg">
        Luo uusi joukkue
      </button>
    </div>
    <button id="logout-from-team" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 rounded-lg">
      Kirjaudu ulos
    </button>
    <p id="team-error" class="text-red-400 text-sm h-5"></p>
  </div>
</div>

<!-- 3) PÄÄVALIKKO -->
<div id="landing-view" class="hidden h-full w-full flex items-center justify-center">
  <div class="bg-slate-900 rounded-2xl shadow-2xl p-8 w-full max-w-md text-center space-y-4">
    <h2 class="text-2xl font-bold">Floorball Shotmap</h2>
    <p id="landing-team" class="text-slate-400 text-sm"></p>
    <button id="start-match-btn" class="w-full btn-primary text-white font-semibold py-3 rounded-lg">
      Aloita uusi ottelu
    </button>
    <button id="view-season-btn" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 rounded-lg">
      Tarkastele kausidataa
    </button>
    <button id="change-team-btn" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-semibold py-3 rounded-lg">
      Vaihda joukkuetta
    </button>
    <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg">
      Kirjaudu ulos
    </button>
  </div>
</div>

<!-- 4) TÄMÄ ON VAIN PAIKKA PITÄÄKSEMME KAIKKI NÄKYMÄT – VARSINAINEN MERKINTÄSOVELLUS ON ALLA
     (EN KOSKE NYT SIIHEN, JOTTA SAADAAN ENSIN KIRJAUTUMINEN JA JOUKKUEET KUNTOON) -->
<div id="app-root" class="hidden">
  <!-- Tähän jää sun aiempi toimiva merkintätyökalu, laukaisukartta, pdf-backup jne.
       Se saa nyt käyttöönsä currentUserUid + currentTeamId, joten se voi hakea kausidata / games / pdf
       samalla tavalla kuin ennen. -->
  <div class="p-4 text-slate-200">Sovellus latautui. (Tähän liitetään sun nykyinen merkintä-UI.)</div>
</div>

<script type="module">
  // 1) Firebase-moduulit – HUOM: VERSIO 11.0.1, joka on oikeasti olemassa.  [oai_citation:1‡Reddit](https://www.reddit.com/r/Firebase/comments/1gnplfo/clientside_firebase_struggles/?utm_source=chatgpt.com)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    doc,
    getDocs,
    setDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // 2) SUN PROJEKTIN KONFIGURAATIO (sama mitä ollaan käytetty)
  const firebaseConfig = {
    apiKey: "AIzaSyDdqRwtwIat2t_qKYE9H3jmbVM1_EIvKy0",
    authDomain: "sbtilastot.firebaseapp.com",
    projectId: "sbtilastot",
    storageBucket: "sbtilastot.appspot.com",
    messagingSenderId: "1056099775207",
    appId: "1:1056099775207:web:6dc886fb56b71f708fe842"
  };

  // 3) ALUSTUS
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // 4) VIITTAUKSET NÄKYMIIN
  const loginView   = document.getElementById("login-view");
  const teamView    = document.getElementById("team-view");
  const landingView = document.getElementById("landing-view");
  const appRoot     = document.getElementById("app-root");

  const loginEmail    = document.getElementById("login-email");
  const loginPassword = document.getElementById("login-password");
  const loginBtn      = document.getElementById("login-btn");
  const loginError    = document.getElementById("login-error");

  const teamButtons   = document.getElementById("team-buttons");
  const newTeamName   = document.getElementById("new-team-name");
  const createTeamBtn = document.getElementById("create-team-btn");
  const teamError     = document.getElementById("team-error");
  const logoutFromTeamBtn = document.getElementById("logout-from-team");

  const startMatchBtn = document.getElementById("start-match-btn");
  const viewSeasonBtn = document.getElementById("view-season-btn");
  const changeTeamBtn = document.getElementById("change-team-btn");
  const logoutBtn     = document.getElementById("logout-btn");
  const landingTeam   = document.getElementById("landing-team");

  // 5) SOVELLUKSEN TILA
  let currentUser   = null;
  let currentTeamId = null; // esim. "Top Team/Varta P16"
  const APP_DOC_PATH = (uid) => ['artifacts','default-app-id','users',uid];

  function show(view) {
    loginView.classList.add("hidden");
    teamView.classList.add("hidden");
    landingView.classList.add("hidden");
    appRoot.classList.add("hidden");
    view.classList.remove("hidden");
  }

  // 6) Kirjautumispainike
  loginBtn.addEventListener("click", async () => {
    loginError.textContent = "";
    const email = loginEmail.value.trim();
    const pass  = loginPassword.value.trim();
    if (!email || !pass) {
      loginError.textContent = "Syötä sähköposti ja salasana.";
      return;
    }
    loginBtn.disabled = true;
    loginBtn.textContent = "Kirjaudutaan...";
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      // onAuthStateChanged hoitaa loput
    } catch (err) {
      console.error("Kirjautumisvirhe", err);
      loginError.textContent = err.code === "auth/invalid-credential"
        ? "Virheellinen tunnus tai salasana."
        : "Kirjautuminen epäonnistui.";
      loginBtn.disabled = false;
      loginBtn.textContent = "Kirjaudu";
    }
  });

  // 7) Auth-kuuntelija – tämä ratkaisee sen ettei “tapahdu mitään”
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      currentUser = null;
      currentTeamId = null;
      show(loginView);
      loginBtn.disabled = false;
      loginBtn.textContent = "Kirjaudu";
      return;
    }
    currentUser = user;
    // kokeillaan lukea viimeksi käytetty joukkue localStoragesta
    const savedTeam = localStorage.getItem("fbshotmap-team");
    if (savedTeam) {
      currentTeamId = savedTeam;
      await ensureTeamExistsOnServer(savedTeam); // jos olet lisännyt sen vain toisella laitteella
      show(landingView);
      landingTeam.textContent = savedTeam;
    } else {
      // näytä joukkueiden valinta
      await loadTeamsToUI();
      show(teamView);
    }
  });

  // 8) Joukkueiden luku Firebasesta
  async function loadTeamsToUI() {
    teamButtons.innerHTML = "";
    teamError.textContent = "";

    if (!currentUser) return;
    try {
      const baseRef = collection(db, ...APP_DOC_PATH(currentUser.uid), 'roster');
      const snap = await getDocs(baseRef);

      // jos yhtään ei ole -> näytetään viesti
      if (snap.empty) {
        const p = document.createElement("p");
        p.textContent = "Ei joukkueita vielä – luo uusi.";
        p.className = "text-slate-400 text-sm";
        teamButtons.appendChild(p);
      } else {
        snap.forEach(docSnap => {
          const teamId = docSnap.id;
          const btn = document.createElement("button");
          btn.textContent = teamId;
          btn.className = "w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg font-semibold";
          btn.addEventListener("click", () => selectTeam(teamId));
          teamButtons.appendChild(btn);
        });
      }
    } catch (err) {
      console.error("Joukkueiden haku epäonnistui", err);
      teamError.textContent = "Joukkueiden haku epäonnistui.";
    }
  }

  async function selectTeam(teamId) {
    currentTeamId = teamId;
    localStorage.setItem("fbshotmap-team", teamId);
    landingTeam.textContent = teamId;
    show(landingView);
  }

  // 9) uuden joukkueen luonti
  createTeamBtn.addEventListener("click", async () => {
    teamError.textContent = "";
    const name = newTeamName.value.trim();
    if (!name) {
      teamError.textContent = "Anna joukkueen nimi.";
      return;
    }
    if (!currentUser) return;
    try {
      const docRef = doc(db, ...APP_DOC_PATH(currentUser.uid), 'roster', name);
      // luodaan edes tyhjä runko
      await setDoc(docRef, {
        createdAt: new Date().toISOString(),
        players: {}    // tähän voit jatkossa tallettaa kokoonpanon
      });
      newTeamName.value = "";
      await loadTeamsToUI();
    } catch (err) {
      console.error("Joukkueen luonti epäonnistui", err);
      teamError.textContent = "Joukkueen luonti epäonnistui.";
    }
  });

  // 10) “Aloita uusi ottelu” – tässä kohtaa näytetään sun varsinainen merkintä-UI
  startMatchBtn.addEventListener("click", () => {
    if (!currentTeamId) {
      // pakota valitsemaan joukkue
      show(teamView);
      return;
    }
    // Tässä näytettäisiin se iso UI joka sulla jo on.
    // Nyt vain näytetään placeholder.
    show(appRoot);
  });

  // 11) “Tarkastele kausidataa”
  viewSeasonBtn.addEventListener("click", () => {
    // Sä voit tässä avata sen sun kausinäkymän – jätän placeholderin
    show(appRoot);
  });

  // 12) “Vaihda joukkuetta”
  changeTeamBtn.addEventListener("click", async () => {
    await loadTeamsToUI();
    show(teamView);
  });

  // 13) Uloskirjautuminen
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });
  logoutFromTeamBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  // apu: jos localStorageen on talletettu joukkue joka ei olekaan enää Firebasessa,
  // luodaan se sinne ettei sovellus tyssää
  async function ensureTeamExistsOnServer(teamId) {
    if (!currentUser) return;
    const teamRef = doc(db, ...APP_DOC_PATH(currentUser.uid), 'roster', teamId);
    const snap = await getDocs(collection(db, ...APP_DOC_PATH(currentUser.uid), 'roster'));
    // jos on jo, ei tehdä mitään
    let exists = false;
    snap.forEach(d => { if (d.id === teamId) exists = true; });
    if (!exists) {
      await setDoc(teamRef, { createdAt: new Date().toISOString(), players: {} });
    }
  }
</script>

</body>
</html>